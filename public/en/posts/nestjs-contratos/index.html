<!DOCTYPE html>
<html lang="en" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script> 

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using contracts with NestJS, facilitating your unit tests</title>
<meta name="description" content="What are contracts? Contracts are a way of separating responsibilities between the parties that use this implementation, contracts are widely used in the context of software development following the DDD (Domain-Driven Design) standard.">
<link rel="canonical" href="http://localhost:1313/en/posts/nestjs-contratos/">
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto">
    <div class="header">
      <header
  class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 sm:py-12"
>
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hucbf2afd9e62dc6021c155b0731b41164_625734_80x80_fill_q90_box_smart1.jpg 80w"
      src="/img/profile-picture.jpg"
      width="1080"
      height="1080"
      alt="Wiliam V. Joaquim"
    />
  </a>
</div>


  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Wiliam V. Joaquim</h1>
</a>
 <nav>
  <ul class="px-4 lg:px-0">
     
    <li>
      <a
        href="/en"
        class=""
      >
        Posts
      </a>
    </li>
    
    <li>
      <a
        href="https://wiliamvj.substack.com/"
        class=""
      >
        Newsletter
      </a>
    </li>
    
    <li>
      <a
        href="/"
        class=""
      >
        pt-BR 🇧🇷
      </a>
    </li>
    
    <li class="-mt-2 block lg:hidden"><button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme !== 'light') {
      setTheme('dark');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
</li>
  </ul>
</nav>

  </div>
</header>

      <div class="lg:inline-block hidden">
        <button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme !== 'light') {
      setTheme('dark');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>

      </div>
    </div>

    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-small">Using contracts with NestJS, facilitating your unit tests</h2>

    <div class="meta">
      
      <time
        datetime="2023-10-11 14:56:59 -0300 -03"
        title='Wed, Oct 11, 2023, 2:56 PM -03'
      >
        11/10/2023 - Estimated reading time: 7 minutes
      </time>

       
    </div>
  </header>

  

  <section><h2 id="what-are-contracts">What are contracts?</h2>
<p>Contracts are a way of separating responsibilities between the parties that use this implementation, contracts are widely used in the context of software development following the DDD (Domain-Driven Design) standard.</p>
<p>Let&rsquo;s say we have a service called <code>UserService</code>, this service needs to make a call to the database and fetch user data. For this we have a repository layer, which is responsible for communicating with the database. In this example, it would look like this:</p>
<p><code>controller</code> &gt; <code>service</code> &gt; <code>repository</code></p>
<p>Imagine that you are going to write a unit test for the service layer, but as it is a unit test, you should not call the repository and call the database, that is why the contract comes into play.</p>
<p>Would be like this:</p>
<p><code>controller</code> &gt; <code>service</code> &gt; <code>contract</code> &gt; <code>repository</code></p>
<p>Let&rsquo;s go to the code:
In the example below we have a simple service, which searches for the user by id, directly calling our repository.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">@Injectable</span>()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> UserService {
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">private</span> repository: <span style="color:#8be9fd">UserRepository</span>) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> findUserById(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">User</span> | <span style="color:#50fa7b">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> findUser <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.repository.findById(id)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">!</span>findUser <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> NotFoundException(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Below is our repository, in the example we use the Prisma ORM, but it could be any other. We search for the user by ID, if we don&rsquo;t find it we return <code>null</code>, if not, we return the user.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">@Injectable</span>()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> UserRepository {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">private</span> prisma: <span style="color:#8be9fd">PrismaService</span>) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> findById(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">User</span> | <span style="color:#50fa7b">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> findUser <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.prisma.findUnique({
</span></span><span style="display:flex;"><span>      where<span style="color:#ff79c6">:</span> { id },
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>findUser) <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> findUser;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now, imagine doing the unit test of our service, you would need to make mocks of your repository, but it depends on the connection with Prisma, so you would need to create a mock of that connection too, this makes the test more time consuming and tiring. But it can be resolved with contracts.</p>
<p>Let&rsquo;s go, below we create a contract using abstract class:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">abstract</span> <span style="color:#ff79c6">class</span> UserContractRepository {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">abstract</span> findById(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">User</span> | <span style="color:#50fa7b">null</span>&gt;;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now, just implement this class, so everyone who uses this contract needs to implement the <code>findById</code> method, let&rsquo;s change the service to use the contract:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">@Injectable</span>()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> UserService {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">private</span> repository: <span style="color:#8be9fd">UserContractRepository</span>) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> findUserById(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">User</span> | <span style="color:#50fa7b">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> findUser <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.repository.findById(id);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>findUser) <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> NotFoundException(<span style="color:#f1fa8c">&#39;user not found&#39;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In the service almost nothing is changed, instead of calling the repository directly, let&rsquo;s call the contract.</p>
<p>Let&rsquo;s change the repository:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">@Injectable</span>()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> UserRepository <span style="color:#ff79c6">implements</span> UserContractRepository {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">private</span> prisma: <span style="color:#8be9fd">PrismaService</span>) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> findById(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">User</span> | <span style="color:#50fa7b">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> findUser <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.prisma.user.findUnique({
</span></span><span style="display:flex;"><span>      where<span style="color:#ff79c6">:</span> { id },
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>findUser) <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> findUser;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In the repository, we now use implements, so the code editor already reports an error, if you don&rsquo;t have the complete implementation of <code>UserContractRepository</code>, in the example, we only have <code>findById</code> which receives a string per parameter and returns a <code>User</code> or <code>null</code>, so we implemented <code>UserContractRepository</code>, if you add more methods to <code>UserContractRepository</code>, you will need to add them to <code>UserRepository</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">abstract</span> <span style="color:#ff79c6">class</span> UserContractRepository {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">abstract</span> findById(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">User</span> | <span style="color:#50fa7b">null</span>&gt;;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">abstract</span> createUser(user: <span style="color:#8be9fd">User</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">void</span>&gt;;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now, we have <code>createUser</code>, <code>UserRepository</code> should already report an error, as it does not fully implement <code>UserContractRepository</code>. Let&rsquo;s implement:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">@Injectable</span>()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> UserRepository <span style="color:#ff79c6">implements</span> UserContractRepository {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">constructor</span>(<span style="color:#ff79c6">private</span> prisma: <span style="color:#8be9fd">PrismaService</span>) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> findById(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">User</span> | <span style="color:#50fa7b">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> findUser <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.prisma.user.findUnique({
</span></span><span style="display:flex;"><span>      where<span style="color:#ff79c6">:</span> { id },
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>findUser) <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> findUser;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> createUser(user: <span style="color:#8be9fd">User</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> findUser <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> <span style="color:#ff79c6">this</span>.prisma.user.create({
</span></span><span style="display:flex;"><span>      data: <span style="color:#8be9fd">user</span>,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To work correctly in NestJs, we just need to change our module, so that when calling <code>UserContractRepository</code> the <code>UserRepository</code> class is used, it&rsquo;s very simple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">@Module</span>({
</span></span><span style="display:flex;"><span>  providers<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      provide: <span style="color:#8be9fd">UserContractRepository</span>,
</span></span><span style="display:flex;"><span>      useClass: <span style="color:#8be9fd">UserRepository</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>Well, what&rsquo;s the advantage of that?</p>
<p>Now as we have a layer between the service and repository, for unit tests we no longer need to call the repository directly, just create a fake implementation that implements the <code>UserContractRepository</code> and use it in the tests, and even, if we need to exchange the prism for another ORM , like TypeORM for example, we don&rsquo;t need to change our service, just create a new repository and implement <code>UserContractRepository</code>.</p>
<p>Let&rsquo;s make a fake repository, normally we call it in memory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> UserRepositoryInMemory <span style="color:#ff79c6">implements</span> UserContractRepository {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> findById(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">User</span> | <span style="color:#50fa7b">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> createUser(user: <span style="color:#8be9fd">User</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="returning-a-mock">Returning a mock</h2>
<p>In the example above, we didn&rsquo;t return anything, but you could return a mock of the User, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> userMock: <span style="color:#8be9fd">User</span> <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>  id<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;id_mock&#34;</span>,
</span></span><span style="display:flex;"><span>  name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;John Doe&#34;</span>,
</span></span><span style="display:flex;"><span>  email<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;john.doe@mail.com&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> UserRepositoryInMemory <span style="color:#ff79c6">implements</span> UserContractRepository {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> findById(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">User</span> | <span style="color:#50fa7b">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> userMock
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> createUser(user: <span style="color:#8be9fd">User</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can further simulate the repository&rsquo;s behavior by checking if the user ID is the same as the <code>userMock</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> userMock: <span style="color:#8be9fd">User</span> <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>  id<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;id_mock&#34;</span>,
</span></span><span style="display:flex;"><span>  name<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;John Doe&#34;</span>,
</span></span><span style="display:flex;"><span>  email<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;john.doe@mail.com&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">export</span> <span style="color:#ff79c6">class</span> UserRepositoryInMemory <span style="color:#ff79c6">implements</span> UserContractRepository {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> findById(id: <span style="color:#8be9fd">string</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">User</span> | <span style="color:#50fa7b">null</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span>(id <span style="color:#ff79c6">!==</span> userMock.id) <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> userMock
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">async</span> createUser(user: <span style="color:#8be9fd">User</span>)<span style="color:#ff79c6">:</span> Promise&lt;<span style="color:#ff79c6">void</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s see how to do unit testing using Jest</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">let</span> sut: <span style="color:#8be9fd">UserService</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">let</span> repository: <span style="color:#8be9fd">UserContractRepository</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>beforeEach(<span style="color:#ff79c6">async</span> () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">const</span> module: <span style="color:#8be9fd">TestingModule</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> Test.createTestingModule({
</span></span><span style="display:flex;"><span>    providers<span style="color:#ff79c6">:</span> [
</span></span><span style="display:flex;"><span>      UserService,
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        provide: <span style="color:#8be9fd">UserContractRepository</span>,
</span></span><span style="display:flex;"><span>        useClass: <span style="color:#8be9fd">UserRepositoryInMemory</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>  }).compile();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  sut <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">module</span>.get <span style="color:#ff79c6">&lt;</span> UserService <span style="color:#ff79c6">&gt;</span> UserService;
</span></span><span style="display:flex;"><span>  repository <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">module</span>.get <span style="color:#ff79c6">&lt;</span> UserContractRepository <span style="color:#ff79c6">&gt;</span> UserContractRepository;
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>We use the same logic used in the module, but now calling the repository in memory, this way we don&rsquo;t need to deal with the prism ORM implementation for example.</p>
<p>The test would look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>describe(<span style="color:#f1fa8c">&#39;findUserById&#39;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>  it(<span style="color:#f1fa8c">&#39;should be able to return user by id&#39;</span>, <span style="color:#ff79c6">async</span> () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> sut.findUserById(<span style="color:#f1fa8c">&#34;id_mock&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    expect(result).toBeTruthy();
</span></span><span style="display:flex;"><span>    expect(result).toHaveProperty(<span style="color:#f1fa8c">&#39;id&#39;</span>);
</span></span><span style="display:flex;"><span>    expect(result).toHaveProperty(<span style="color:#f1fa8c">&#39;name&#39;</span>);
</span></span><span style="display:flex;"><span>    expect(result).toHaveProperty(<span style="color:#f1fa8c">&#39;email&#39;</span>);
</span></span><span style="display:flex;"><span>  });
</span></span></code></pre></div><p>See how simple it is to test with contracts, you can also simulate an error, using jest&rsquo;s <code>spyOn</code>, for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>describe(<span style="color:#f1fa8c">&#39;findUserById&#39;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>  it(<span style="color:#f1fa8c">&#39;should not be able to return user by id&#39;</span>, <span style="color:#ff79c6">async</span> () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>  jest.spyOn(repository, <span style="color:#f1fa8c">&#39;findById&#39;</span>).mockResolvedValueOnce(<span style="color:#ff79c6">null</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    expect(() <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> sut.findUserById(<span style="color:#f1fa8c">&#34;id_mock&#34;</span>);
</span></span><span style="display:flex;"><span>    }).rejects.toThrow(NotFoundException);
</span></span><span style="display:flex;"><span>  });
</span></span></code></pre></div><p>But since we have our in memory, with the treatment to return null if the user ID is different, it would be enough to pass a wrong ID:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>describe(<span style="color:#f1fa8c">&#39;findUserById&#39;</span>, () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>  it(<span style="color:#f1fa8c">&#39;should not be able to return user by id&#39;</span>, <span style="color:#ff79c6">async</span> () <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    expect(() <span style="color:#ff79c6">=&gt;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> sut.findUserById(<span style="color:#f1fa8c">&#34;id_mock_wrong&#34;</span>);
</span></span><span style="display:flex;"><span>    }).rejects.toThrow(NotFoundException);
</span></span><span style="display:flex;"><span>  });
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Using contracts in NestJS can be a very effective approach to facilitate unit testing and improve code maintainability. By separating the repository interface into a contract, you create an intermediate layer between the service and the repository, allowing you to create alternative implementations for testing purposes, such as <code>UserRepositoryInMemory</code>. This has several advantages:</p>
<p><strong>1. Makes unit testing easier:</strong> With the contract in place, you can create dummy repository implementations that behave as needed for each test, without needing to interact with the real database or persistence layer.</p>
<p><strong>2. Test isolation:</strong> Isolating the service to be tested from its external dependencies, such as the ORM or other services, is fundamental to effective unit testing. Contracts help achieve this isolation.</p>
<p><strong>3. Flexibility:</strong> If you decide to switch from one ORM to another, such as from Prisma to TypeORM, the services do not need to change. Just create a new repository that implements the existing contract and make the change in the module.</p>
<p><strong>4. Better adherence to DDD:</strong> The contract approach aligns well with the principles of Domain-Driven Design (DDD), where emphasis is placed on the clarity of interfaces between different layers of the application.</p>
<p><strong>5. Simpler error tests:</strong> You can easily simulate different error scenarios, such as returning “null” or throwing exceptions, to ensure that your service properly handles these situations.</p>
<p>Using contracts in NestJS is a best practice that can make your code more testable, more flexible, and more robust. This helps keep your code clean and makes it easier to evolve and maintain the system over time.</p>
</section>

  
    
  
    <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="wiliamvj/wiliamvj.com"
      data-repo-id="R_kgDOKqMPTA"
      data-category="General"
      data-category-id="DIC_kwDOKqMPTM4CbzWf"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="dark"
      data-lang="en"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    >
    </script>
</div>
  

    
  


  <footer>
    
  </footer>
</article>

</main><footer class="pt-5 pb-6 lg:grid lg:gap-3 lg:grid-cols-2">
  <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2024 —
  <a href="http://localhost:1313/">Wiliam V. Joaquim</a> 
  <span class="font-normal">with</span>
  <a
    href="https://github.com/nixentric/Lowkey-Hugo-Theme"
    target="_blank"
    rel="noopener noreferrer"
  >
    Lowkey
  </a>
</div>
 <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
     
    <li>
      <a href="https://www.linkedin.com/in/wiliamvj/" target="_blank" rel="noopener noreferrer"
        >linkedin</a
      >
    </li>
    
    <li>
      <a href="https://twitter.com/wiliamjoaquim" target="_blank" rel="noopener noreferrer"
        >x</a
      >
    </li>
    
    <li>
      <a href="https://github.com/wiliamvj" target="_blank" rel="noopener noreferrer"
        >github</a
      >
    </li>
    
    <li>
      <a href="https://dev.to/wiliamvj" target="_blank" rel="noopener noreferrer"
        >dev.to</a
      >
    </li>
     
  </ul>
</div>

</footer>
</body>
</html>
