<!DOCTYPE html>
<html lang="en" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>      

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Get control over your SQL with Golang and SQLC</title>


<meta name="description" content="" />
<meta
  name="keywords"
  content="Golang, Go, GCP, Sql, Gorm, NestJS, Javascript, Typescript, AWS, SQS, RabbitMq, Kafka, microservices, brazilian devs, software developer, back-end, NodeJS, Unit tests, integration testes"
/>

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="//localhost:1313/en/posts/golang-sqlc/" />
<meta name="twitter:title" content="Get control over your SQL with Golang and SQLC" />
<meta name="twitter:description" content="" />
<meta name="twitter:image" content="//localhost:1313/posts/golang-sqlc/dfgU78Lpfdg34.png" />
<meta
  name="twitter:image:src"
  content="//localhost:1313/posts/golang-sqlc/dfgU78Lpfdg34.png"
/>
<meta name="twitter:domain" content="wiliamvj.com" />
<meta name="twitter:creator" content="@wiliamjoaquim" />
<meta name="twitter:image:alt" content="Get control over your SQL with Golang and SQLC" />
<meta name="twitter:label1" content="Reading time"> <meta
name="twitter:data1" content="12 minutes read">
<meta name="twitter:app:name:iphone" content="wiliamvj" />

<meta property="og:type" content="article" />
<meta property="og:title" content="Get control over your SQL with Golang and SQLC" />
<meta property="og:site_name" content="Wiliam V. Joaquim - Software Developer'" />
<meta property="og:description" content="" />
<meta property="og:url" content="//localhost:1313/en/posts/golang-sqlc/" />
<meta property="og:image" content="//localhost:1313/posts/golang-sqlc/dfgU78Lpfdg34.png" />
<meta property="og:image:alt" content="Get control over your SQL with Golang and SQLC" />


<meta
  name="apple-mobile-web-app-title"
  content="Get control over your SQL with Golang and SQLC"
/>
<meta
  name="description"
  content="Introduction Dealing with SQL often becomes complicated and tiring, dealing with so many queries, indexing, performance, security, transactions and everything that involves the use of SQL, with this in mind, the use of ORM is increasingly being adopted, aiming to make our lives easier."
/>
<link
  rel="apple-touch-icon"
  sizes="180x180"
  href="/icons/apple-touch.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="32x32"
  href="/icons/favicon-32x32.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="16x16"
  href="/icons/favicon-16x16.png"
/>
<link rel="canonical" href="//localhost:1313/en/posts/golang-sqlc/" />
<link rel="robots" href="/robots.txt" />
<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />


<script
  defer
  src="https://www.googletagmanager.com/gtag/js?id=G-TG8KZ9PQBT"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-TG8KZ9PQBT');
</script>


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="//localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto">
    <div class="header">
      <header
  class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 sm:py-12"
>
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="//localhost:1313/">
    <img
      srcset="/img/profile-picture_hu13304639856342208507.jpg 80w"
      src="/img/profile-picture.jpg"
      width="460"
      height="460"
      alt="Wiliam V. Joaquim"
    />
  </a>
</div>


  <div class="flex flex-col gap-5">
    <a href="//localhost:1313/">
  <h1 id="site-title">Wiliam V<span class="text-wpurple">.</span> Joaquim</h1>
</a>
 <nav>
  <ul class="px-4 lg:px-0">
     
    <li>
      <a
        href="/en"
        class=""
        
      >
        Posts
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li>
      <a
        href="https://wiliamvj.substack.com/"
        class=""
         target="_blank" 
      >
        Newsletter
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li>
      <a
        href="/"
        class=""
        
      >
        pt-BR
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li class="-mt-2 block lg:hidden"><button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');
    setTheme(theme);
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      html.classList.remove('dark');
      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      html.classList.add('dark');
      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');
    const newTheme = theme === 'light' ? 'dark' : 'light';
    localStorage.setItem('theme', newTheme);
    setTheme(newTheme);
    reloadGiscus(newTheme);
  }
</script>


<script>
  function reloadGiscus(theme) {
    const existingGiscusScript = document.getElementById('giscus-script');
    if (existingGiscusScript) existingGiscusScript.remove();

    let giscusScript = document.createElement('script');
    const giscusTheme = theme === 'light' ? 'noborder_light' : 'noborder_dark';

    let giscusAttributes = {
      id: 'giscus-script',
      src: 'https://giscus.app/client.js',
      'data-repo': 'wiliamvj\/wiliamvj.com',
      'data-repo-id': 'R_kgDOLkkfgA',
      'data-category': 'General',
      'data-category-id': 'DIC_kwDOLkkfgM4CeL5M',
      'data-mapping': 'title',
      'data-strict': '0',
      'data-reactions-enabled':
        '1',
      'data-emit-metadata':
        '0',
      'data-input-position':
        'top',
      'data-theme': giscusTheme,
      'data-lang': 'pt',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: '',
    };

    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.body.appendChild(giscusScript);
  }
</script>

</li>
  </ul>
</nav>

  </div>
</header>

      <div class="lg:inline-block hidden">
        <button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');
    setTheme(theme);
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      html.classList.remove('dark');
      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      html.classList.add('dark');
      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');
    const newTheme = theme === 'light' ? 'dark' : 'light';
    localStorage.setItem('theme', newTheme);
    setTheme(newTheme);
    reloadGiscus(newTheme);
  }
</script>


<script>
  function reloadGiscus(theme) {
    const existingGiscusScript = document.getElementById('giscus-script');
    if (existingGiscusScript) existingGiscusScript.remove();

    let giscusScript = document.createElement('script');
    const giscusTheme = theme === 'light' ? 'noborder_light' : 'noborder_dark';

    let giscusAttributes = {
      id: 'giscus-script',
      src: 'https://giscus.app/client.js',
      'data-repo': 'wiliamvj\/wiliamvj.com',
      'data-repo-id': 'R_kgDOLkkfgA',
      'data-category': 'General',
      'data-category-id': 'DIC_kwDOLkkfgM4CeL5M',
      'data-mapping': 'title',
      'data-strict': '0',
      'data-reactions-enabled':
        '1',
      'data-emit-metadata':
        '0',
      'data-input-position':
        'top',
      'data-theme': giscusTheme,
      'data-lang': 'pt',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: '',
    };

    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.body.appendChild(giscusScript);
  }
</script>


      </div>
    </div>

    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-small">Get control over your SQL with Golang and SQLC</h2>

    <div class="meta">
      
      <time
        datetime="2023-11-25 17:11:00 -0300 -03"
        title='Sat, Nov 25, 2023, 5:11 PM -03'
      >
        Published in: 25/11/2023 - 12 minutes read
      </time>

       
    </div>
  </header>

  


  <section><p><img alt="thumbnail" src="/posts/golang-sqlc/dfgU78Lpfdg34.png"></p>
<h2 id="introduction">Introduction</h2>
<p>Dealing with SQL often becomes complicated and tiring, dealing with so many queries, indexing, performance, security, transactions and everything that involves the use of SQL, with this in mind, the use of ORM is increasingly being adopted, aiming to make our lives easier.</p>
<p>The use of ORM is generally recommended due to its practicality of use, agility, delivery of safer and faster queries (not always), however not everything is perfect, the use of ORM ends up limiting us when it is necessary to make a more complex query, The vast majority of ORMs do not offer good performance with complex queries or even do not have support, thus requiring the use of SQL in the ORM itself.</p>
<p>In Go, the community encourages the use of ORM, although <a href="https://gorm.io/">GORM</a> is an excellent ORM, its use may make sense in small applications that do not occur in a more complex query.</p>
<h2 id="using-it-in-go-then">Using it in Go then?</h2>
<p>We can use <a href="https://gorm.io/">GORM</a>, as I mentioned, we can make our queries and just use the database driver, like <a href="github.com/lib/pq">pq</a> for PostgreSQL (it&rsquo;s the most laborious option, but with full control), but as the purpose of the post is to talk about SQLC, let&rsquo;s use it.</p>
<h2 id="what-is-sqlc">What is SQLC?</h2>
<p><a href="https://sqlc.dev/">SQLC</a> is a package to facilitate the execution and manipulation of our database queries, it automatically generates the code according to the SQL query we write.</p>
<p>SQLC does the most boring part for us, which is receiving data from the database and passing it to our struct, for example, and already generates the interfaces for us.</p>
<p>It may seem strange, will it generate Go code? It can&rsquo;t be good, I thought the same way, until I used it.</p>
<h2 id="installing-sqlc">Installing SQLC</h2>
<p>We need to install SQLC on our machine, but like any GO package, it&rsquo;s very simple, see how in the <a href="https://docs.sqlc.dev/en/stable/overview/install.html">docs</a>, remembering that for while SQLC only supports PostgreSQL, MySQL and SQLite.</p>
<h2 id="creating-the-project">Creating the project</h2>
<p>Let&rsquo;s go to the code, for this we will create a simple project:</p>
<p><img alt="Project structure" src="/posts/golang-sqlc/fgh67hjksfdR65hUioPo.png"></p>
<p>Let&rsquo;s just have our <code>main.go</code>, which will initiate the connection with the PostgreSQL database and make our application run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#ff79c6">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;database/sql&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;github.com/joho/godotenv&#34;</span>
</span></span><span style="display:flex;"><span>    _ <span style="color:#f1fa8c">&#34;github.com/lib/pq&#34;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// load .env file
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    godotenv.<span style="color:#50fa7b">Load</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    postgresURI <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Getenv</span>(<span style="color:#f1fa8c">&#34;DATABASE_URL&#34;</span>)
</span></span><span style="display:flex;"><span>    db, err <span style="color:#ff79c6">:=</span> sql.<span style="color:#50fa7b">Open</span>(<span style="color:#f1fa8c">&#34;postgres&#34;</span>, postgresURI)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      log.<span style="color:#50fa7b">Panic</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    err = db.<span style="color:#50fa7b">Ping</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      db.<span style="color:#50fa7b">Close</span>()
</span></span><span style="display:flex;"><span>      log.<span style="color:#50fa7b">Panic</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Connected to database&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// keep the program running
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">select</span> {}
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>In the <strong>internal/database</strong> folder, the <code>queries.sql</code> file will be where we will leave our queries.
In the <strong>internal/database/migrations</strong> folder, we will leave the migration that will create our tables, I already made a post on how to use golang-migrate, see <a href="https://wiliamvj.com/posts/migrations-golang/">here</a>.</p>
<p>To run the migrations, make sure your PostgreSQL database is running on port <code>5432</code> (I will leave a <code>docker-compose</code> file in the repository), then run the migration with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  make migrate_up
</span></span></code></pre></div><p>To undo the migration run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  make migrate_down
</span></span></code></pre></div><h2 id="running-sqlc">Running SQLC</h2>
<p>Finally, let&rsquo;s generate our query and run SQLC, but first just check if you are actually installing SQLC on your machine with the command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  sqlc version
</span></span></code></pre></div><p>If you receive a version <code>v1.20.0</code> for example, everything is fine (it doesn&rsquo;t have to be the same version as the example).</p>
<p>We first need to create an SLQC config file, called <code>sqlc.yaml</code> in the root of the project, in it we will define the database we will use, folder paths and other configs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">version</span>: <span style="color:#f1fa8c">&#39;2&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">sql</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">schema</span>: <span style="color:#f1fa8c">&#39;internal/database/migrations&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">queries</span>: <span style="color:#f1fa8c">&#39;internal/database/queries&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">engine</span>: <span style="color:#f1fa8c">&#39;postgresql&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">gen</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">go</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">package</span>: <span style="color:#f1fa8c">&#39;db&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">out</span>: <span style="color:#f1fa8c">&#39;internal/database/db&#39;</span>
</span></span></code></pre></div><ul>
<li><code>schema</code>: where our table structure file is located in the database.</li>
<li><code>queries</code>: Folder with the queries we are going to create.</li>
<li><code>out</code>: This is where SQLC will generate your code.</li>
</ul>
<p>Let&rsquo;s create a query called <code>user.sql</code> that adds a user to the database, see how it looks using SQLC:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>  <span style="color:#6272a4">-- name: CreateOneUser :exec
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> users (id, name, email, password, created_at, updated_at)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">VALUES</span> ($<span style="color:#bd93f9">1</span>, $<span style="color:#bd93f9">2</span>, $<span style="color:#bd93f9">3</span>, $<span style="color:#bd93f9">4</span>, $<span style="color:#bd93f9">5</span>, $<span style="color:#bd93f9">6</span>);
</span></span></code></pre></div><p>O SQLC utiliza anotações para as queries, veja:</p>
<ul>
<li><code>--name</code>: Indicates the name of the query, it will be used as the name of the interface.</li>
<li><code>exec</code>: Indicates that we want to execute the query, there are several, see <a href="https://docs.sqlc.dev/en/stable/reference/query-annotations.html">here</a> in the docs.</li>
</ul>
<p>Let&rsquo;s create the files with the SQLC command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  sqlc generate
</span></span></code></pre></div><p>You will notice that a simple call <strong>db</strong> will be generated within the <strong>database</strong> folder, this folder is for the exclusive use of SQLC and should not be changed.</p>
<p>SQLC created 3 files, let&rsquo;s see them:</p>
<p><code>db.go</code>: This is where SQLC handles the database connection, transactions and queries.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> DBTX <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">ExecContext</span>(context.Context, <span style="color:#8be9fd">string</span>, <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) (sql.Result, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">PrepareContext</span>(context.Context, <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>sql.Stmt, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">QueryContext</span>(context.Context, <span style="color:#8be9fd">string</span>, <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) (<span style="color:#ff79c6">*</span>sql.Rows, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">QueryRowContext</span>(context.Context, <span style="color:#8be9fd">string</span>, <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#ff79c6">*</span>sql.Row
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">New</span>(db DBTX) <span style="color:#ff79c6">*</span>Queries {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>Queries{db: db}
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> Queries <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    db DBTX
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (q <span style="color:#ff79c6">*</span>Queries) <span style="color:#50fa7b">WithTx</span>(tx <span style="color:#ff79c6">*</span>sql.Tx) <span style="color:#ff79c6">*</span>Queries {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>Queries{
</span></span><span style="display:flex;"><span>      db: tx,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><code>models.go</code>: This is where SQLC creates our models, according to the structure of our database.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> Post <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    ID        <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    AuthorID  <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    Title     <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    Body      <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    CreatedAt time.Time
</span></span><span style="display:flex;"><span>    UpdatedAt time.Time
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> User <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    ID        <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    Name      <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    Email     <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    Password  <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    CreatedAt time.Time
</span></span><span style="display:flex;"><span>    UpdatedAt time.Time
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><code>user.sql.go</code>: This is where SQLC creates the functions that we are going to execute and our structs to send the parameters:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">const</span> createOneUser = <span style="color:#f1fa8c">`-- name: CreateOneUser :exec
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  INSERT INTO users (id, name, email, password, created_at, updated_at)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  VALUES ($1, $2, $3, $4, $5, $6)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">  `</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> CreateOneUserParams <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    ID        <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    Name      <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    Email     <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    Password  <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>    CreatedAt time.Time
</span></span><span style="display:flex;"><span>    UpdatedAt time.Time
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (q <span style="color:#ff79c6">*</span>Queries) <span style="color:#50fa7b">CreateOneUser</span>(ctx context.Context, arg CreateOneUserParams) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    _, err <span style="color:#ff79c6">:=</span> q.db.<span style="color:#50fa7b">ExecContext</span>(ctx, createOneUser,
</span></span><span style="display:flex;"><span>      arg.ID,
</span></span><span style="display:flex;"><span>      arg.Name,
</span></span><span style="display:flex;"><span>      arg.Email,
</span></span><span style="display:flex;"><span>      arg.Password,
</span></span><span style="display:flex;"><span>      arg.CreatedAt,
</span></span><span style="display:flex;"><span>      arg.UpdatedAt,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>SQLC also leaves the query that will be executed, in our case in <code>createOneUser</code>.</p>
<h2 id="creating-a-record-with-sqlc">Creating a record with SQLC</h2>
<p>Let&rsquo;s save a user using SQLC, in our case we will save the user when starting our application, but in real use, it would be created when receiving a <code>POST</code> request from a controller for example.</p>
<p>Let&rsquo;s create inside the <strong>internal</strong> folder, a folder called <strong>handler</strong> and the file called <code>user.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#ff79c6">package</span> handler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;github.com/google/uuid&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;github.com/wiliamvj/golang-sqlc/internal/database/db&#34;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserHandler <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    Queries <span style="color:#ff79c6">*</span>db.Queries
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CreateUser</span>(ctx context.Context, h <span style="color:#ff79c6">*</span>UserHandler) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> h.Queries.<span style="color:#50fa7b">CreateOneUser</span>(ctx, db.CreateOneUserParams{
</span></span><span style="display:flex;"><span>      ID:        uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>(),
</span></span><span style="display:flex;"><span>      Name:      <span style="color:#f1fa8c">&#34;John Doe&#34;</span>,
</span></span><span style="display:flex;"><span>      Email:     <span style="color:#f1fa8c">&#34;john.doe@email.com&#34;</span>,
</span></span><span style="display:flex;"><span>      Password:  <span style="color:#f1fa8c">&#34;123456&#34;</span>,
</span></span><span style="display:flex;"><span>      CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>      UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Error creating user&#34;</span>, err)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;User created&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>We create a struct, which will receive a pointer to the queries created by SQLC, then we use the <code>CreateOneUser</code> function created by SQLC and pass the expected parameters, this is enough to save it in the database, let&rsquo;s now call <code>CreateUser</code> in <code>main .go</code>, simulating a request.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>   <span style="color:#6272a4">// start slqc queries
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  slqcQueries <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">New</span>(dbConnection)
</span></span><span style="display:flex;"><span>  q <span style="color:#ff79c6">:=</span> handler.UserHandler{
</span></span><span style="display:flex;"><span>    Queries: slqcQueries,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  handler.<span style="color:#50fa7b">CreateUser</span>(context.<span style="color:#50fa7b">Background</span>(), <span style="color:#ff79c6">&amp;</span>q)
</span></span></code></pre></div><p>We start in SQLC by passing the connection to the database to <code>db.New</code>, then we start the <code>UserHandler</code> struct and finally we call the <code>CreateUser</code> function.</p>
<p><code>main.go</code> complete:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// load .env file
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    godotenv.<span style="color:#50fa7b">Load</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    postgresURI <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Getenv</span>(<span style="color:#f1fa8c">&#34;DATABASE_URL&#34;</span>)
</span></span><span style="display:flex;"><span>    dbConnection, err <span style="color:#ff79c6">:=</span> sql.<span style="color:#50fa7b">Open</span>(<span style="color:#f1fa8c">&#34;postgres&#34;</span>, postgresURI)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      log.<span style="color:#50fa7b">Panic</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    err = dbConnection.<span style="color:#50fa7b">Ping</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      dbConnection.<span style="color:#50fa7b">Close</span>()
</span></span><span style="display:flex;"><span>      log.<span style="color:#50fa7b">Panic</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Connected to database&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// start slqc queries
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    slqcQueries <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">New</span>(dbConnection)
</span></span><span style="display:flex;"><span>    q <span style="color:#ff79c6">:=</span> handler.UserHandler{
</span></span><span style="display:flex;"><span>      Queries: slqcQueries,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    handler.<span style="color:#50fa7b">CreateUser</span>(context.<span style="color:#50fa7b">Background</span>(), <span style="color:#ff79c6">&amp;</span>q)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// keep the program running
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">select</span> {}
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Now if you start the application, we will receive the <code>User created</code> log:`:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  Connected to database
</span></span><span style="display:flex;"><span>  User created
</span></span></code></pre></div><p>If we try to run again, we will receive an error, this is because our email is unique in the database, and already exists, the correct thing is before saving in the database, check if there is already a record with the same email, but we won&rsquo;t do this for now.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  Connected to database
</span></span><span style="display:flex;"><span>  Error creating user pq: duplicate key value violates unique constraint <span style="color:#f1fa8c">&#34;users_email_key&#34;</span>
</span></span></code></pre></div><p>Now, let&rsquo;s save our post, let&rsquo;s create the user and then create the post, let&rsquo;s do this to exemplify a problem we will face:</p>
<p>Creating query <code>post.sql</code> in the <strong>queries</strong> folder to save the post:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>  <span style="color:#6272a4">-- name: CreateOnePost :exec
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> posts (id, title, body, author_id, created_at, updated_at)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">VALUES</span> ($<span style="color:#bd93f9">1</span>, $<span style="color:#bd93f9">2</span>, $<span style="color:#bd93f9">3</span>, $<span style="color:#bd93f9">4</span>, $<span style="color:#bd93f9">5</span>, $<span style="color:#bd93f9">6</span>);
</span></span></code></pre></div><p>Let&rsquo;s run the sqlc command again to update the files:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  sqlc generate
</span></span></code></pre></div><p>With the files updated, let&rsquo;s create the post within <code>user.go</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserHandler <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    Queries <span style="color:#ff79c6">*</span>db.Queries
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CreateUser</span>(ctx context.Context, h <span style="color:#ff79c6">*</span>UserHandler) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    userID <span style="color:#ff79c6">:=</span> uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> h.Queries.<span style="color:#50fa7b">CreateOneUser</span>(ctx, db.CreateOneUserParams{
</span></span><span style="display:flex;"><span>      ID:        userID,
</span></span><span style="display:flex;"><span>      Name:      <span style="color:#f1fa8c">&#34;John Doe&#34;</span>,
</span></span><span style="display:flex;"><span>      Email:     <span style="color:#f1fa8c">&#34;john.doe@email.com&#34;</span>,
</span></span><span style="display:flex;"><span>      Password:  <span style="color:#f1fa8c">&#34;123456&#34;</span>,
</span></span><span style="display:flex;"><span>      CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>      UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Error creating user&#34;</span>, err)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;User created&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// create post
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    err = h.Queries.<span style="color:#50fa7b">CreateOnePost</span>(ctx, db.CreateOnePostParams{
</span></span><span style="display:flex;"><span>      ID:        uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>(),
</span></span><span style="display:flex;"><span>      Title:     <span style="color:#f1fa8c">&#34;SLQC with Golang&#34;</span>,
</span></span><span style="display:flex;"><span>      Body:      <span style="color:#f1fa8c">&#34;This is a post about SLQC with Golang&#34;</span>,
</span></span><span style="display:flex;"><span>      AuthorID:  userID,
</span></span><span style="display:flex;"><span>      CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>      UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Error creating post&#34;</span>, err)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Post created&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>We did the same process when saving the user, but notice that I separated the user id into a variable called <code>userID</code>, as we need the id to save the post, since we have a one-to-many relationship, where a user can having many posts and a post has only one user, is just an example.</p>
<p>When running the project again, we will be successful in saving the user and the post, but first remember to delete all records, as we do not validate if there are already user records with the same email, it will give an error.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  Connected to database
</span></span><span style="display:flex;"><span>  User created
</span></span><span style="display:flex;"><span>  Post created
</span></span></code></pre></div><p>Our user and post were created successfully, but when we create &ldquo;cascade&rdquo; records, if one of them fails for some reason the others can still be created, let&rsquo;s see how to solve this with transactions.</p>
<h2 id="transactions">Transactions</h2>
<p>Transactions are a set of operations that are treated as a single operation, in our example when creating a user we then create a post, the two operations depend on each other, so we use transactions.</p>
<p>A transaction can only succeed or fail, if it succeeds, we save all the records, in our example a user and a post will be created, but if it fails, no records will be created, if the post creation fails, a <code>will be done. rollback</code> in previous operations, i.e. the user will not be saved. This ensures that all operations performed are written successfully, but if it fails, no operations are saved.</p>
<p>SQLC allows us to work with this, let&rsquo;s take an example, imagine that whenever you create a user it is mandatory to create a post, but what if the post creation fails? Let&rsquo;s change <code>user.go</code>, forcing an error, we will always try to save a post with the same <code>id</code>, on the second attempt it will speak, as we will have a record with the same <code>id</code> in the database.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CreateUser</span>(ctx context.Context, h <span style="color:#ff79c6">*</span>UserHandler) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    userID <span style="color:#ff79c6">:=</span> uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>()
</span></span><span style="display:flex;"><span>    userEmail <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;john.doe-%v@email.com&#34;</span>, time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">Unix</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> h.Queries.<span style="color:#50fa7b">CreateOneUser</span>(ctx, db.CreateOneUserParams{
</span></span><span style="display:flex;"><span>      ID:        userID,
</span></span><span style="display:flex;"><span>      Name:      <span style="color:#f1fa8c">&#34;John Doe&#34;</span>,
</span></span><span style="display:flex;"><span>      Email:     userEmail,
</span></span><span style="display:flex;"><span>      Password:  <span style="color:#f1fa8c">&#34;123456&#34;</span>,
</span></span><span style="display:flex;"><span>      CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>      UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Error creating user&#34;</span>, err)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;User created&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// create post
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    err = h.Queries.<span style="color:#50fa7b">CreateOnePost</span>(ctx, db.CreateOnePostParams{
</span></span><span style="display:flex;"><span>      ID:        <span style="color:#f1fa8c">&#34;093eb8c7-d09d-464d-aa55-99ee7c1b7488&#34;</span>,
</span></span><span style="display:flex;"><span>      Title:     <span style="color:#f1fa8c">&#34;SLQC with Golang&#34;</span>,
</span></span><span style="display:flex;"><span>      Body:      <span style="color:#f1fa8c">&#34;This is a post about SLQC with Golang&#34;</span>,
</span></span><span style="display:flex;"><span>      AuthorID:  userID,
</span></span><span style="display:flex;"><span>      CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>      UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Error creating post&#34;</span>, err)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Post created&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>We left the <code>id</code> of the post always the same, I also added <code>userEmail</code> to generate a unique email whenever we start our application, we received the error on the second attempt:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  Connected to database
</span></span><span style="display:flex;"><span>  User created
</span></span><span style="display:flex;"><span>  Error creating post pq: duplicate key value violates unique constraint <span style="color:#f1fa8c">&#34;posts_pkey&#34;</span>
</span></span></code></pre></div><p>But if you notice in the <code>users</code> table the user is always created, let&rsquo;s use transactions.</p>
<h2 id="using-transactions-with-sqlc">Using transactions with SQLC</h2>
<p>To use transactions, we will inject a function into SQLX that executes our queries, looking like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">runWithTX</span>(ctx context.Context, c <span style="color:#ff79c6">*</span>sql.DB, fn <span style="color:#8be9fd;font-style:italic">func</span>(<span style="color:#ff79c6">*</span>db.Queries) <span style="color:#8be9fd">error</span>) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    tx, err <span style="color:#ff79c6">:=</span> c.<span style="color:#50fa7b">BeginTx</span>(ctx, <span style="color:#ff79c6">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    q <span style="color:#ff79c6">:=</span> db.<span style="color:#50fa7b">New</span>(tx)
</span></span><span style="display:flex;"><span>    err = <span style="color:#50fa7b">fn</span>(q)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> errRb <span style="color:#ff79c6">:=</span> tx.<span style="color:#50fa7b">Rollback</span>(); errRb <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> fmt.<span style="color:#50fa7b">Errorf</span>(<span style="color:#f1fa8c">&#34;error on rollback: %v, original error: %w&#34;</span>, errRb, err)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> tx.<span style="color:#50fa7b">Commit</span>()
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>This function will be the one we will use to execute queries with transactions, we pass the connection to the database, we start the connection with transaction with <code>BeginTx</code>, passing the context and <code>nil</code>, <code>nil</code> refers to <em>isolation level</em> (not we will address it at the moment, but see <a href="https://www.postgresql.org/docs/current/transaction-iso.html">here</a> what it is about, we start <code>db.New(tx)</code>, as we have already seen , but now using transactions, then we execute our query, if there is an error we do <code>tx.Rollback()</code>, if there is no error <code>tx.Commit()</code> ending everything.</p>
<p>For this to work, we need to update the <code>CreateUser</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CreateUser</span>(ctx context.Context, h <span style="color:#ff79c6">*</span>UserHandler) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    userID <span style="color:#ff79c6">:=</span> uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>()
</span></span><span style="display:flex;"><span>    userEmail <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;john.doe-%v@email.com&#34;</span>, time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">Unix</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">runWithTX</span>(ctx, h.Db, <span style="color:#8be9fd;font-style:italic">func</span>(q <span style="color:#ff79c6">*</span>db.Queries) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">var</span> err <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>      err = q.<span style="color:#50fa7b">CreateOneUser</span>(ctx, db.CreateOneUserParams{
</span></span><span style="display:flex;"><span>        ID:        userID,
</span></span><span style="display:flex;"><span>        Name:      <span style="color:#f1fa8c">&#34;John Doe&#34;</span>,
</span></span><span style="display:flex;"><span>        Email:     userEmail,
</span></span><span style="display:flex;"><span>        Password:  <span style="color:#f1fa8c">&#34;123456&#34;</span>,
</span></span><span style="display:flex;"><span>        CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>        UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>        fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Error creating user&#34;</span>, err)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;User created&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// create post
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      err = q.<span style="color:#50fa7b">CreateOnePost</span>(ctx, db.CreateOnePostParams{
</span></span><span style="display:flex;"><span>        ID:        <span style="color:#f1fa8c">&#34;193eb8c7-d09d-464d-aa55-99ee7c1b7488&#34;</span>,
</span></span><span style="display:flex;"><span>        Title:     <span style="color:#f1fa8c">&#34;SLQC with Golang&#34;</span>,
</span></span><span style="display:flex;"><span>        Body:      <span style="color:#f1fa8c">&#34;This is a post about SLQC with Golang&#34;</span>,
</span></span><span style="display:flex;"><span>        AuthorID:  userID,
</span></span><span style="display:flex;"><span>        CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>        UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>        fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Error creating post&#34;</span>, err)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Post created&#34;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Error creating user and post, roll back applied&#34;</span>, err)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Now we use <code>runWithTX</code>, and when using sqlc queries, we no longer use <code>h.Queries</code>, we use <code>q</code>, which comes from the function we injected, thus executing using transactions, now if you run the application, see the mistake:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  Connected to database
</span></span><span style="display:flex;"><span>  User created
</span></span><span style="display:flex;"><span>  Error creating post pq: duplicate key value violates unique constraint <span style="color:#f1fa8c">&#34;posts_pkey&#34;</span>
</span></span><span style="display:flex;"><span>  Error creating user and post, roll back applied pq: duplicate key value violates unique constraint <span style="color:#f1fa8c">&#34;posts_pkey&#34;</span>
</span></span></code></pre></div><p>In the log <code>creating user and post, roll back applied</code>, you can see that the transactions ran, if you look in the database, no user is now saved due to the error in creating the post, if you remove the <code>id</code> of the post which is fixed, and put the
<code>uuid.New().String()</code>, and run the application, everything will work normally.</p>
<p>We only covered a simple example about transactions, it is a more complex subject, I will leave the sqlc <a href="https://docs.sqlc.dev/en/stable/howto/transactions.html">documentation</a> about transactions.</p>
<h2 id="final-considerations">Final considerations</h2>
<p>As you can see, using sqlc gives us full control over our SQL, sqlc is also quite simple to use. If you don&rsquo;t want to use ORM, using sqlc can be an option, it removes the most manual work of transforming data known as &ldquo;data hydration&rdquo;.</p>
<p>SQL has several &ldquo;tricks&rdquo; that can facilitate data manipulation such as <a href="https://docs.sqlc.dev/en/stable/howto/overrides.html">Overriding types</a>, [Naming parameters](https:// docs.sqlc.dev/en/stable/howto/named_parameters.html) and many others, it&rsquo;s worth looking at the docs.</p>
<h2 id="repository-link">Repository link</h2>
<p>project <a href="https://github.com/wiliamvj/golang-sqlc">repository</a></p>
<p><a href="https://github.com/egonelbre/gophers">Gopher credits</a></p>
</section>

  

 <div class="giscus-comment">
  <script>
    let theme = localStorage.getItem('theme');
    const giscusTheme = theme === 'light' ? 'noborder_light' : 'noborder_dark';
    var currentUrl = window.location.href;
    const lang = currentUrl.indexOf('/en/') !== -1 ? 'en' : 'pt';
    let giscusAttributes = {
      id: 'giscus-script',
      src: 'https://giscus.app/client.js',
      'data-repo': 'wiliamvj\/wiliamvj.com',
      'data-repo-id': 'R_kgDOLkkfgA',
      'data-category': 'General',
      'data-category-id': 'DIC_kwDOLkkfgM4CeL5M',
      'data-mapping': 'title',
      'data-strict': '0',
      'data-reactions-enabled':
        '1',
      'data-emit-metadata':
        '0',
      'data-input-position':
        'top',
      'data-theme': theme,
      'data-lang': lang,
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: '',
    };

    let giscusScript = document.createElement('script');
    const article = document.querySelector('article');
    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    article.appendChild(giscusScript);
  </script>
</div>
 


 


  <footer>
    
  </footer>
</article>

</main><footer class="pt-5 pb-6 lg:grid lg:gap-3 lg:grid-cols-2">
  <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2024 —
  <a href="//localhost:1313/">Wiliam V. Joaquim</a>
  <span class="font-normal">with</span>
  <a
    href="https://github.com/nixentric/Lowkey-Hugo-Theme"
    target="_blank"
    rel="noopener noreferrer"
  >
    Lowkey
  </a>
</div>
 <div class="order-1 sm:order-2 f-social">
  <ul class="flex sm:justify-end gap-5">
     
    <li>
      <a href="https://www.linkedin.com/in/wiliamvj/" target="_blank" rel="noopener noreferrer"
        >linkedin</a
      >
    </li>
    
    <li>
      <a href="https://bsky.app/profile/wiliamvj.com" target="_blank" rel="noopener noreferrer"
        >bsky</a
      >
    </li>
    
    <li>
      <a href="https://twitter.com/wiliamjoaquim" target="_blank" rel="noopener noreferrer"
        >x</a
      >
    </li>
    
    <li>
      <a href="https://github.com/wiliamvj" target="_blank" rel="noopener noreferrer"
        >github</a
      >
    </li>
    
    <li>
      <a href="https://dev.to/wiliamvj" target="_blank" rel="noopener noreferrer"
        >dev.to</a
      >
    </li>
     
  </ul>
</div>

</footer>

<button
  type="button"
  data-twe-ripple-init
  data-twe-ripple-color="light"
  class="!fixed bottom-5 end-5 hidden rounded-md bg-wpurple p-3 text-xs font-medium uppercase leading-tight text-white shadow-md transition duration-150 ease-in-out hover:bg-wpurplehover hover:shadow-lg focus:bg-wpurplehover focus:shadow-lg focus:outline-none focus:ring-0 active:bg-wpurple active:shadow-lg"
  id="btn-back-to-top"
>
  <span class="[&>svg]:w-4">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="3"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18"
      />
    </svg>
  </span>
</button>

<script defer>
  const mybutton = document.getElementById('btn-back-to-top');
  const scrollFunction = () => {
    if (
      document.body.scrollTop > 20 ||
      document.documentElement.scrollTop > 20
    ) {
      mybutton.classList.remove('hidden');
    } else {
      mybutton.classList.add('hidden');
    }
  };
  const backToTop = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  mybutton.addEventListener('click', backToTop);
  window.addEventListener('scroll', scrollFunction);
</script>
</body>
</html>
