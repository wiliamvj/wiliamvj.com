<!DOCTYPE html>
<html lang="en" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>      

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Preventing SQL Injection with Golang</title>


<meta name="description" content="" />
<meta
  name="keywords"
  content="Golang, Go, GCP, Sql, Gorm, NestJS, Javascript, Typescript, AWS, SQS, RabbitMq, Kafka, microservices, brazilian devs, software developer, back-end, NodeJS, Unit tests, integration testes"
/>

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="//localhost:1313/en/posts/sql-injection-golang/" />
<meta name="twitter:title" content="Preventing SQL Injection with Golang" />
<meta name="twitter:description" content="" />
<meta name="twitter:image" content="//localhost:1313/posts/sql-injection-golang/thumb_en_fgfgdfg.png" />
<meta
  name="twitter:image:src"
  content="//localhost:1313/posts/sql-injection-golang/thumb_en_fgfgdfg.png"
/>
<meta name="twitter:domain" content="wiliamvj.com" />
<meta name="twitter:creator" content="@wiliamjoaquim" />
<meta name="twitter:image:alt" content="Preventing SQL Injection with Golang" />
<meta name="twitter:label1" content="Reading time"> <meta
name="twitter:data1" content="9 minutes read">
<meta name="twitter:app:name:iphone" content="wiliamvj" />

<meta property="og:type" content="article" />
<meta property="og:title" content="Preventing SQL Injection with Golang" />
<meta property="og:site_name" content="Wiliam V. Joaquim - Software Developer'" />
<meta property="og:description" content="" />
<meta property="og:url" content="//localhost:1313/en/posts/sql-injection-golang/" />
<meta property="og:image" content="//localhost:1313/posts/sql-injection-golang/thumb_en_fgfgdfg.png" />
<meta property="og:image:alt" content="Preventing SQL Injection with Golang" />


<meta
  name="apple-mobile-web-app-title"
  content="Preventing SQL Injection with Golang"
/>
<meta
  name="description"
  content="What will we cover? SQL injection is one of the most used techniques to carry out attacks on your system, where we can execute malicious SQL on vulnerable endpoints, making it possible to manipulate your database, although there are already many ways to mitigate this attack, it is still possible to leave this gap if the developer don&rsquo;t pay attention."
/>
<link
  rel="apple-touch-icon"
  sizes="180x180"
  href="/icons/apple-touch.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="32x32"
  href="/icons/favicon-32x32.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="16x16"
  href="/icons/favicon-16x16.png"
/>
<link rel="canonical" href="//localhost:1313/en/posts/sql-injection-golang/" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />


<script
  defer
  src="https://www.googletagmanager.com/gtag/js?id=G-TG8KZ9PQBT"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-TG8KZ9PQBT');
</script>


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="//localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto">
    <div class="header">
      <header
  class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 sm:py-12"
>
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="//localhost:1313/">
    <img
      srcset="/img/profile-picture_hucbf2afd9e62dc6021c155b0731b41164_625734_80x80_fill_q90_box_smart1.jpg 80w"
      src="/img/profile-picture.jpg"
      width="1080"
      height="1080"
      alt="Wiliam V. Joaquim"
    />
  </a>
</div>


  <div class="flex flex-col gap-5">
    <a href="//localhost:1313/">
  <h1 id="site-title">Wiliam V<span class="text-wpurple">.</span> Joaquim</h1>
</a>
 <nav>
  <ul class="px-4 lg:px-0">
     
    <li>
      <a
        href="/en"
        class=""
        
      >
        Posts
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li>
      <a
        href="https://wiliamvj.substack.com/"
        class=""
         target="_blank" 
      >
        Newsletter
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li>
      <a
        href="/"
        class=""
        
      >
        pt-BR
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li class="-mt-2 block lg:hidden"><button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');
    setTheme(theme);
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      html.classList.remove('dark');
      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      html.classList.add('dark');
      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');
    const newTheme = theme === 'light' ? 'dark' : 'light';
    localStorage.setItem('theme', newTheme);
    setTheme(newTheme);
    reloadGiscus(newTheme);
  }
</script>


<script>
  function reloadGiscus(theme) {
    const existingGiscusScript = document.getElementById('giscus-script');
    if (existingGiscusScript) existingGiscusScript.remove();

    let giscusScript = document.createElement('script');
    const giscusTheme = theme === 'light' ? 'noborder_light' : 'noborder_dark';

    let giscusAttributes = {
      id: 'giscus-script',
      src: 'https://giscus.app/client.js',
      'data-repo': 'wiliamvj\/wiliamvj.com',
      'data-repo-id': 'R_kgDOLkkfgA',
      'data-category': 'General',
      'data-category-id': 'DIC_kwDOLkkfgM4CeL5M',
      'data-mapping': 'title',
      'data-strict': '0',
      'data-reactions-enabled':
        '1',
      'data-emit-metadata':
        '0',
      'data-input-position':
        'top',
      'data-theme': giscusTheme,
      'data-lang': 'pt',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: '',
    };

    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.body.appendChild(giscusScript);
  }
</script>

</li>
  </ul>
</nav>

  </div>
</header>

      <div class="lg:inline-block hidden">
        <button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');
    setTheme(theme);
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      html.classList.remove('dark');
      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      html.classList.add('dark');
      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');
    const newTheme = theme === 'light' ? 'dark' : 'light';
    localStorage.setItem('theme', newTheme);
    setTheme(newTheme);
    reloadGiscus(newTheme);
  }
</script>


<script>
  function reloadGiscus(theme) {
    const existingGiscusScript = document.getElementById('giscus-script');
    if (existingGiscusScript) existingGiscusScript.remove();

    let giscusScript = document.createElement('script');
    const giscusTheme = theme === 'light' ? 'noborder_light' : 'noborder_dark';

    let giscusAttributes = {
      id: 'giscus-script',
      src: 'https://giscus.app/client.js',
      'data-repo': 'wiliamvj\/wiliamvj.com',
      'data-repo-id': 'R_kgDOLkkfgA',
      'data-category': 'General',
      'data-category-id': 'DIC_kwDOLkkfgM4CeL5M',
      'data-mapping': 'title',
      'data-strict': '0',
      'data-reactions-enabled':
        '1',
      'data-emit-metadata':
        '0',
      'data-input-position':
        'top',
      'data-theme': giscusTheme,
      'data-lang': 'pt',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: '',
    };

    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.body.appendChild(giscusScript);
  }
</script>


      </div>
    </div>

    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-small">Preventing SQL Injection with Golang</h2>

    <div class="meta">
      
      <time
        datetime="2023-12-27 19:03:34 -0300 -03"
        title='Wed, Dec 27, 2023, 7:03 PM -03'
      >
        Published in: 27/12/2023 - 9 minutes read
      </time>

       
    </div>
  </header>

  


  <section><p><img alt="thumbnail" src="/posts/sql-injection-golang/thumb_en_fgfgdfg.png"></p>
<h2 id="what-will-we-cover">What will we cover?</h2>
<p>SQL injection is one of the most used techniques to carry out attacks on your system, where we can execute malicious SQL on vulnerable endpoints, making it possible to manipulate your database, although there are already many ways to mitigate this attack, it is still possible to leave this gap if the developer don&rsquo;t pay attention.</p>
<p>Most ORM&rsquo;s already inhibit this type of attack, but in Go it is very common not to use ORM, the chances of this vulnerability occurring are greater if it is not handled correctly.</p>
<h2 id="how-sql-injection-works">How SQL Injection works</h2>
<p>SQL injection generally happens in routes that provided filters that allow parameters to be passed and these parameters are not treated correctly, for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/users?id=1 <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span></code></pre></div><p>This endpoint searches for a user by id, but without correct treatment, an SQL injection can be performed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/users?id=&#39;1&#39;OR&#39;1&#39;=&#39;1&#39; <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span></code></pre></div><p>Adding the sql <code>'1'OR'1'='1'</code> which ignores any condition, <code>'1'='1</code> returns a true boolean, this way the query always returns all users in our database, this vulnerability is serious, we can even delete the entire database.</p>
<h2 id="creating-a-seed">Creating a seed</h2>
<p>To help with testing, we will create a seed (populate records in the table), to facilitate our tests, inside the <strong>database</strong> folder we will create a <code>seed.go</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">SeedUsers</span>() <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// drop table users
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    _, err <span style="color:#ff79c6">:=</span> DBConnection.<span style="color:#50fa7b">Exec</span>(<span style="color:#f1fa8c">`DROP TABLE IF EXISTS users`</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      log.<span style="color:#50fa7b">Fatal</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// create table users
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    createTableQuery <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">`
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      CREATE TABLE IF NOT EXISTS users (
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        id SERIAL PRIMARY KEY,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        name VARCHAR(256) NOT NULL,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        email VARCHAR(256) NOT NULL UNIQUE,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        password VARCHAR(256) NOT NULL
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      )
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    `</span>
</span></span><span style="display:flex;"><span>    _, err = DBConnection.<span style="color:#50fa7b">Exec</span>(createTableQuery)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      log.<span style="color:#50fa7b">Fatal</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Tabela de usuários criada com sucesso.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    insertUserQuery <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">`
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      INSERT INTO users (name, email, password) VALUES
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      (&#39;John Doe&#39;, &#39;john.doe@example.com&#39;, 123456),
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      (&#39;Bob&#39;, &#39;bob@example.com&#39;, 123456),
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      (&#39;Charlie&#39;, &#39;charlie@example.com&#39;, 123456),
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      (&#39;Slash&#39;, &#39;slash@example.com&#39;, 098765),
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      (&#39;Gilmour&#39;, &#39;gilmour@example.com&#39;, 1255657),
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      (&#39;Steve Vai&#39;, &#39;steve_vai@example.com&#39;, 1255657)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    `</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    _, err = DBConnection.<span style="color:#50fa7b">Exec</span>(insertUserQuery)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      log.<span style="color:#50fa7b">Fatal</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Usuários inseridos com sucesso.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><code>SeedUsers</code> deletes the table, if it exists, then creates the table again and finally adds the users to our table. You can add more user if you need.</p>
<h2 id="project-structure">Project structure</h2>
<p>To illustrate, let&rsquo;s create some endpoints with this vulnerability and fix these vulnerabilities, but first let&rsquo;s structure our project, I won&rsquo;t go too deep into the structure, I&rsquo;ll leave the repository link <a href="https://github.com/wiliamvj/sql-injection-golang">here</a>.</p>
<p><img alt="Project structure" src="/posts/sql-injection-golang/dsfjhk&hjJghgd.png"></p>
<p>This will be the structure of our project, we will use PostgreSQL as the database, <a href="https://github.com/go-chi/chi">go chi</a> to create our endpoints, <a href="github.com/joho/godotenv">go dot env</a> to import our environment variables.</p>
<p>We separate <code>main.go</code> to start our server, connection to the bank and our endpoints:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> database.<span style="color:#50fa7b">NewDBConnection</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">panic</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    service.<span style="color:#50fa7b">SeedUsers</span>(<span style="color:#f1fa8c">&#34;test&#34;</span>)
</span></span><span style="display:flex;"><span>    r <span style="color:#ff79c6">:=</span> chi.<span style="color:#50fa7b">NewRouter</span>()
</span></span><span style="display:flex;"><span>    r.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;/users&#34;</span>, handler.GetUsersInjectHandler)
</span></span><span style="display:flex;"><span>    r.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;/users/correct&#34;</span>, handler.GetUsersCorrectHandler)
</span></span><span style="display:flex;"><span>    r.<span style="color:#50fa7b">Delete</span>(<span style="color:#f1fa8c">&#34;/users&#34;</span>, handler.DeleteUserInjectHandler)
</span></span><span style="display:flex;"><span>    r.<span style="color:#50fa7b">Delete</span>(<span style="color:#f1fa8c">&#34;/users/correct&#34;</span>, handler.DeleteUserCorrectHandler)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    server <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>http.Server{
</span></span><span style="display:flex;"><span>      Addr:    <span style="color:#f1fa8c">&#34;:8080&#34;</span>,
</span></span><span style="display:flex;"><span>      Handler: r,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    server.<span style="color:#50fa7b">ListenAndServe</span>()
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><code>connection.go</code> will create our connection with PostgreSQL and make the connection available globally in our application:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">var</span> DBConnection <span style="color:#ff79c6">*</span>sql.DB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NewDBConnection</span>() <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> godotenv.<span style="color:#50fa7b">Load</span>(<span style="color:#f1fa8c">&#34;.env&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;error loading .env file&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    databaseURL <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Getenv</span>(<span style="color:#f1fa8c">&#34;DATABASE_URL&#34;</span>)
</span></span><span style="display:flex;"><span>    db, err <span style="color:#ff79c6">:=</span> sql.<span style="color:#50fa7b">Open</span>(<span style="color:#f1fa8c">&#34;postgres&#34;</span>, databaseURL)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    DBConnection = db
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><code>user_handler.go</code> will be responsible for handling our request and calling the <code>user_service.go</code> service.</p>
<h2 id="creating-the-endpoints">Creating the endpoints</h2>
<p>Let&rsquo;s create endpoints with vulnerabilities and one without the vulnerability.</p>
<h3 id="searching-for-users">Searching for users</h3>
<p>Let&rsquo;s create an endpoint that searches for the user by id, let&rsquo;s call it <code>GetUsersInjectHandler</code>, this endpoint will have our vulnerability.</p>
<p><code>user_handler.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GetUsersInjectHandler</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> r.Method <span style="color:#ff79c6">!=</span> http.MethodGet {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;method not allowed&#34;</span>, http.StatusMethodNotAllowed)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    id <span style="color:#ff79c6">:=</span> r.URL.<span style="color:#50fa7b">Query</span>().<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;id&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> id <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;id not provided&#34;</span>, http.StatusBadRequest)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    users, err <span style="color:#ff79c6">:=</span> service.<span style="color:#50fa7b">GetUserInject</span>(id)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(err)
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;Error when searching for users&#34;</span>, http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">Header</span>().<span style="color:#50fa7b">Set</span>(<span style="color:#f1fa8c">&#34;Content-Type&#34;</span>, <span style="color:#f1fa8c">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusOK)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(users); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;Error encoding users to JSON&#34;</span>, http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><code>user_service.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GetUserInject</span>(id <span style="color:#8be9fd">string</span>) ([]User, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    query <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;SELECT id, name, email FROM users WHERE id = %s&#34;</span>, id)
</span></span><span style="display:flex;"><span>    rows, err <span style="color:#ff79c6">:=</span> database.DBConnection.<span style="color:#50fa7b">Query</span>(query)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">defer</span> rows.<span style="color:#50fa7b">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> users []User
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> rows.<span style="color:#50fa7b">Next</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">var</span> user User
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> rows.<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>user.ID, <span style="color:#ff79c6">&amp;</span>user.Name, <span style="color:#ff79c6">&amp;</span>user.Email); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      users = <span style="color:#8be9fd;font-style:italic">append</span>(users, user)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> users, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>In the service we execute our query, passing the id directly <code>&quot;SELECT id, name, email FROM users WHERE id = %s&quot;, id</code>, here is the vulnerability we are passing the id directly to the query, without treating it first.</p>
<p>Let&rsquo;s make a request using the vscode <a href="https://marketplace.visualstudio.com/items?itemName=humao.rest-client">HTTP Client</a> extension:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/users?id=1 <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span></code></pre></div><p>We received the expected return:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;John Doe&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;john.doe@example.com&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>Now, let&rsquo;s inject the sql:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/users?id=&#39;1&#39;OR&#39;1&#39;=&#39;1&#39; <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span></code></pre></div><p>Received all users:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;John Doe&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;john.doe@example.com&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#bd93f9">2</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;Bob&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;bob@example.com&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#bd93f9">3</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;Charlie&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;charlie@example.com&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#bd93f9">4</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;Slash&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;slash@example.com&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#bd93f9">5</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;Gilmour&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;gilmour@example.com&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#bd93f9">6</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;Steve Vai&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;steve_vai@example.com&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>As the injected sql <code>'1'='1'</code> will always be <code>true</code>, the query will always return all records.</p>
<h3 id="deleting-users">Deleting users</h3>
<p>The above sql is a serious flaw, but it could get worse, if the same vulnerability is in a query that deletes records, let&rsquo;s see an example:</p>
<p><code>user_handler.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">DeleteUserInjectHandler</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> r.Method <span style="color:#ff79c6">!=</span> http.MethodDelete {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;method not allowed&#34;</span>, http.StatusMethodNotAllowed)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    id <span style="color:#ff79c6">:=</span> r.URL.<span style="color:#50fa7b">Query</span>().<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;id&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> id <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;id not provided&#34;</span>, http.StatusBadRequest)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> service.<span style="color:#50fa7b">DeleteUserInject</span>(id)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(err)
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;Error when searching for users&#34;</span>, http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">Header</span>().<span style="color:#50fa7b">Set</span>(<span style="color:#f1fa8c">&#34;Content-Type&#34;</span>, <span style="color:#f1fa8c">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusOK)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(<span style="color:#f1fa8c">&#34;Usuário deletado com sucesso&#34;</span>); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;Error encoding users to JSON&#34;</span>, http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><code>user_service.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">DeleteUserInject</span>(id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    query <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;DELETE FROM users WHERE id = %s&#34;</span>, id)
</span></span><span style="display:flex;"><span>    _, err <span style="color:#ff79c6">:=</span> database.DBConnection.<span style="color:#50fa7b">Exec</span>(query)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>We use the same logic to delete user by id:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">DELETE</span> http://localhost:8080/users?id=1 <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span></code></pre></div><p>When calling this endpoint, the user with <code>id = 1</code> is deleted, now let&rsquo;s inject the sql:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">DELETE</span> http://localhost:8080/users?id=&#39;1&#39;OR&#39;1&#39;=&#39;1&#39; <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span></code></pre></div><p>When calling the endpoint with the injected sql, notice that all records in the user table were deleted, can you imagine the damage this can do to a production database?</p>
<p>This can be done in any query, we could have an endpoint that updates the user&rsquo;s password by id and with sql injection update the password of all users, the possibilities are enormous!</p>
<h2 id="fixing-the-vulnerability">Fixing the vulnerability</h2>
<p>There are already countless ways to mitigate this attack, we could deal with it in the handler and check if there is sql in the <code>id</code> value for example, but the most effective and correct way is to use the database driver&rsquo;s existing resources, in this case the package <code>&quot;database/sql&quot;</code> already has this feature and with few modifications we can avoid the sql injection attack.</p>
<h3 id="searching-for-users-1">Searching for users</h3>
<p>Let&rsquo;s have the same logic:</p>
<p><code>user_handler.go</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GetUsersCorrectHandler</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> r.Method <span style="color:#ff79c6">!=</span> http.MethodGet {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;method not allowed&#34;</span>, http.StatusMethodNotAllowed)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    id <span style="color:#ff79c6">:=</span> r.URL.<span style="color:#50fa7b">Query</span>().<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;id&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> id <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;id not provided&#34;</span>, http.StatusBadRequest)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    users, err <span style="color:#ff79c6">:=</span> service.<span style="color:#50fa7b">GetUserCorrect</span>(id)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(err)
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;Error when searching for users&#34;</span>, http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">Header</span>().<span style="color:#50fa7b">Set</span>(<span style="color:#f1fa8c">&#34;Content-Type&#34;</span>, <span style="color:#f1fa8c">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusOK)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(users); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;Error encoding users to JSON&#34;</span>, http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><code>user_service.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GetUserCorrect</span>(id <span style="color:#8be9fd">string</span>) ([]User, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    query <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;SELECT id, name, email FROM users WHERE id = $1&#34;</span>
</span></span><span style="display:flex;"><span>    rows, err <span style="color:#ff79c6">:=</span> database.DBConnection.<span style="color:#50fa7b">Query</span>(query, id)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">defer</span> rows.<span style="color:#50fa7b">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> users []User
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> rows.<span style="color:#50fa7b">Next</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">var</span> user User
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> rows.<span style="color:#50fa7b">Scan</span>(<span style="color:#ff79c6">&amp;</span>user.ID, <span style="color:#ff79c6">&amp;</span>user.Name, <span style="color:#ff79c6">&amp;</span>user.Email); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      users = <span style="color:#8be9fd;font-style:italic">append</span>(users, user)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> users, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>However, now we don&rsquo;t pass the <code>id</code> directly, we pass the marker <code>$1</code> which indicates that we will have a parameter in that position and we pass it to the query <code>Query(query, id)</code>, this way the driver already does what we call &quot; prepared statement&quot; or &ldquo;sanitization&rdquo;, &ldquo;hydration&rdquo;, call it whatever you think is best, this approach helps separate query logic from data input, improving the security and integrity of database operations.</p>
<p>Let&rsquo;s call the endpoint and try to inject the sql:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/users/correct?id=&#39;1&#39;OR&#39;1&#39;=&#39;1&#39; <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span></code></pre></div><p>We get an error and avoid sql injection!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span> <span style="color:#bd93f9">500</span> Internal Server Error
</span></span><span style="display:flex;"><span>Content-Type<span style="color:#ff79c6">:</span> text/plain; charset=utf-8
</span></span><span style="display:flex;"><span>X-Content-Type-Options<span style="color:#ff79c6">:</span> nosniff
</span></span><span style="display:flex;"><span>Date<span style="color:#ff79c6">:</span> Wed, 27 Dec 2023 15:53:27 GMT
</span></span><span style="display:flex;"><span>Content-Length<span style="color:#ff79c6">:</span> 28
</span></span><span style="display:flex;"><span>Connection<span style="color:#ff79c6">:</span> close
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Error when searching for users
</span></span></code></pre></div><p>Searching correctly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/users/correct?id=2 <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span></code></pre></div><p>We now receive the user data correctly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#bd93f9">2</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;Bob&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;bob@example.com&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h3 id="deleting-users-1">Deleting users</h3>
<p>Let&rsquo;s use the same solution used to search for the user.</p>
<p><code>user_handler.go</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">DeleteUserCorrectHandler</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> r.Method <span style="color:#ff79c6">!=</span> http.MethodDelete {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;meyhod not allowed&#34;</span>, http.StatusMethodNotAllowed)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    id <span style="color:#ff79c6">:=</span> r.URL.<span style="color:#50fa7b">Query</span>().<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;id&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> id <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;id not provided&#34;</span>, http.StatusBadRequest)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> service.<span style="color:#50fa7b">DeleteUserCorrect</span>(id)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      fmt.<span style="color:#50fa7b">Println</span>(err)
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;Error when searching for users&#34;</span>, http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">Header</span>().<span style="color:#50fa7b">Set</span>(<span style="color:#f1fa8c">&#34;Content-Type&#34;</span>, <span style="color:#f1fa8c">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusOK)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(<span style="color:#f1fa8c">&#34;User deleted successfully&#34;</span>); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      http.<span style="color:#50fa7b">Error</span>(w, <span style="color:#f1fa8c">&#34;Error encoding users to JSON&#34;</span>, http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p><code>user_service.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">DeleteUserCorrect</span>(id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>  query <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;DELETE FROM users WHERE id = $1&#34;</span>
</span></span><span style="display:flex;"><span>  _, err <span style="color:#ff79c6">:=</span> database.DBConnection.<span style="color:#50fa7b">Exec</span>(query, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s call the endpoint and try to inject the sql:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">DELETE</span> http://localhost:8080/users/correct?id=&#39;1&#39;OR&#39;1&#39;=&#39;1&#39; <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span></code></pre></div><p>We get an error and avoid sql injection!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span> <span style="color:#bd93f9">500</span> Internal Server Error
</span></span><span style="display:flex;"><span>Content-Type<span style="color:#ff79c6">:</span> text/plain; charset=utf-8
</span></span><span style="display:flex;"><span>X-Content-Type-Options<span style="color:#ff79c6">:</span> nosniff
</span></span><span style="display:flex;"><span>Date<span style="color:#ff79c6">:</span> Wed, 27 Dec 2023 15:58:52 GMT
</span></span><span style="display:flex;"><span>Content-Length<span style="color:#ff79c6">:</span> 28
</span></span><span style="display:flex;"><span>Connection<span style="color:#ff79c6">:</span> close
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Error when deleting users
</span></span></code></pre></div><p>Deleting correctly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/users/correct?id=1 <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span></code></pre></div><p>We only delete the user with the id we want.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;User deleted successfully&#34;</span>
</span></span></code></pre></div><h2 id="final-considerations">Final considerations</h2>
<p>In this post we saw how to simulate sql injection and how to avoid sql injection, there are several ways to mitigate this attack, but using the resources provided by the database driver is generally the simplest and safest, however validating this before calling your driver causes that this vulnerability is practically nil. The use of ORM&rsquo;s also greatly reduces the chances of sql injection happening, this problem is already handled natively in the ORM, but it can still happen.</p>
<h2 id="repository-link">Repository link</h2>
<p><a href="https://github.com/wiliamvj/sql-injection-golang">repository</a> of the project</p>
<p><a href="https://github.com/egonelbre/gophers">Gopher credits</a></p>
</section>

  

 <div class="giscus-comment">
  <script>
    let theme = localStorage.getItem('theme');
    const giscusTheme = theme === 'light' ? 'noborder_light' : 'noborder_dark';
    var currentUrl = window.location.href;
    const lang = currentUrl.indexOf('/en/') !== -1 ? 'en' : 'pt';
    let giscusAttributes = {
      id: 'giscus-script',
      src: 'https://giscus.app/client.js',
      'data-repo': 'wiliamvj\/wiliamvj.com',
      'data-repo-id': 'R_kgDOLkkfgA',
      'data-category': 'General',
      'data-category-id': 'DIC_kwDOLkkfgM4CeL5M',
      'data-mapping': 'title',
      'data-strict': '0',
      'data-reactions-enabled':
        '1',
      'data-emit-metadata':
        '0',
      'data-input-position':
        'top',
      'data-theme': theme,
      'data-lang': lang,
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: '',
    };

    let giscusScript = document.createElement('script');
    const article = document.querySelector('article');
    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    article.appendChild(giscusScript);
  </script>
</div>
 


 


  <footer>
    
  </footer>
</article>

</main><footer class="pt-5 pb-6 lg:grid lg:gap-3 lg:grid-cols-2">
  <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2024 —
  <a href="//localhost:1313/">Wiliam V. Joaquim</a>
  <span class="font-normal">with</span>
  <a
    href="https://github.com/nixentric/Lowkey-Hugo-Theme"
    target="_blank"
    rel="noopener noreferrer"
  >
    Lowkey
  </a>
</div>
 <div class="order-1 sm:order-2 f-social">
  <ul class="flex sm:justify-end gap-5">
     
    <li>
      <a href="https://www.linkedin.com/in/wiliamvj/" target="_blank" rel="noopener noreferrer"
        >linkedin</a
      >
    </li>
    
    <li>
      <a href="https://twitter.com/wiliamjoaquim" target="_blank" rel="noopener noreferrer"
        >x</a
      >
    </li>
    
    <li>
      <a href="https://github.com/wiliamvj" target="_blank" rel="noopener noreferrer"
        >github</a
      >
    </li>
    
    <li>
      <a href="https://dev.to/wiliamvj" target="_blank" rel="noopener noreferrer"
        >dev.to</a
      >
    </li>
     
  </ul>
</div>

</footer>

<button
  type="button"
  data-twe-ripple-init
  data-twe-ripple-color="light"
  class="!fixed bottom-5 end-5 hidden rounded-md bg-wpurple p-3 text-xs font-medium uppercase leading-tight text-white shadow-md transition duration-150 ease-in-out hover:bg-wpurplehover hover:shadow-lg focus:bg-wpurplehover focus:shadow-lg focus:outline-none focus:ring-0 active:bg-wpurple active:shadow-lg"
  id="btn-back-to-top"
>
  <span class="[&>svg]:w-4">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="3"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18"
      />
    </svg>
  </span>
</button>

<script defer>
  const mybutton = document.getElementById('btn-back-to-top');
  const scrollFunction = () => {
    if (
      document.body.scrollTop > 20 ||
      document.documentElement.scrollTop > 20
    ) {
      mybutton.classList.remove('hidden');
    } else {
      mybutton.classList.add('hidden');
    }
  };
  const backToTop = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  mybutton.addEventListener('click', backToTop);
  window.addEventListener('scroll', scrollFunction);
</script>
</body>
</html>
