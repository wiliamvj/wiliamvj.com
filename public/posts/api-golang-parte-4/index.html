<!DOCTYPE html>
<html lang="pt" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script> 

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>API completa em Golang - Parte 4</title>
<meta
  name="apple-mobile-web-app-title"
  content="API completa em Golang - Parte 4"
/>
<meta
  name="description"
  content="O que vamos fazer? Na parte 4 do nosso crud, vamos fazer a lógica do nosso service de usuário."
/>
<link
  rel="apple-touch-icon"
  sizes="180x180"
  href="/icons/apple-touch.png"
/>

<link rel="canonical" href="//localhost:1313/posts/api-golang-parte-4/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="//localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto">
    <div class="header">
      <header
  class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 sm:py-12"
>
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="//localhost:1313/">
    <img
      srcset="/img/profile-picture_hucbf2afd9e62dc6021c155b0731b41164_625734_80x80_fill_q90_box_smart1.jpg 80w"
      src="/img/profile-picture.jpg"
      width="1080"
      height="1080"
      alt="Wiliam V. Joaquim"
    />
  </a>
</div>


  <div class="flex flex-col gap-5">
    <a href="//localhost:1313/">
  <h1 id="site-title">Wiliam V<span class="text-wpurple">.</span> Joaquim</h1>
</a>
 <nav>
  <ul class="px-4 lg:px-0">
     
    <li>
      <a
        href="/"
        class=""
        
      >
        Artigos
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li>
      <a
        href="https://wiliamvj.substack.com/"
        class=""
         target="_blank" 
      >
        Newsletter
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li>
      <a
        href="/en/"
        class=""
        
      >
        en-US
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li class="-mt-2 block lg:hidden"><button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme !== 'light') {
      setTheme('dark');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
</li>
  </ul>
</nav>

  </div>
</header>

      <div class="lg:inline-block hidden">
        <button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme !== 'light') {
      setTheme('dark');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>

      </div>
    </div>

    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-small">API completa em Golang - Parte 4</h2>

    <div class="meta">
      
      <time
        datetime="2023-12-21 17:54:40 -0300 -03"
        title='Thu, Dec 21, 2023, 5:54 PM -03'
      >
        Publicado em: 21/12/2023 - 14 minutos de leitura
      </time>

       
    </div>
  </header>

  

  <section><p><img alt="thumbnail" src="/posts/api-golang-parte-4/htyf78HJsvdfczaqfg6jiopl.png"></p>
<h2 id="o-que-vamos-fazer">O que vamos fazer?</h2>
<p>Na parte 4 do nosso crud, vamos fazer a lógica do nosso service de usuário.</p>
<p>Se ainda não viu os posts anteriores leia eles primeiro.</p>
<p><a href="/posts/api-golang-parte-1/">parte 1</a> |
<a href="/posts/api-golang-parte-2/">parte 2</a> |
<a href="/posts/api-golang-parte-3/">parte 3</a> |</p>
<h2 id="criando-nossas-entidades">Criando nossas entidades</h2>
<p>Vamos primeiro criar nossa entidade de usuário, essa entidade vai ser uma representação dos dados do usuário no banco de dados, a entidade vai ser o que vamos retornar do nosso repository, dessa forma não vamos depender da tipagem geradao pelo sqlc. Precisamos criar nessa etapa para poder deixar o contrato entre <code>service</code> e <code>repository</code> definidos.</p>
<p>Crie um arquivo na pasta <strong>entity</strong> chamado <code>user_entity.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserEntity <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    ID        <span style="color:#8be9fd">string</span>    <span style="color:#f1fa8c">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>    Name      <span style="color:#8be9fd">string</span>    <span style="color:#f1fa8c">`json:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>    Email     <span style="color:#8be9fd">string</span>    <span style="color:#f1fa8c">`json:&#34;email&#34;`</span>
</span></span><span style="display:flex;"><span>    Password  <span style="color:#8be9fd">string</span>    <span style="color:#f1fa8c">`json:&#34;password,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    CreatedAt time.Time <span style="color:#f1fa8c">`json:&#34;created_at&#34;`</span>
</span></span><span style="display:flex;"><span>    UpdatedAt time.Time <span style="color:#f1fa8c">`json:&#34;updated_at&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Por hora essa serão os dados da entidade user.</p>
<h2 id="contrato-entre-service-e-repository">Contrato entre service e repository</h2>
<p>Ainda não vamos trabalhar no service, mas precisamos definir o contrato para deixar nosso service caminhando sem o repository estar pronto, os contratos nos ajudam com isso, esse desacoplamento permite mais liberdade de avançar sem precisar implementar outras partes da aplicação, podemos inclusive adiar a escolha do banco de dados a ser utilizado, mas poderíamos tranquilamente finalizar todo o resto da aplicação.</p>
<p>Vamos criar nossas interfaces no <code>user_interface_repository.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NewUserRepository</span>(db <span style="color:#ff79c6">*</span>sql.DB, q <span style="color:#ff79c6">*</span>sqlc.Queries) UserRepository {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>repository{
</span></span><span style="display:flex;"><span>      db,
</span></span><span style="display:flex;"><span>      q,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> repository <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    db      <span style="color:#ff79c6">*</span>sql.DB
</span></span><span style="display:flex;"><span>    queries <span style="color:#ff79c6">*</span>sqlc.Queries
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserRepository <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">CreateUser</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>entity.UserEntity) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindUserByEmail</span>(ctx context.Context, email <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindUserByID</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdateUser</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>entity.UserEntity) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">DeleteUser</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindManyUsers</span>(ctx context.Context) ([]entity.UserEntity, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdatePassword</span>(ctx context.Context, pass, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Por enquanto esses serão o métodos que vamos utilizar para o usuário, sempre que precisamos retornamos nossa entidade, no qual é de nosso controle, como já mencionado, poderíamos remover essa abstração e o service chamar diretamente os métodos e tipagem gerados pelo sqlc, mas ficamos amarrados ao sqlc, dessa forma ficaria mais tranquilo remover o sqlc caso fosse necessário.</p>
<p>Implementando o <code>UserRepository</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">CreateUser</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>entity.UserEntity) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">FindUserByEmail</span>(ctx context.Context, email <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">FindUserByID</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">UpdateUser</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>entity.UserEntity) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">DeleteUser</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">FindManyUsers</span>(ctx context.Context) ([]entity.UserEntity, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">UpdatePassword</span>(ctx context.Context, pass, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Como não vamos trabalhar nessa camada agora, apenas implemente o contrato para o Go parar de acusar o erro.</p>
<h2 id="implementando-o-service">Implementando o service</h2>
<p>Agora vamos partir para a nossa regra de negócio, o service é a camada mais importante, nela que vamos definir o comportamento da nossa aplicação, no handler apenas tratamos a entrada do dado, não manipulamos nada, e o repository vai servir apenas para persistir e buscar dados no banco.</p>
<h3 id="criando-o-usuário">Criando o usuário</h3>
<p>Primeira coisa que precisamos fazer é verificar se o e-mail do usuário que vamos cadastrar já existe no banco, pois nosso campo de e-mail no banco será único</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  userExists, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByEmail</span>(ctx, u.Email)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by email&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> userExists <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Se a busca do usuário por e-mail retornar um erro, retornamos esse erro, se o <code>userExists</code> for diferente de nil, significa que encontrou um usuário, então não podemos deixar prosseguir, retornamos um novo erro <code>errors.New(&quot;user already exists&quot;)</code>, ainda vamos tratar esse erro no handler e retornar um status code correto.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  passwordEncrypted, err <span style="color:#ff79c6">:=</span> bcrypt.<span style="color:#50fa7b">GenerateFromPassword</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(u.Password), <span style="color:#bd93f9">12</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to encrypt password&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;error to encrypt password&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Agora vamos precisar encriptar a senha do usuário, usando o pacote nativo do Go chamado <a href="https://pkg.go.dev/golang.org/x/crypto@v0.13.0/bcrypt">bcrypt</a>, transformamos a senha do usuário que está no <code>u.Password</code> em um slice de bytes e informamos que a força da encriptação da senha é 12, por padrão o <code>DefaultCost</code> é 10, quanto maior esse número mais forte é sua encriptação, o máximo aceito é 31, lembrando que encriptar tem um custo computacional, quanto maior esse número mais tempo vai levar.</p>
<p>Por curiosidade usando o valor 12 demora cerca de 100ms (Milissegundo) para encriptar, colocando 31 demora cerca de 7 minutos, claro que depende do hardware que está fazendo isso, mas a diferença de tempo é muito grande. Por padrão o uso comum usamos entre 10 e 14.</p>
<p>Agora vamos transformar os dados recebido para a nossa estrutura do <code>UserEntity</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  newUser <span style="color:#ff79c6">:=</span> entity.UserEntity{
</span></span><span style="display:flex;"><span>    ID:        uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>(),
</span></span><span style="display:flex;"><span>    Name:      u.Name,
</span></span><span style="display:flex;"><span>    Email:     u.Email,
</span></span><span style="display:flex;"><span>    Password:  <span style="color:#8be9fd;font-style:italic">string</span>(passwordEncrypted),
</span></span><span style="display:flex;"><span>    CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>    UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Para criar o id do tipo uuid usamos o <a href="https://pkg.go.dev/github.com/google/uuid@v1.1.2">pacote da google</a> o mesmo que usamos para validar um uuid no handler. Outra vantagem de remover a responsabilidade da criação do id do banco de dados, é que agora já sabemos o id do desse usuário sem salvar no banco, isso tem inúmeras vantagem.</p>
<p>Por fim vamos chamar nosso repository e salvar o usuário no banco:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  err = s.repo.<span style="color:#50fa7b">CreateUser</span>(ctx, <span style="color:#ff79c6">&amp;</span>newUser)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to create user&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Apenas isso é suficiente para criar um usuário, ainda vamos adicionar o endereço do usuário ainda na parte 4, e vamos alterar o <code>CreateUser</code>.</p>
<h3 id="atualizando-o-usuário">Atualizando o usuário</h3>
<p>Vai ser parecido com a criação, mas primeiro vamos verificar se o usuário existe pelo id:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  userExists, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByID</span>(ctx, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by id&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> userExists <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>A lógica inverte, na criação se o <code>userExists</code> for diferente de <code>nil</code> retornamos um erro, no update se o <code>userExists</code> for igual a <code>nil</code>, retornamos um erro, pois significa que não encontramos o usuário que o client que atualizar.</p>
<p>Tem um detalhe, caso o e-mail seja informado:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> u.Email <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>    verifyUserEmail, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByEmail</span>(ctx, u.Email)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by email&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> verifyUserEmail <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Caso o client precise atualizar o e-mail, antes precisamos verificar se o novo e-mail não está sendo utilizado por outro usuário, fazemos isso no código acima.</p>
<p>Por fim, vamos passar tudo isso para a struct <code>UserEntity</code> e chamar nosso repository:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  updateUser <span style="color:#ff79c6">:=</span> entity.UserEntity{
</span></span><span style="display:flex;"><span>    ID:        id,
</span></span><span style="display:flex;"><span>    Name:      u.Name,
</span></span><span style="display:flex;"><span>    Email:     u.Email,
</span></span><span style="display:flex;"><span>    UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  err = s.repo.<span style="color:#50fa7b">UpdateUser</span>(ctx, <span style="color:#ff79c6">&amp;</span>updateUser)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to update user&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><p>E retornamos <code>nil</code> se todo ocorrer corretamente, perceba que na criação, atualização, deletar usuário retornamos sempre <code>nil</code>, na nossa aplicação não tem sentido retornar dados para o cliente, pois são os mesmos dados que acabamos de receber do client, mas existem casos que faz sentido retornar após nossa api processar os dados, tudo depende da sua regra.</p>
<h3 id="detalhes-do-usuário">Detalhes do usuário</h3>
<p>Vamos buscar os dados do usuário pelo id.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span> userExists, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByID</span>(ctx, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by id&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> userExists <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Mesma lógica que já fizemos acima, porém agora nosso service <code>GetUserByID</code> retorna um <code>*response.UserResponse</code>, então precisamos passar nosso <code>UserEntity</code> retornado pelo repository para <code>UserResponse</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  user <span style="color:#ff79c6">:=</span> response.UserResponse{
</span></span><span style="display:flex;"><span>    ID:        userExists.ID,
</span></span><span style="display:flex;"><span>    Name:      userExists.Name,
</span></span><span style="display:flex;"><span>    Email:     userExists.Email,
</span></span><span style="display:flex;"><span>    CreatedAt: userExists.CreatedAt,
</span></span><span style="display:flex;"><span>    UpdatedAt: userExists.UpdatedAt,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>user, <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><p>E pronto, isso é o suficiente!</p>
<h3 id="deletando-o-usuário">Deletando o usuário</h3>
<p>Essa deve ser a mais simples de todas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  userExists, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByID</span>(ctx, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by id&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> userExists <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  err = s.repo.<span style="color:#50fa7b">DeleteUser</span>(ctx, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to delete user&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><p>Apenas verificamos se o usuário existe e depois chamamos o repository.</p>
<h3 id="listar-todos-os-usuários">Listar todos os usuários</h3>
<p>Esse metódo também é bem simples.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  findManyUsers, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindManyUsers</span>(ctx)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to find many users&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  users <span style="color:#ff79c6">:=</span> response.ManyUsersResponse{}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> _, user <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> findManyUsers {
</span></span><span style="display:flex;"><span>    userResponse <span style="color:#ff79c6">:=</span> response.UserResponse{
</span></span><span style="display:flex;"><span>      ID:        user.ID,
</span></span><span style="display:flex;"><span>      Name:      user.Name,
</span></span><span style="display:flex;"><span>      Email:     user.Email,
</span></span><span style="display:flex;"><span>      CreatedAt: user.CreatedAt,
</span></span><span style="display:flex;"><span>      UpdatedAt: user.UpdatedAt,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    users.Users = <span style="color:#8be9fd;font-style:italic">append</span>(users.Users, userResponse)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>users, <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><p>Como nosso repository retorna um slice do <code>[]entity.UserEntity</code>, precisamos fazer um loop e transformar em <code>response.ManyUsersResponse</code>, é o que fazemos acima.</p>
<h3 id="alterando-a-senha">Alterando a senha</h3>
<p>Por último, vamos atualizar a senha.</p>
<p>Primeiro fazemos a validação padrão se o usuário existe.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  userExists, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByID</span>(ctx, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by id&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> userExists <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Agora precisamos verificar se a senha que temos no banco de dados é a mesma senha que o usuário informou como sua senha antiga, que usamos no nosso dto <code>UpdateUserPasswordDto</code>, se for diferente já retornamos um erro:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#6272a4">// compare passwords
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  err = bcrypt.<span style="color:#50fa7b">CompareHashAndPassword</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(userExists.Password), []<span style="color:#8be9fd;font-style:italic">byte</span>(u.OldPassword))
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;invalid password&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;invalid password&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Agora vamos adicionar mais um verificação de segurança, para impedir que o usuário troque uma senha por outra exatamente igua, mesma lógica acima, mas agora comparando com a senha do banco e a nova senha que o usuário informou:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#6272a4">// compare new password with password in database
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  err = bcrypt.<span style="color:#50fa7b">CompareHashAndPassword</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(userExists.Password), []<span style="color:#8be9fd;font-style:italic">byte</span>(u.Password))
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;new password is equal to old password&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;new password is equal to old password&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Por fim, vamos encriptar a nova senha do usuário e salvar no banco, igual o que fizemos na criação do usuário, porém criei um método apenas para salvar a senha do usuário no banco:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  passwordEncrypted, err <span style="color:#ff79c6">:=</span> bcrypt.<span style="color:#50fa7b">GenerateFromPassword</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(u.Password), <span style="color:#bd93f9">12</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to encrypt password&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;error to encrypt password&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  err = s.repo.<span style="color:#50fa7b">UpdatePassword</span>(ctx, <span style="color:#8be9fd;font-style:italic">string</span>(passwordEncrypted), id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to update password&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><h2 id="melhorando-erros-do-handler">Melhorando erros do handler</h2>
<p>Nosso service retorna alguns erros que precisamos melhorar no nosso handler, como <code>&quot;user not found&quot;</code>, para isso vamos adicionar esse tratamento no <code>user_handler.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  err = h.service.<span style="color:#50fa7b">UpdateUser</span>(r.<span style="color:#50fa7b">Context</span>(), req, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;error to update user: %v&#34;</span>, err), slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;handler_user&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err.<span style="color:#50fa7b">Error</span>() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;user not found&#34;</span> {
</span></span><span style="display:flex;"><span>      w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusNotFound)
</span></span><span style="display:flex;"><span>      msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewNotFoundError</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>      json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusBadRequest)
</span></span><span style="display:flex;"><span>    msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewBadRequestError</span>(<span style="color:#f1fa8c">&#34;error to update user&#34;</span>)
</span></span><span style="display:flex;"><span>    json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Dentro do tratamento do erro da chamada ao service, vamos adicionar um novo <code>if</code>, caso o erro seja do tipo <code>&quot;user not found&quot;</code> retornamos um erro com no nosso <code>httperr</code> do tipo <code>NotFoundError</code>.</p>
<p>Você pode alterar essa forma de tratar os erros, para evitar ficar tratando isso no handler, como por exemplo no service retornar já um erro do tipo <code>*http.Request</code>, assim no handler poderia apenas retornar o erro e o service que seria responsável por determinar o tipo do erro, status code e tudo mais, porém prefiro separar e deixar no handler a responsabilidade do http.</p>
<p>Você vai precisar colocar esse tratamento nos métodos do handler: <code>UpdateUser</code>, <code>GetUserByID</code>, <code>DeleteUser</code>, <code>UpdateUserPassword</code>.</p>
<h2 id="salvando-o-endereço">Salvando o endereço</h2>
<p>Agora vamos salvar o endereço do usuário, para isso vamos utilizar a api do <a href="https://viacep.com.br/">viacep</a>, vamos primeiro atualizar nosso dto <code>CreateUserDto</code> e <code>UpdateUserDto</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> CreateUserDto <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    Name     <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;name&#34; validate:&#34;required,min=3,max=30&#34;`</span>
</span></span><span style="display:flex;"><span>    Email    <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;email&#34; validate:&#34;required,email&#34;`</span>
</span></span><span style="display:flex;"><span>    Password <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;password&#34; validate:&#34;required,min=8,max=30,containsany=!@#$%*&#34;`</span>
</span></span><span style="display:flex;"><span>    CEP      <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;cep&#34; validate:&#34;required,min=8,max=8&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UpdateUserDto <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    Name  <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;name&#34; validate:&#34;omitempty,min=3,max=30&#34;`</span>
</span></span><span style="display:flex;"><span>    Email <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;email&#34; validate:&#34;omitempty,email&#34;`</span>
</span></span><span style="display:flex;"><span>    CEP   <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;cep&#34; validate:&#34;omitempty,min=8,max=8&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Adicionando o campo <code>CEP</code>, com a validação simples de no mínimo e máximo 8 caracteres, como o nosso validator <code>ValidateHttpData</code> já tem o case <code>min</code> e <code>max</code> não precisamos fazer nada, já está funcionando a validação.</p>
<p>Vamos separar a chamada a api do viacep em uma função, vamos criar na raiz do projeto uma pasta chamada <strong>api</strong> e dentro dela outra pasta chamada <strong>viacep</strong>, na pasta api vamos salvar todo o código que for chamar api de terceiros, agora crie um arquivo chamado <code>viacep.go</code> dentro da pasta <strong>api/viacep</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#ff79c6">package</span> viacep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;github.com/wiliamvj/api-users-golang/config/env&#34;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> ViaCepResponse <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    CEP         <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;cep&#34;`</span>
</span></span><span style="display:flex;"><span>    Logradouro  <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;logradouro&#34;`</span>
</span></span><span style="display:flex;"><span>    Complemento <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;complemento&#34;`</span>
</span></span><span style="display:flex;"><span>    Bairro      <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;bairro&#34;`</span>
</span></span><span style="display:flex;"><span>    Localidade  <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;localidade&#34;`</span>
</span></span><span style="display:flex;"><span>    UF          <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;uf&#34;`</span>
</span></span><span style="display:flex;"><span>    IBGE        <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;ibge&#34;`</span>
</span></span><span style="display:flex;"><span>    GIA         <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;gia&#34;`</span>
</span></span><span style="display:flex;"><span>    DDD         <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;ddd&#34;`</span>
</span></span><span style="display:flex;"><span>    SIAFI       <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;siafi&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GetCep</span>(cep <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>ViaCepResponse, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    url <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s/%s/json&#34;</span>, env.Env.ViaCepURL, cep)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> viaCepResponse ViaCepResponse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    resp, err <span style="color:#ff79c6">:=</span> http.<span style="color:#50fa7b">Get</span>(url)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">defer</span> resp.Body.<span style="color:#50fa7b">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    err = json.<span style="color:#50fa7b">NewDecoder</span>(resp.Body).<span style="color:#50fa7b">Decode</span>(<span style="color:#ff79c6">&amp;</span>viaCepResponse)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> viaCepResponse.CEP <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, fmt.<span style="color:#50fa7b">Errorf</span>(<span style="color:#f1fa8c">&#34;cep not found&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>viaCepResponse, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro criamos um struct para deixar com a tipagem da resposta do viacep, depois criamos uma função chamada <code>GetCep</code> que recebe uma cep do tipo string e retorna um ponteiro do <code>*ViaCepResponse</code> ou um <code>error</code>, depois montamos a url usando o <code>fmt.Sprintf</code>, o <code>ViaCepURL</code> colocamos em uma váriavel, você pode colocar a url diretamente se preferir, coloquei em uma env para treinar como utilizar a env com viper, precisa colocar o valor na env:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  VIA_CEP_URL=<span style="color:#f1fa8c">&#34;https://viacep.com.br/ws&#34;</span>
</span></span></code></pre></div><p>Precisamos importar usando viper na nossa <strong>config</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> config <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    GoEnv       <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;GO_ENV&#34;`</span>
</span></span><span style="display:flex;"><span>    GoPort      <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;GO_PORT&#34;`</span>
</span></span><span style="display:flex;"><span>    DatabaseURL <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;DATABASE_URL&#34;`</span>
</span></span><span style="display:flex;"><span>    ViaCepURL   <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;VIA_CEP_URL&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Depois fazemos a chamada <a href="https://pkg.go.dev/net/http">http</a> usando o pacote do Go, por fim transformamos o body recebido na nossa struct <code>ViaCepResponse</code>.</p>
<p>Precisamos agora alterar nosso entity, para adicionar o endereço:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserEntity <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    ID        <span style="color:#8be9fd">string</span>      <span style="color:#f1fa8c">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>    Name      <span style="color:#8be9fd">string</span>      <span style="color:#f1fa8c">`json:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>    Email     <span style="color:#8be9fd">string</span>      <span style="color:#f1fa8c">`json:&#34;email&#34;`</span>
</span></span><span style="display:flex;"><span>    Password  <span style="color:#8be9fd">string</span>      <span style="color:#f1fa8c">`json:&#34;password,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    Address   UserAddress <span style="color:#f1fa8c">`json:&#34;address,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    CreatedAt time.Time   <span style="color:#f1fa8c">`json:&#34;created_at&#34;`</span>
</span></span><span style="display:flex;"><span>    UpdatedAt time.Time   <span style="color:#f1fa8c">`json:&#34;updated_at&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserAddress <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    CEP        <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;cep&#34;`</span>
</span></span><span style="display:flex;"><span>    IBGE       <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;ibge&#34;`</span>
</span></span><span style="display:flex;"><span>    UF         <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;uf&#34;`</span>
</span></span><span style="display:flex;"><span>    City       <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;city&#34;`</span>
</span></span><span style="display:flex;"><span>    Complement <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;complement,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    Street     <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;street&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Não precisamos alterar nada no nosso handler, somente no nosso service, vamos lá! Vamos alterar somente o <code>CreateUser</code> e <code>UpdateUser</code>.</p>
<p><code>CreateUser</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  cep, err <span style="color:#ff79c6">:=</span> viacep.<span style="color:#50fa7b">GetCep</span>(u.CEP)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to get cep&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  newUser <span style="color:#ff79c6">:=</span> entity.UserEntity{
</span></span><span style="display:flex;"><span>    ID:       uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>(),
</span></span><span style="display:flex;"><span>    Name:     u.Name,
</span></span><span style="display:flex;"><span>    Email:    u.Email,
</span></span><span style="display:flex;"><span>    Password: <span style="color:#8be9fd;font-style:italic">string</span>(passwordEncrypted),
</span></span><span style="display:flex;"><span>    Address: entity.UserAddress{
</span></span><span style="display:flex;"><span>      CEP:        cep.CEP,
</span></span><span style="display:flex;"><span>      IBGE:       cep.IBGE,
</span></span><span style="display:flex;"><span>      UF:         cep.UF,
</span></span><span style="display:flex;"><span>      City:       cep.Localidade,
</span></span><span style="display:flex;"><span>      Complement: cep.Complemento,
</span></span><span style="display:flex;"><span>      Street:     cep.Logradouro,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>    UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro vamos pegar o cep usando a função que criamos, caso retorne um erro paramos ali, depois apenas colocamos o retorno do <code>cep</code> na struct <code>newUser</code> e pronto, isso é suficiente.</p>
<p>O <code>UpdateUser</code> que vai ter um pouco mais de alteração, primeiro não vamos mais inicializar e já atribuir valor do <code>UserEntity</code> diretamente igual estávamos fazendo, vamos primeiro declarar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">var</span> updateUser entity.UserEntity
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> u.Email <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>    verifyUserEmail, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByEmail</span>(ctx, u.Email)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by email&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> verifyUserEmail <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    updateUser.Email = u.Email
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> u.CEP <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>    cep, err <span style="color:#ff79c6">:=</span> viacep.<span style="color:#50fa7b">GetCep</span>(u.CEP)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to get cep&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    updateUser.Address = entity.UserAddress{
</span></span><span style="display:flex;"><span>      CEP:        cep.CEP,
</span></span><span style="display:flex;"><span>      IBGE:       cep.IBGE,
</span></span><span style="display:flex;"><span>      UF:         cep.UF,
</span></span><span style="display:flex;"><span>      City:       cep.Localidade,
</span></span><span style="display:flex;"><span>      Complement: cep.Complemento,
</span></span><span style="display:flex;"><span>      Street:     cep.Logradouro,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro declaramos o <code>updateUser</code>, depois se tiver um e-mail dentro do if atribuímos o <code>updateUser.Email = u.Email</code>, depois ao atualizar se houver um cep, entramos no if e vamos chamar a nossa função <code>GetCep</code> e por fim inicializamos e atribuímos o <code>updateUser.Address</code>.</p>
<p>Depois atribuímos os valores finais:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  updateUser.ID = id
</span></span><span style="display:flex;"><span>  updateUser.Name = u.Name
</span></span><span style="display:flex;"><span>  updateUser.UpdatedAt = time.<span style="color:#50fa7b">Now</span>()
</span></span></code></pre></div><p>Existe várias maneiras de fazer isso, essa é a forma que acho mais simples de entender o que está acontecendo e o que estamos atribuindo a nosso <code>UserEntity</code>.</p>
<h2 id="melhorando-erros-do-handler-1">Melhorando erros do handler</h2>
<p>Podemos adicionar novos erros no nosso handler:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>err = h.service.<span style="color:#50fa7b">CreateUser</span>(r.<span style="color:#50fa7b">Context</span>(), req)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;error to create user: %v&#34;</span>, err), slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userhandler&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err.<span style="color:#50fa7b">Error</span>() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;cep not found&#34;</span> {
</span></span><span style="display:flex;"><span>      w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusNotFound)
</span></span><span style="display:flex;"><span>      msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewNotFoundError</span>(<span style="color:#f1fa8c">&#34;cep not found&#34;</span>)
</span></span><span style="display:flex;"><span>      json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>    msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewBadRequestError</span>(<span style="color:#f1fa8c">&#34;error to create user&#34;</span>)
</span></span><span style="display:flex;"><span>    json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Adicionamos o erro <code>&quot;cep not found&quot;</code> para novos erro do cep, adicione apenas no <code>CreateUser</code> e <code>UpdateUser</code>.</p>
<h2 id="considerações-finais">Considerações finais</h2>
<p>Nesse post conseguimos avançar bastante a nossa api, deixamos nosso service de usuário praticamente pronto, fizemos o cadastro de endereço chamando uma api de terceiros, deixamos o contrato entre service e repository pronto, aos poucos estamos deixando nossa api mais completa e robusta.</p>
<p>Agora temos uma newsletter, se inscreva e receba um aviso quando sair novos posts, <a href="https://wiliamvj.substack.com/">se inscrever</a></p>
<h2 id="próximos-passos">Próximos passos</h2>
<p>Na parte 5 vamos partir para a autenticação do usuário, protegendo as rotas da nossa aplicação, criando um service separado para lidar com a criação do token JWT, vamos adicionar um middleware personalizado para capturar log de cada chamada http pegando dados do usuário.</p>
<h2 id="link-do-repositório">Link do repositório</h2>
<p><a href="https://github.com/wiliamvj/api-users-golang">repositório</a> do projeto</p>
<p><a href="https://github.com/egonelbre/gophers">Gopher credits</a></p>
</section>

  
    
  
    <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="wiliamvj/wiliamvj.com"
      data-repo-id="R_kgDOKqMPTA"
      data-category="General"
      data-category-id="DIC_kwDOKqMPTM4CbzWf"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="dark"
      data-lang="en"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    >
    </script>
</div>
  

    
  


  <footer>
    
  </footer>
</article>

</main><footer class="pt-5 pb-6 lg:grid lg:gap-3 lg:grid-cols-2">
  <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2024 —
  <a href="//localhost:1313/">Wiliam V. Joaquim</a>
  <span class="font-normal">with</span>
  <a
    href="https://github.com/nixentric/Lowkey-Hugo-Theme"
    target="_blank"
    rel="noopener noreferrer"
  >
    Lowkey
  </a>
</div>
 <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
     
    <li>
      <a href="https://www.linkedin.com/in/wiliamvj/" target="_blank" rel="noopener noreferrer"
        >linkedin</a
      >
    </li>
    
    <li>
      <a href="https://twitter.com/wiliamjoaquim" target="_blank" rel="noopener noreferrer"
        >x</a
      >
    </li>
    
    <li>
      <a href="https://github.com/wiliamvj" target="_blank" rel="noopener noreferrer"
        >github</a
      >
    </li>
    
    <li>
      <a href="https://dev.to/wiliamvj" target="_blank" rel="noopener noreferrer"
        >dev.to</a
      >
    </li>
     
  </ul>
</div>

</footer>
</body>
</html>
