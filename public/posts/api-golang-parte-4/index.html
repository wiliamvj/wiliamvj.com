<!DOCTYPE html>
<html lang="pt" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script> 

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>API completa em Golang - Parte 4</title>
<meta name="description" content="O que vamos fazer? Na parte 4 do nosso crud, vamos fazer a l√≥gica do nosso service de usu√°rio.">
<link rel="canonical" href="http://localhost:1313/posts/api-golang-parte-4/">
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto">
    <div class="header">
      <header
  class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 sm:py-12"
>
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hucbf2afd9e62dc6021c155b0731b41164_625734_80x80_fill_q90_box_smart1.jpg 80w"
      src="/img/profile-picture.jpg"
      width="1080"
      height="1080"
      alt="Wiliam V. Joaquim"
    />
  </a>
</div>


  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Wiliam V. Joaquim</h1>
</a>
 <nav>
  <ul class="px-4 lg:px-0">
     
    <li>
      <a
        href="/"
        class=""
      >
        Artigos
      </a>
    </li>
    
    <li>
      <a
        href="https://wiliamvj.substack.com/"
        class=""
      >
        Newsletter
      </a>
    </li>
    
    <li>
      <a
        href="/en/"
        class=""
      >
        en-US üá∫üá∏
      </a>
    </li>
    
    <li class="-mt-2 block lg:hidden"><button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme !== 'light') {
      setTheme('dark');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
</li>
  </ul>
</nav>

  </div>
</header>

      <div class="lg:inline-block hidden">
        <button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme !== 'light') {
      setTheme('dark');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>

      </div>
    </div>

    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-small">API completa em Golang - Parte 4</h2>

    <div class="meta">
      
      <time
        datetime="2023-12-21 17:54:40 -0300 -03"
        title='Thu, Dec 21, 2023, 5:54 PM -03'
      >
        21/12/2023 - Tempo estimado de leitura: 14 minutos
      </time>

       
    </div>
  </header>

  

  <section><p><img alt="thumbnail" src="/posts/api-golang-parte-4/htyf78HJsvdfczaqfg6jiopl.png"></p>
<h2 id="o-que-vamos-fazer">O que vamos fazer?</h2>
<p>Na parte 4 do nosso crud, vamos fazer a l√≥gica do nosso service de usu√°rio.</p>
<p>Se ainda n√£o viu os posts anteriores leia eles primeiro.</p>
<p><a href="/posts/api-golang-parte-1/">parte 1</a> |
<a href="/posts/api-golang-parte-2/">parte 2</a> |
<a href="/posts/api-golang-parte-3/">parte 3</a> |</p>
<h2 id="criando-nossas-entidades">Criando nossas entidades</h2>
<p>Vamos primeiro criar nossa entidade de usu√°rio, essa entidade vai ser uma representa√ß√£o dos dados do usu√°rio no banco de dados, a entidade vai ser o que vamos retornar do nosso repository, dessa forma n√£o vamos depender da tipagem geradao pelo sqlc. Precisamos criar nessa etapa para poder deixar o contrato entre <code>service</code> e <code>repository</code> definidos.</p>
<p>Crie um arquivo na pasta <strong>entity</strong> chamado <code>user_entity.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserEntity <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    ID        <span style="color:#8be9fd">string</span>    <span style="color:#f1fa8c">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>    Name      <span style="color:#8be9fd">string</span>    <span style="color:#f1fa8c">`json:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>    Email     <span style="color:#8be9fd">string</span>    <span style="color:#f1fa8c">`json:&#34;email&#34;`</span>
</span></span><span style="display:flex;"><span>    Password  <span style="color:#8be9fd">string</span>    <span style="color:#f1fa8c">`json:&#34;password,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    CreatedAt time.Time <span style="color:#f1fa8c">`json:&#34;created_at&#34;`</span>
</span></span><span style="display:flex;"><span>    UpdatedAt time.Time <span style="color:#f1fa8c">`json:&#34;updated_at&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Por hora essa ser√£o os dados da entidade user.</p>
<h2 id="contrato-entre-service-e-repository">Contrato entre service e repository</h2>
<p>Ainda n√£o vamos trabalhar no service, mas precisamos definir o contrato para deixar nosso service caminhando sem o repository estar pronto, os contratos nos ajudam com isso, esse desacoplamento permite mais liberdade de avan√ßar sem precisar implementar outras partes da aplica√ß√£o, podemos inclusive adiar a escolha do banco de dados a ser utilizado, mas poder√≠amos tranquilamente finalizar todo o resto da aplica√ß√£o.</p>
<p>Vamos criar nossas interfaces no <code>user_interface_repository.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NewUserRepository</span>(db <span style="color:#ff79c6">*</span>sql.DB, q <span style="color:#ff79c6">*</span>sqlc.Queries) UserRepository {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>repository{
</span></span><span style="display:flex;"><span>      db,
</span></span><span style="display:flex;"><span>      q,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> repository <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    db      <span style="color:#ff79c6">*</span>sql.DB
</span></span><span style="display:flex;"><span>    queries <span style="color:#ff79c6">*</span>sqlc.Queries
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserRepository <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">CreateUser</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>entity.UserEntity) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindUserByEmail</span>(ctx context.Context, email <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindUserByID</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdateUser</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>entity.UserEntity) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">DeleteUser</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindManyUsers</span>(ctx context.Context) ([]entity.UserEntity, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdatePassword</span>(ctx context.Context, pass, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Por enquanto esses ser√£o o m√©todos que vamos utilizar para o usu√°rio, sempre que precisamos retornamos nossa entidade, no qual √© de nosso controle, como j√° mencionado, poder√≠amos remover essa abstra√ß√£o e o service chamar diretamente os m√©todos e tipagem gerados pelo sqlc, mas ficamos amarrados ao sqlc, dessa forma ficaria mais tranquilo remover o sqlc caso fosse necess√°rio.</p>
<p>Implementando o <code>UserRepository</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">CreateUser</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>entity.UserEntity) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">FindUserByEmail</span>(ctx context.Context, email <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">FindUserByID</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">UpdateUser</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>entity.UserEntity) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">DeleteUser</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">FindManyUsers</span>(ctx context.Context) ([]entity.UserEntity, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">UpdatePassword</span>(ctx context.Context, pass, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Como n√£o vamos trabalhar nessa camada agora, apenas implemente o contrato para o Go parar de acusar o erro.</p>
<h2 id="implementando-o-service">Implementando o service</h2>
<p>Agora vamos partir para a nossa regra de neg√≥cio, o service √© a camada mais importante, nela que vamos definir o comportamento da nossa aplica√ß√£o, no handler apenas tratamos a entrada do dado, n√£o manipulamos nada, e o repository vai servir apenas para persistir e buscar dados no banco.</p>
<h3 id="criando-o-usu√°rio">Criando o usu√°rio</h3>
<p>Primeira coisa que precisamos fazer √© verificar se o e-mail do usu√°rio que vamos cadastrar j√° existe no banco, pois nosso campo de e-mail no banco ser√° √∫nico</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  userExists, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByEmail</span>(ctx, u.Email)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by email&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> userExists <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Se a busca do usu√°rio por e-mail retornar um erro, retornamos esse erro, se o <code>userExists</code> for diferente de nil, significa que encontrou um usu√°rio, ent√£o n√£o podemos deixar prosseguir, retornamos um novo erro <code>errors.New(&quot;user already exists&quot;)</code>, ainda vamos tratar esse erro no handler e retornar um status code correto.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  passwordEncrypted, err <span style="color:#ff79c6">:=</span> bcrypt.<span style="color:#50fa7b">GenerateFromPassword</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(u.Password), <span style="color:#bd93f9">12</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to encrypt password&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;error to encrypt password&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Agora vamos precisar encriptar a senha do usu√°rio, usando o pacote nativo do Go chamado <a href="https://pkg.go.dev/golang.org/x/crypto@v0.13.0/bcrypt">bcrypt</a>, transformamos a senha do usu√°rio que est√° no <code>u.Password</code> em um slice de bytes e informamos que a for√ßa da encripta√ß√£o da senha √© 12, por padr√£o o <code>DefaultCost</code> √© 10, quanto maior esse n√∫mero mais forte √© sua encripta√ß√£o, o m√°ximo aceito √© 31, lembrando que encriptar tem um custo computacional, quanto maior esse n√∫mero mais tempo vai levar.</p>
<p>Por curiosidade usando o valor 12 demora cerca de 100ms (Milissegundo) para encriptar, colocando 31 demora cerca de 7 minutos, claro que depende do hardware que est√° fazendo isso, mas a diferen√ßa de tempo √© muito grande. Por padr√£o o uso comum usamos entre 10 e 14.</p>
<p>Agora vamos transformar os dados recebido para a nossa estrutura do <code>UserEntity</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  newUser <span style="color:#ff79c6">:=</span> entity.UserEntity{
</span></span><span style="display:flex;"><span>    ID:        uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>(),
</span></span><span style="display:flex;"><span>    Name:      u.Name,
</span></span><span style="display:flex;"><span>    Email:     u.Email,
</span></span><span style="display:flex;"><span>    Password:  <span style="color:#8be9fd;font-style:italic">string</span>(passwordEncrypted),
</span></span><span style="display:flex;"><span>    CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>    UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Para criar o id do tipo uuid usamos o <a href="https://pkg.go.dev/github.com/google/uuid@v1.1.2">pacote da google</a> o mesmo que usamos para validar um uuid no handler. Outra vantagem de remover a responsabilidade da cria√ß√£o do id do banco de dados, √© que agora j√° sabemos o id do desse usu√°rio sem salvar no banco, isso tem in√∫meras vantagem.</p>
<p>Por fim vamos chamar nosso repository e salvar o usu√°rio no banco:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  err = s.repo.<span style="color:#50fa7b">CreateUser</span>(ctx, <span style="color:#ff79c6">&amp;</span>newUser)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to create user&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Apenas isso √© suficiente para criar um usu√°rio, ainda vamos adicionar o endere√ßo do usu√°rio ainda na parte 4, e vamos alterar o <code>CreateUser</code>.</p>
<h3 id="atualizando-o-usu√°rio">Atualizando o usu√°rio</h3>
<p>Vai ser parecido com a cria√ß√£o, mas primeiro vamos verificar se o usu√°rio existe pelo id:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  userExists, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByID</span>(ctx, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by id&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> userExists <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>A l√≥gica inverte, na cria√ß√£o se o <code>userExists</code> for diferente de <code>nil</code> retornamos um erro, no update se o <code>userExists</code> for igual a <code>nil</code>, retornamos um erro, pois significa que n√£o encontramos o usu√°rio que o client que atualizar.</p>
<p>Tem um detalhe, caso o e-mail seja informado:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> u.Email <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>    verifyUserEmail, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByEmail</span>(ctx, u.Email)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by email&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> verifyUserEmail <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Caso o client precise atualizar o e-mail, antes precisamos verificar se o novo e-mail n√£o est√° sendo utilizado por outro usu√°rio, fazemos isso no c√≥digo acima.</p>
<p>Por fim, vamos passar tudo isso para a struct <code>UserEntity</code> e chamar nosso repository:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  updateUser <span style="color:#ff79c6">:=</span> entity.UserEntity{
</span></span><span style="display:flex;"><span>    ID:        id,
</span></span><span style="display:flex;"><span>    Name:      u.Name,
</span></span><span style="display:flex;"><span>    Email:     u.Email,
</span></span><span style="display:flex;"><span>    UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  err = s.repo.<span style="color:#50fa7b">UpdateUser</span>(ctx, <span style="color:#ff79c6">&amp;</span>updateUser)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to update user&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><p>E retornamos <code>nil</code> se todo ocorrer corretamente, perceba que na cria√ß√£o, atualiza√ß√£o, deletar usu√°rio retornamos sempre <code>nil</code>, na nossa aplica√ß√£o n√£o tem sentido retornar dados para o cliente, pois s√£o os mesmos dados que acabamos de receber do client, mas existem casos que faz sentido retornar ap√≥s nossa api processar os dados, tudo depende da sua regra.</p>
<h3 id="detalhes-do-usu√°rio">Detalhes do usu√°rio</h3>
<p>Vamos buscar os dados do usu√°rio pelo id.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span> userExists, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByID</span>(ctx, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by id&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> userExists <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Mesma l√≥gica que j√° fizemos acima, por√©m agora nosso service <code>GetUserByID</code> retorna um <code>*response.UserResponse</code>, ent√£o precisamos passar nosso <code>UserEntity</code> retornado pelo repository para <code>UserResponse</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  user <span style="color:#ff79c6">:=</span> response.UserResponse{
</span></span><span style="display:flex;"><span>    ID:        userExists.ID,
</span></span><span style="display:flex;"><span>    Name:      userExists.Name,
</span></span><span style="display:flex;"><span>    Email:     userExists.Email,
</span></span><span style="display:flex;"><span>    CreatedAt: userExists.CreatedAt,
</span></span><span style="display:flex;"><span>    UpdatedAt: userExists.UpdatedAt,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>user, <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><p>E pronto, isso √© o suficiente!</p>
<h3 id="deletando-o-usu√°rio">Deletando o usu√°rio</h3>
<p>Essa deve ser a mais simples de todas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  userExists, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByID</span>(ctx, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by id&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> userExists <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  err = s.repo.<span style="color:#50fa7b">DeleteUser</span>(ctx, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to delete user&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><p>Apenas verificamos se o usu√°rio existe e depois chamamos o repository.</p>
<h3 id="listar-todos-os-usu√°rios">Listar todos os usu√°rios</h3>
<p>Esse met√≥do tamb√©m √© bem simples.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  findManyUsers, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindManyUsers</span>(ctx)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to find many users&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  users <span style="color:#ff79c6">:=</span> response.ManyUsersResponse{}
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> _, user <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> findManyUsers {
</span></span><span style="display:flex;"><span>    userResponse <span style="color:#ff79c6">:=</span> response.UserResponse{
</span></span><span style="display:flex;"><span>      ID:        user.ID,
</span></span><span style="display:flex;"><span>      Name:      user.Name,
</span></span><span style="display:flex;"><span>      Email:     user.Email,
</span></span><span style="display:flex;"><span>      CreatedAt: user.CreatedAt,
</span></span><span style="display:flex;"><span>      UpdatedAt: user.UpdatedAt,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    users.Users = <span style="color:#8be9fd;font-style:italic">append</span>(users.Users, userResponse)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>users, <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><p>Como nosso repository retorna um slice do <code>[]entity.UserEntity</code>, precisamos fazer um loop e transformar em <code>response.ManyUsersResponse</code>, √© o que fazemos acima.</p>
<h3 id="alterando-a-senha">Alterando a senha</h3>
<p>Por √∫ltimo, vamos atualizar a senha.</p>
<p>Primeiro fazemos a valida√ß√£o padr√£o se o usu√°rio existe.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  userExists, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByID</span>(ctx, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by id&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> userExists <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Agora precisamos verificar se a senha que temos no banco de dados √© a mesma senha que o usu√°rio informou como sua senha antiga, que usamos no nosso dto <code>UpdateUserPasswordDto</code>, se for diferente j√° retornamos um erro:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#6272a4">// compare passwords
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  err = bcrypt.<span style="color:#50fa7b">CompareHashAndPassword</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(userExists.Password), []<span style="color:#8be9fd;font-style:italic">byte</span>(u.OldPassword))
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;invalid password&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;invalid password&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Agora vamos adicionar mais um verifica√ß√£o de seguran√ßa, para impedir que o usu√°rio troque uma senha por outra exatamente igua, mesma l√≥gica acima, mas agora comparando com a senha do banco e a nova senha que o usu√°rio informou:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#6272a4">// compare new password with password in database
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  err = bcrypt.<span style="color:#50fa7b">CompareHashAndPassword</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(userExists.Password), []<span style="color:#8be9fd;font-style:italic">byte</span>(u.Password))
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;new password is equal to old password&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;new password is equal to old password&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Por fim, vamos encriptar a nova senha do usu√°rio e salvar no banco, igual o que fizemos na cria√ß√£o do usu√°rio, por√©m criei um m√©todo apenas para salvar a senha do usu√°rio no banco:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  passwordEncrypted, err <span style="color:#ff79c6">:=</span> bcrypt.<span style="color:#50fa7b">GenerateFromPassword</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(u.Password), <span style="color:#bd93f9">12</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to encrypt password&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;error to encrypt password&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  err = s.repo.<span style="color:#50fa7b">UpdatePassword</span>(ctx, <span style="color:#8be9fd;font-style:italic">string</span>(passwordEncrypted), id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to update password&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><h2 id="melhorando-erros-do-handler">Melhorando erros do handler</h2>
<p>Nosso service retorna alguns erros que precisamos melhorar no nosso handler, como <code>&quot;user not found&quot;</code>, para isso vamos adicionar esse tratamento no <code>user_handler.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  err = h.service.<span style="color:#50fa7b">UpdateUser</span>(r.<span style="color:#50fa7b">Context</span>(), req, id)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;error to update user: %v&#34;</span>, err), slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;handler_user&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err.<span style="color:#50fa7b">Error</span>() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;user not found&#34;</span> {
</span></span><span style="display:flex;"><span>      w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusNotFound)
</span></span><span style="display:flex;"><span>      msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewNotFoundError</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>      json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusBadRequest)
</span></span><span style="display:flex;"><span>    msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewBadRequestError</span>(<span style="color:#f1fa8c">&#34;error to update user&#34;</span>)
</span></span><span style="display:flex;"><span>    json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Dentro do tratamento do erro da chamada ao service, vamos adicionar um novo <code>if</code>, caso o erro seja do tipo <code>&quot;user not found&quot;</code> retornamos um erro com no nosso <code>httperr</code> do tipo <code>NotFoundError</code>.</p>
<p>Voc√™ pode alterar essa forma de tratar os erros, para evitar ficar tratando isso no handler, como por exemplo no service retornar j√° um erro do tipo <code>*http.Request</code>, assim no handler poderia apenas retornar o erro e o service que seria respons√°vel por determinar o tipo do erro, status code e tudo mais, por√©m prefiro separar e deixar no handler a responsabilidade do http.</p>
<p>Voc√™ vai precisar colocar esse tratamento nos m√©todos do handler: <code>UpdateUser</code>, <code>GetUserByID</code>, <code>DeleteUser</code>, <code>UpdateUserPassword</code>.</p>
<h2 id="salvando-o-endere√ßo">Salvando o endere√ßo</h2>
<p>Agora vamos salvar o endere√ßo do usu√°rio, para isso vamos utilizar a api do <a href="https://viacep.com.br/">viacep</a>, vamos primeiro atualizar nosso dto <code>CreateUserDto</code> e <code>UpdateUserDto</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> CreateUserDto <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    Name     <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;name&#34; validate:&#34;required,min=3,max=30&#34;`</span>
</span></span><span style="display:flex;"><span>    Email    <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;email&#34; validate:&#34;required,email&#34;`</span>
</span></span><span style="display:flex;"><span>    Password <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;password&#34; validate:&#34;required,min=8,max=30,containsany=!@#$%*&#34;`</span>
</span></span><span style="display:flex;"><span>    CEP      <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;cep&#34; validate:&#34;required,min=8,max=8&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UpdateUserDto <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    Name  <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;name&#34; validate:&#34;omitempty,min=3,max=30&#34;`</span>
</span></span><span style="display:flex;"><span>    Email <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;email&#34; validate:&#34;omitempty,email&#34;`</span>
</span></span><span style="display:flex;"><span>    CEP   <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;cep&#34; validate:&#34;omitempty,min=8,max=8&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Adicionando o campo <code>CEP</code>, com a valida√ß√£o simples de no m√≠nimo e m√°ximo 8 caracteres, como o nosso validator <code>ValidateHttpData</code> j√° tem o case <code>min</code> e <code>max</code> n√£o precisamos fazer nada, j√° est√° funcionando a valida√ß√£o.</p>
<p>Vamos separar a chamada a api do viacep em uma fun√ß√£o, vamos criar na raiz do projeto uma pasta chamada <strong>api</strong> e dentro dela outra pasta chamada <strong>viacep</strong>, na pasta api vamos salvar todo o c√≥digo que for chamar api de terceiros, agora crie um arquivo chamado <code>viacep.go</code> dentro da pasta <strong>api/viacep</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#ff79c6">package</span> viacep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;github.com/wiliamvj/api-users-golang/config/env&#34;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> ViaCepResponse <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    CEP         <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;cep&#34;`</span>
</span></span><span style="display:flex;"><span>    Logradouro  <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;logradouro&#34;`</span>
</span></span><span style="display:flex;"><span>    Complemento <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;complemento&#34;`</span>
</span></span><span style="display:flex;"><span>    Bairro      <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;bairro&#34;`</span>
</span></span><span style="display:flex;"><span>    Localidade  <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;localidade&#34;`</span>
</span></span><span style="display:flex;"><span>    UF          <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;uf&#34;`</span>
</span></span><span style="display:flex;"><span>    IBGE        <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;ibge&#34;`</span>
</span></span><span style="display:flex;"><span>    GIA         <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;gia&#34;`</span>
</span></span><span style="display:flex;"><span>    DDD         <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;ddd&#34;`</span>
</span></span><span style="display:flex;"><span>    SIAFI       <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;siafi&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GetCep</span>(cep <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>ViaCepResponse, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    url <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s/%s/json&#34;</span>, env.Env.ViaCepURL, cep)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> viaCepResponse ViaCepResponse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    resp, err <span style="color:#ff79c6">:=</span> http.<span style="color:#50fa7b">Get</span>(url)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">defer</span> resp.Body.<span style="color:#50fa7b">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    err = json.<span style="color:#50fa7b">NewDecoder</span>(resp.Body).<span style="color:#50fa7b">Decode</span>(<span style="color:#ff79c6">&amp;</span>viaCepResponse)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> viaCepResponse.CEP <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, fmt.<span style="color:#50fa7b">Errorf</span>(<span style="color:#f1fa8c">&#34;cep not found&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>viaCepResponse, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro criamos um struct para deixar com a tipagem da resposta do viacep, depois criamos uma fun√ß√£o chamada <code>GetCep</code> que recebe uma cep do tipo string e retorna um ponteiro do <code>*ViaCepResponse</code> ou um <code>error</code>, depois montamos a url usando o <code>fmt.Sprintf</code>, o <code>ViaCepURL</code> colocamos em uma v√°riavel, voc√™ pode colocar a url diretamente se preferir, coloquei em uma env para treinar como utilizar a env com viper, precisa colocar o valor na env:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  VIA_CEP_URL=<span style="color:#f1fa8c">&#34;https://viacep.com.br/ws&#34;</span>
</span></span></code></pre></div><p>Precisamos importar usando viper na nossa <strong>config</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> config <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    GoEnv       <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;GO_ENV&#34;`</span>
</span></span><span style="display:flex;"><span>    GoPort      <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;GO_PORT&#34;`</span>
</span></span><span style="display:flex;"><span>    DatabaseURL <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;DATABASE_URL&#34;`</span>
</span></span><span style="display:flex;"><span>    ViaCepURL   <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;VIA_CEP_URL&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Depois fazemos a chamada <a href="https://pkg.go.dev/net/http">http</a> usando o pacote do Go, por fim transformamos o body recebido na nossa struct <code>ViaCepResponse</code>.</p>
<p>Precisamos agora alterar nosso entity, para adicionar o endere√ßo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserEntity <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    ID        <span style="color:#8be9fd">string</span>      <span style="color:#f1fa8c">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>    Name      <span style="color:#8be9fd">string</span>      <span style="color:#f1fa8c">`json:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>    Email     <span style="color:#8be9fd">string</span>      <span style="color:#f1fa8c">`json:&#34;email&#34;`</span>
</span></span><span style="display:flex;"><span>    Password  <span style="color:#8be9fd">string</span>      <span style="color:#f1fa8c">`json:&#34;password,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    Address   UserAddress <span style="color:#f1fa8c">`json:&#34;address,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    CreatedAt time.Time   <span style="color:#f1fa8c">`json:&#34;created_at&#34;`</span>
</span></span><span style="display:flex;"><span>    UpdatedAt time.Time   <span style="color:#f1fa8c">`json:&#34;updated_at&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserAddress <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    CEP        <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;cep&#34;`</span>
</span></span><span style="display:flex;"><span>    IBGE       <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;ibge&#34;`</span>
</span></span><span style="display:flex;"><span>    UF         <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;uf&#34;`</span>
</span></span><span style="display:flex;"><span>    City       <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;city&#34;`</span>
</span></span><span style="display:flex;"><span>    Complement <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;complement,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    Street     <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;street&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>N√£o precisamos alterar nada no nosso handler, somente no nosso service, vamos l√°! Vamos alterar somente o <code>CreateUser</code> e <code>UpdateUser</code>.</p>
<p><code>CreateUser</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  cep, err <span style="color:#ff79c6">:=</span> viacep.<span style="color:#50fa7b">GetCep</span>(u.CEP)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to get cep&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  newUser <span style="color:#ff79c6">:=</span> entity.UserEntity{
</span></span><span style="display:flex;"><span>    ID:       uuid.<span style="color:#50fa7b">New</span>().<span style="color:#50fa7b">String</span>(),
</span></span><span style="display:flex;"><span>    Name:     u.Name,
</span></span><span style="display:flex;"><span>    Email:    u.Email,
</span></span><span style="display:flex;"><span>    Password: <span style="color:#8be9fd;font-style:italic">string</span>(passwordEncrypted),
</span></span><span style="display:flex;"><span>    Address: entity.UserAddress{
</span></span><span style="display:flex;"><span>      CEP:        cep.CEP,
</span></span><span style="display:flex;"><span>      IBGE:       cep.IBGE,
</span></span><span style="display:flex;"><span>      UF:         cep.UF,
</span></span><span style="display:flex;"><span>      City:       cep.Localidade,
</span></span><span style="display:flex;"><span>      Complement: cep.Complemento,
</span></span><span style="display:flex;"><span>      Street:     cep.Logradouro,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    CreatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>    UpdatedAt: time.<span style="color:#50fa7b">Now</span>(),
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro vamos pegar o cep usando a fun√ß√£o que criamos, caso retorne um erro paramos ali, depois apenas colocamos o retorno do <code>cep</code> na struct <code>newUser</code> e pronto, isso √© suficiente.</p>
<p>O <code>UpdateUser</code> que vai ter um pouco mais de altera√ß√£o, primeiro n√£o vamos mais inicializar e j√° atribuir valor do <code>UserEntity</code> diretamente igual est√°vamos fazendo, vamos primeiro declarar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">var</span> updateUser entity.UserEntity
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> u.Email <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>    verifyUserEmail, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByEmail</span>(ctx, u.Email)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by email&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> verifyUserEmail <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user already exists&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    updateUser.Email = u.Email
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> u.CEP <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>    cep, err <span style="color:#ff79c6">:=</span> viacep.<span style="color:#50fa7b">GetCep</span>(u.CEP)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to get cep&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    updateUser.Address = entity.UserAddress{
</span></span><span style="display:flex;"><span>      CEP:        cep.CEP,
</span></span><span style="display:flex;"><span>      IBGE:       cep.IBGE,
</span></span><span style="display:flex;"><span>      UF:         cep.UF,
</span></span><span style="display:flex;"><span>      City:       cep.Localidade,
</span></span><span style="display:flex;"><span>      Complement: cep.Complemento,
</span></span><span style="display:flex;"><span>      Street:     cep.Logradouro,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro declaramos o <code>updateUser</code>, depois se tiver um e-mail dentro do if atribu√≠mos o <code>updateUser.Email = u.Email</code>, depois ao atualizar se houver um cep, entramos no if e vamos chamar a nossa fun√ß√£o <code>GetCep</code> e por fim inicializamos e atribu√≠mos o <code>updateUser.Address</code>.</p>
<p>Depois atribu√≠mos os valores finais:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  updateUser.ID = id
</span></span><span style="display:flex;"><span>  updateUser.Name = u.Name
</span></span><span style="display:flex;"><span>  updateUser.UpdatedAt = time.<span style="color:#50fa7b">Now</span>()
</span></span></code></pre></div><p>Existe v√°rias maneiras de fazer isso, essa √© a forma que acho mais simples de entender o que est√° acontecendo e o que estamos atribuindo a nosso <code>UserEntity</code>.</p>
<h2 id="melhorando-erros-do-handler-1">Melhorando erros do handler</h2>
<p>Podemos adicionar novos erros no nosso handler:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>err = h.service.<span style="color:#50fa7b">CreateUser</span>(r.<span style="color:#50fa7b">Context</span>(), req)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;error to create user: %v&#34;</span>, err), slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userhandler&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err.<span style="color:#50fa7b">Error</span>() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;cep not found&#34;</span> {
</span></span><span style="display:flex;"><span>      w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusNotFound)
</span></span><span style="display:flex;"><span>      msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewNotFoundError</span>(<span style="color:#f1fa8c">&#34;cep not found&#34;</span>)
</span></span><span style="display:flex;"><span>      json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>    msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewBadRequestError</span>(<span style="color:#f1fa8c">&#34;error to create user&#34;</span>)
</span></span><span style="display:flex;"><span>    json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Adicionamos o erro <code>&quot;cep not found&quot;</code> para novos erro do cep, adicione apenas no <code>CreateUser</code> e <code>UpdateUser</code>.</p>
<h2 id="considera√ß√µes-finais">Considera√ß√µes finais</h2>
<p>Nesse post conseguimos avan√ßar bastante a nossa api, deixamos nosso service de usu√°rio praticamente pronto, fizemos o cadastro de endere√ßo chamando uma api de terceiros, deixamos o contrato entre service e repository pronto, aos poucos estamos deixando nossa api mais completa e robusta.</p>
<p>Agora temos uma newsletter, se inscreva e receba um aviso quando sair novos posts, <a href="https://wiliamvj.substack.com/">se inscrever</a></p>
<h2 id="pr√≥ximos-passos">Pr√≥ximos passos</h2>
<p>Na parte 5 vamos partir para a autentica√ß√£o do usu√°rio, protegendo as rotas da nossa aplica√ß√£o, criando um service separado para lidar com a cria√ß√£o do token JWT, vamos adicionar um middleware personalizado para capturar log de cada chamada http pegando dados do usu√°rio.</p>
<h2 id="link-do-reposit√≥rio">Link do reposit√≥rio</h2>
<p><a href="https://github.com/wiliamvj/api-users-golang">reposit√≥rio</a> do projeto</p>
<p><a href="https://github.com/egonelbre/gophers">Gopher credits</a></p>
</section>

  
    
  
    <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="wiliamvj/wiliamvj.com"
      data-repo-id="R_kgDOKqMPTA"
      data-category="General"
      data-category-id="DIC_kwDOKqMPTM4CbzWf"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="dark"
      data-lang="en"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    >
    </script>
</div>
  

    
  


  <footer>
    
  </footer>
</article>

</main><footer class="pt-5 pb-6 lg:grid lg:gap-3 lg:grid-cols-2">
  <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  ¬© 2024 ‚Äî
  <a href="http://localhost:1313/">Wiliam V. Joaquim</a> 
  <span class="font-normal">with</span>
  <a
    href="https://github.com/nixentric/Lowkey-Hugo-Theme"
    target="_blank"
    rel="noopener noreferrer"
  >
    Lowkey
  </a>
</div>
 <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
     
    <li>
      <a href="https://www.linkedin.com/in/wiliamvj/" target="_blank" rel="noopener noreferrer"
        >linkedin</a
      >
    </li>
    
    <li>
      <a href="https://twitter.com/wiliamjoaquim" target="_blank" rel="noopener noreferrer"
        >x</a
      >
    </li>
    
    <li>
      <a href="https://github.com/wiliamvj" target="_blank" rel="noopener noreferrer"
        >github</a
      >
    </li>
    
    <li>
      <a href="https://dev.to/wiliamvj" target="_blank" rel="noopener noreferrer"
        >dev.to</a
      >
    </li>
     
  </ul>
</div>

</footer>
</body>
</html>
