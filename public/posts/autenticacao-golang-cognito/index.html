<!DOCTYPE html>
<html lang="pt" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>    
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Autenticação com Golang e AWS Cognito</title>
<meta
  name="apple-mobile-web-app-title"
  content="Autenticação com Golang e AWS Cognito"
/>
<meta
  name="description"
  content="O que é o cognito? A parte de autenticação de uma aplicação é algo muito importante do sistema, mas também muito sensível, existem diversas implementações, segurança, validações a se considerar."
/>
<link
  rel="apple-touch-icon"
  sizes="180x180"
  href="/icons/apple-touch.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="32x32"
  href="/icons/favicon-32x32.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="16x16"
  href="/icons/favicon-16x16.png"
/>
<link rel="canonical" href="//localhost:1313/posts/autenticacao-golang-cognito/" />
<link rel="robots" href="/robots.txt" />
<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />


<script
  defer
  src="https://www.googletagmanager.com/gtag/js?id=G-TG8KZ9PQBT"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-TG8KZ9PQBT');
</script>


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="//localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto">
    <div class="header">
      <header
  class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 sm:py-12"
>
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="//localhost:1313/">
    <img
      srcset="/img/profile-picture_hucbf2afd9e62dc6021c155b0731b41164_625734_80x80_fill_q90_box_smart1.jpg 80w"
      src="/img/profile-picture.jpg"
      width="1080"
      height="1080"
      alt="Wiliam V. Joaquim"
    />
  </a>
</div>


  <div class="flex flex-col gap-5">
    <a href="//localhost:1313/">
  <h1 id="site-title">Wiliam V<span class="text-wpurple">.</span> Joaquim</h1>
</a>
 <nav>
  <ul class="px-4 lg:px-0">
     
    <li>
      <a
        href="/"
        class=""
        
      >
        Artigos
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li>
      <a
        href="https://wiliamvj.substack.com/"
        class=""
         target="_blank" 
      >
        Newsletter
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li>
      <a
        href="/en/"
        class=""
        
      >
        en-US
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li class="-mt-2 block lg:hidden"><button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');
    setTheme(theme);
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      html.classList.remove('dark');
      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      html.classList.add('dark');
      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');
    const newTheme = theme === 'light' ? 'dark' : 'light';
    localStorage.setItem('theme', newTheme);
    setTheme(newTheme);
    reloadGiscus(newTheme);
  }

  function reloadGiscus(theme) {
    const existingGiscusScript = document.getElementById('giscus-script');
    if (existingGiscusScript) existingGiscusScript.remove();

    let giscusScript = document.createElement('script');
    const giscusTheme = theme === 'light' ? 'noborder_light' : 'noborder_dark';

    let giscusAttributes = {
      id: 'giscus-script',
      src: 'https://giscus.app/client.js',
      'data-repo': 'wiliamvj\/wiliamvj.com',
      'data-repo-id': 'R_kgDOLkkfgA',
      'data-category': 'General',
      'data-category-id': 'DIC_kwDOLkkfgM4CeL5M',
      'data-mapping': 'title',
      'data-strict': '0',
      'data-reactions-enabled':
        '1',
      'data-emit-metadata':
        '0',
      'data-input-position':
        'top',
      'data-theme': giscusTheme,
      'data-lang': 'en',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: '',
    };

    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.body.appendChild(giscusScript);
  }
</script>
</li>
  </ul>
</nav>

  </div>
</header>

      <div class="lg:inline-block hidden">
        <button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');
    setTheme(theme);
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      html.classList.remove('dark');
      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      html.classList.add('dark');
      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');
    const newTheme = theme === 'light' ? 'dark' : 'light';
    localStorage.setItem('theme', newTheme);
    setTheme(newTheme);
    reloadGiscus(newTheme);
  }

  function reloadGiscus(theme) {
    const existingGiscusScript = document.getElementById('giscus-script');
    if (existingGiscusScript) existingGiscusScript.remove();

    let giscusScript = document.createElement('script');
    const giscusTheme = theme === 'light' ? 'noborder_light' : 'noborder_dark';

    let giscusAttributes = {
      id: 'giscus-script',
      src: 'https://giscus.app/client.js',
      'data-repo': 'wiliamvj\/wiliamvj.com',
      'data-repo-id': 'R_kgDOLkkfgA',
      'data-category': 'General',
      'data-category-id': 'DIC_kwDOLkkfgM4CeL5M',
      'data-mapping': 'title',
      'data-strict': '0',
      'data-reactions-enabled':
        '1',
      'data-emit-metadata':
        '0',
      'data-input-position':
        'top',
      'data-theme': giscusTheme,
      'data-lang': 'en',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: '',
    };

    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.body.appendChild(giscusScript);
  }
</script>

      </div>
    </div>

    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-small">Autenticação com Golang e AWS Cognito</h2>

    <div class="meta">
      
      <time
        datetime="2024-02-07 19:03:34 -0300 -03"
        title='Wed, Feb 7, 2024, 7:03 PM -03'
      >
        Publicado em: 07/02/2024 - 15 minutos de leitura
      </time>

       
    </div>
  </header>

  


  <section><p><img alt="thumbnail" src="/posts/autenticacao-golang-cognito/thumb_esdhfkjhsd342DSF.png"></p>
<h2 id="o-que-é-o-cognito">O que é o cognito?</h2>
<p>A parte de autenticação de uma aplicação é algo muito importante do sistema, mas também muito sensível, existem diversas implementações, segurança, validações a se considerar.</p>
<p>Pensando nisso abordar um pouco sobre o <a href="https://aws.amazon.com/pt/pm/cognito/">Cognito</a>, uma ferramenta muito bacana da AWS que pode ajudar você na parte de autenticação e validação do usuário para aplicações web e mobile e que muitas pessoas não conhecem.</p>
<p>O Cognito é uma plataforma da aws responsável por armazenar e validar dados de acesso de usuários, com o cognito você consegue cadastrar usuário e armazenar suas informações, além de gerar tokens do tipo OAuth o cognito também consegue prover toda a validação de usuários.</p>
<p>Conseguimos armazenar alguns dados do usuário como: email, name, phone, birthdate, nickname, gender, website e muitos outros, também conseguimos colocar campos personalizados.</p>
<p>O cognito ainda nos permite trabalhar com &ldquo;provedores federados&rdquo;, conhecidos como login social, como Google, Facebook e GitHub, não vamos abordar nesse post, mas é possível de fazer com o cognito.</p>
<h2 id="o-que-vamos-vamos-fazer">O que vamos vamos fazer</h2>
<p>Vamos fazer alguns endpoints para mostrar como o cognito funciona, vamos criar um usuário, confirmar e-mail, login, buscar um usuário usando o token fornecido pelo cognito, atualização de senha.</p>
<h2 id="configurando-o-projeto">Configurando o projeto</h2>
<p>Vamos fazer algo bem simples, não vamos nos preocupar com padrão de projeto, queremos abordar apenas o uso do cognito.</p>
<p>Para criar os endpoints vamos utilizar o <a href="https://github.com/gin-gonic/gin">gin</a>.</p>
<p>Vamos criar os seguintes arquivos:</p>
<ul>
<li>
<p>O entrypoint da nossa aplicação <code>main.go</code> na raiz do projeto</p>
</li>
<li>
<p><code>.env</code> Para salvar as credencias do cognito</p>
</li>
<li>
<p>Uma pasta chamada <strong>cognitoClient</strong> e dentro um arquivo chamado <code>cognito.go</code></p>
</li>
<li>
<p>E um arquivo chamado <code>request.http</code>, para fazer as requisições</p>
</li>
</ul>
<p>A estrutura vai ficar assim:</p>
<p><img alt="project struct" src="/posts/autenticacao-golang-cognito/DfpSdfoasfsdf435fdg435f.png"></p>
<h2 id="configurando-o-cognito-na-aws">Configurando o cognito na AWS</h2>
<p>Antes de iniciar o código, vamos configurar o cognito na AWS, para isso acesse o painel e busque por cognito, depois disso vamos criar nosso pool, selecione a opção <strong>Add user directories to your app</strong>.</p>
<p>Para o <strong>Provider types</strong> selecione a opção <strong>Cognito user pool</strong>, você pode optar por permitir login usando e-mail, user name e telefone, vou optar apenas por e-mail, selecione o que preferir, vai ficar assim a primeira etapa:</p>
<p><img alt="cognito configuration step 1" src="/posts/autenticacao-golang-cognito/sdffghj456FG234fdgdsgdfgDfg.png"></p>
<p>É preciso configurar mais algumas coisas, vamos lá!</p>
<ul>
<li>O <strong>Password policy mode</strong> permite que você escolhe uma politica de senha, vamos deixar o <strong>Cognito defaults</strong>.</li>
<li>O <strong>Multi-factor authentication</strong> permite que nosso login tenhao autentiação de dois fatores, vamos deixar sem, mas você pode implementar se deseja, vou optar por <strong>No MFA</strong>.</li>
<li>Por fim, o <strong>User account recovery</strong>, você pode escolher formas de recuperar a conta, vou escolher apenas e-mail.</li>
</ul>
<p><img alt="cognito configuration step 2.1" src="/posts/autenticacao-golang-cognito/sdf5fghfghf-part-1.png"></p>
<p><img alt="cognito configuration step 2.2" src="/posts/autenticacao-golang-cognito/ssdf798HGJdfg-part-2.png"></p>
<p>Próxima etapa:</p>
<ul>
<li><strong>Self-service sign-up</strong>, vamos permitir que qualquer pessoa possa fazer uma conta, deixe selecionado.</li>
<li><strong>Cognito-assisted verification and confirmation</strong>, permita que o cognito se responsabilize por confirmar a identidade do usuário, deixe marcado, e também seleciona a opção <strong>Send email message, verify email address</strong>.</li>
<li><strong>Verifying attribute changes</strong>, deixe marcado essa opção, para que ao atualizar o e-mail do usuário seja necessário validar novamente.</li>
<li><strong>Required attributes</strong>, selecione os campos que deseja tornar obrigatórios para criar um novo usuário, vou deixar as opções, email (já é obrigatório) e name, a senha também já é obrigatório por padrão.</li>
<li><strong>Custom attributes</strong>, é opcional, mas você pode adicionar campos personalizados, para exemplo, vou criar um campo chamado <code>custom_id</code> que vai ser um <code>uuid</code> qualquer.</li>
</ul>
<p>Ficou assim essa etapa:</p>
<p><img alt="cognito configuration step 2.3" src="/posts/autenticacao-golang-cognito/sdfsdfsdfsdfsdhfgYT4-part-1.png"></p>
<p><img alt="cognito configuration step 2.4" src="/posts/autenticacao-golang-cognito/sdfsdfsdfsdfsdhfgYT4-part-2.png"></p>
<p><img alt="cognito configuration step 2.5" src="/posts/autenticacao-golang-cognito/sdfsdfsdfsdfsdhfgYT4-part-3.png"></p>
<p>Seguindo, selecione a opção <strong>Send email with Cognito</strong>, assim não precisamos configurar nada para disparar os e-mails.</p>
<p>Na próxima etapa, em <strong>User pool name</strong> coloque o nome que desejar em <strong>App client name</strong>, coloque também o nome que desejar e prossiga.</p>
<p>Na última etapa não vamos precisar alterar nada, basta finalizar e criar o user pool.</p>
<p>Com tudo feito, acesse o cognito &gt; User pools, selecione o pool que acabou de criar, nessa parte vai ficar listado todos os usuários da sua aplicação, sendo possível revogar token do usuário, desativar, verificar entre outras funcionalidades.</p>
<p>Vamos precisar do id do pool, para poder utilizar o <a href="https://aws.amazon.com/pt/developer/tools/">sdk do Go</a> para a aws, para isso acesse o pool criado <strong>App integration</strong> &gt; <strong>App client list</strong> e vai ver o nosso <strong>Client ID</strong>:</p>
<p><img alt="cognito client id" src="/posts/autenticacao-golang-cognito/asdfgh567Hfh.png"></p>
<p>Vamos salvar esse id no nosso arquivo <code>.env</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>COGNITO_CLIENT_ID=client_id
</span></span></code></pre></div><p>Lembrando que ainda é necessário ter as credencias da aws, geralmente fica dentro do diretório <code>/Users/seu-usuário/.aws</code>, caso não tenha configurado ainda, veja <a href="https://docs.aws.amazon.com/pt_br/cli/latest/userguide/cli-chap-configure.html">aqui</a> como fazer.</p>
<h2 id="implementando-o-cognito">Implementando o cognito</h2>
<p>Vamos separar a parte do cognito em outro arquivo.</p>
<h3 id="cadastrando-o-usuário">Cadastrando o usuário</h3>
<p>Dentro do arquivo <code>cognito.go</code>, vamos inicializar nosso cognito e criar nossa interface:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#ff79c6">package</span> congnitoClient
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;github.com/aws/aws-sdk-go/aws&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;github.com/aws/aws-sdk-go/aws/session&#34;</span>
</span></span><span style="display:flex;"><span>    cognito <span style="color:#f1fa8c">&#34;github.com/aws/aws-sdk-go/service/cognitoidentityprovider&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;github.com/google/uuid&#34;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> User <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    Name     <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;name&#34; binding:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span>    Email    <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;email&#34; binding:&#34;required,email&#34;`</span>
</span></span><span style="display:flex;"><span>    Password <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;password&#34; binding:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> CognitoInterface <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SignUp</span>(user <span style="color:#ff79c6">*</span>User) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> cognitoClient <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    cognitoClient <span style="color:#ff79c6">*</span>cognito.CognitoIdentityProvider
</span></span><span style="display:flex;"><span>    appClientID   <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NewCognitoClient</span>(appClientId <span style="color:#8be9fd">string</span>) CognitoInterface {
</span></span><span style="display:flex;"><span>    config <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>aws.Config{Region: aws.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;us-east-1&#34;</span>)}
</span></span><span style="display:flex;"><span>    sess, err <span style="color:#ff79c6">:=</span> session.<span style="color:#50fa7b">NewSession</span>(config)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">panic</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    client <span style="color:#ff79c6">:=</span> cognito.<span style="color:#50fa7b">New</span>(sess)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>cognitoClient{
</span></span><span style="display:flex;"><span>      cognitoClient: client,
</span></span><span style="display:flex;"><span>      appClientID:   appClientId,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (c <span style="color:#ff79c6">*</span>cognitoClient) <span style="color:#50fa7b">SignUp</span>(user <span style="color:#ff79c6">*</span>User) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro criamos uma struct chamada <code>User</code>, essa struct vai ter os campos do usuário que precisamos para salvar no cognito.</p>
<p>Depois criamos uma <code>interface</code> chamada <code>CognitoInterface</code>, vamos ter os métodos que vamos usar, primeiramente teremos apenas o <code>SignUp</code> que vai receber um ponteiro da struct <code>User</code>.</p>
<p>Depois teremos outra struct chamada <code>cognitoClient</code> que vai conter nossa instância para o <code>NewCognitoClient</code> que vai ser nosso construtor.</p>
<p>Como mencionando o <code>NewCognitoClient</code> vai ser como se fosse nosso construtor, é nele que vamos fazer a sessão com a aws e retornar essa conexão. Essa conexão poderia se uma variável global, no nosso caso não vamos fazer isso, vai de você verificar qual a melhor abordagem para o seu caso de uso.</p>
<p>Agora vamos implementar o <code>SignUp</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (c <span style="color:#ff79c6">*</span>cognitoClient) <span style="color:#50fa7b">SignUp</span>(user <span style="color:#ff79c6">*</span>User) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    userCognito <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>cognito.SignUpInput{
</span></span><span style="display:flex;"><span>      ClientId: aws.<span style="color:#50fa7b">String</span>(c.appClientID),
</span></span><span style="display:flex;"><span>      Username: aws.<span style="color:#50fa7b">String</span>(user.Email),
</span></span><span style="display:flex;"><span>      Password: aws.<span style="color:#50fa7b">String</span>(user.Password),
</span></span><span style="display:flex;"><span>      UserAttributes: []<span style="color:#ff79c6">*</span>cognito.AttributeType{
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          Name:  aws.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;name&#34;</span>),
</span></span><span style="display:flex;"><span>          Value: aws.<span style="color:#50fa7b">String</span>(user.Name),
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          Name:  aws.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;email&#34;</span>),
</span></span><span style="display:flex;"><span>          Value: aws.<span style="color:#50fa7b">String</span>(user.Email),
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          Name:  aws.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;custom:custom_id&#34;</span>),
</span></span><span style="display:flex;"><span>          Value: aws.<span style="color:#50fa7b">String</span>(uuid.<span style="color:#50fa7b">NewString</span>()),
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    _, err <span style="color:#ff79c6">:=</span> c.cognitoClient.<span style="color:#50fa7b">SignUp</span>(userCognito)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Vamos usar o <code>AttributeType</code> do cognito para montar os parâmetros que vamos enviar para o <code>SignUp</code> do sdk da aws, repare que o <code>custom_id</code> que é o nosso campo personalizado, precisa que coloque o <code>custom</code> antes, sem isso não vai ser aceito, apenas criamos um uuid com o pacote do google, esse campo é apenas para mostrar como utilizar atributos personalizados.</p>
<p>O campo <code>ClientId</code> é referente ao <code>COGNITO_CLIENT_ID</code> da nossa env, vamos repassar quando for iniciar o <code>main.go</code>.</p>
<p>Isso é o que precisamos para salvar o usuário, simples não é?</p>
<p>Não se esqueça de iniciar o projeto com com:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  go mod init &lt;nome <span style="color:#ff79c6">do</span> seu projeto&gt;
</span></span></code></pre></div><p>E instalar os pacotes necessários:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  go mod tidy
</span></span></code></pre></div><h3 id="confirmando-a-conta">Confirmando a conta</h3>
<p>Vamos criar outra função para verificar a conta do usuário via e-mail, para verificar a conta o usuário vai precisar informar o código enviado por e-mail, vamos criar uma nova struct e adicionar o novo método <code>ConfirmAccount</code> na interface:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserConfirmation <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    Email <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;email&#34; binding:&#34;required,email&#34;`</span>
</span></span><span style="display:flex;"><span>    Code  <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;code&#34; binding:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> CognitoInterface <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SignUp</span>(user <span style="color:#ff79c6">*</span>User) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">ConfirmAccount</span>(user <span style="color:#ff79c6">*</span>UserConfirmation) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Agora vamos implementar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (c <span style="color:#ff79c6">*</span>cognitoClient) <span style="color:#50fa7b">ConfirmAccount</span>(user <span style="color:#ff79c6">*</span>UserConfirmation) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    confirmationInput <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>cognito.ConfirmSignUpInput{
</span></span><span style="display:flex;"><span>      Username:         aws.<span style="color:#50fa7b">String</span>(user.Email),
</span></span><span style="display:flex;"><span>      ConfirmationCode: aws.<span style="color:#50fa7b">String</span>(user.Code),
</span></span><span style="display:flex;"><span>      ClientId:         aws.<span style="color:#50fa7b">String</span>(c.appClientID),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    _, err <span style="color:#ff79c6">:=</span> c.cognitoClient.<span style="color:#50fa7b">ConfirmSignUp</span>(confirmationInput)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>É bem simples, vamos utilizar o <code>ConfirmSignUpInput</code> do pacote cognito para montar os parâmetros, lembrando que o <code>Username</code> é o e-mail do usuário. Por último vamos chamar o <code>ConfirmSignUp</code> passando o <code>confirmationInput</code>.</p>
<p>Lembrando que apenas retornamos o erro, você poderia aprimorar e verificar os tipos de mensagem de erro.</p>
<h3 id="login">Login</h3>
<p>Esse deve ser a funcionalidade que mais vai ser utilizada, vamos criar um método chamado <code>SignIn</code> e uma struct:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserLogin <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    Email    <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;email&#34; binding:&#34;required,email&#34;`</span>
</span></span><span style="display:flex;"><span>    Password <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;password&#34; binding:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> CognitoInterface <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SignUp</span>(user <span style="color:#ff79c6">*</span>User) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">ConfirmAccount</span>(user <span style="color:#ff79c6">*</span>UserConfirmation) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SignIn</span>(user <span style="color:#ff79c6">*</span>UserLogin) (<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Nosso <code>SignIn</code> vai receber um <code>UserLogin</code>.</p>
<p>Vamos implementar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (c <span style="color:#ff79c6">*</span>cognitoClient) <span style="color:#50fa7b">SignIn</span>(user <span style="color:#ff79c6">*</span>UserLogin) (<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    authInput <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>cognito.InitiateAuthInput{
</span></span><span style="display:flex;"><span>      AuthFlow: aws.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;USER_PASSWORD_AUTH&#34;</span>),
</span></span><span style="display:flex;"><span>      AuthParameters: aws.<span style="color:#50fa7b">StringMap</span>(<span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;USERNAME&#34;</span>: user.Email,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;PASSWORD&#34;</span>: user.Password,
</span></span><span style="display:flex;"><span>      }),
</span></span><span style="display:flex;"><span>      ClientId: aws.<span style="color:#50fa7b">String</span>(c.appClientID),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    result, err <span style="color:#ff79c6">:=</span> c.cognitoClient.<span style="color:#50fa7b">InitiateAuth</span>(authInput)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">*</span>result.AuthenticationResult.AccessToken, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Vamos utilizar o função <code>InitiateAuth</code> do pacote cognito da aws, precisamos passar o <code>username</code> (e-mail do usuário), <code>password</code> e o <code>AuthFlow</code>, esse campo se refere ao tipo de acesso que vamos permitir, no nosso caso o <code>USER_PASSWORD_AUTH</code>.</p>
<blockquote>
<p>Caso receba algum erro do tipo:</p>
</blockquote>
<blockquote>
<p><code>You trusted all proxies, this is NOT safe. We recommend you to set a value</code></p>
</blockquote>
<p>Será necessário habilitar o flow <code>ALLOW_USER_PASSWORD_AUTH</code>, para configurar acesse o cognito no painel da aws, vá em:</p>
<p><strong>User pools</strong> &gt; <strong>Selecione seu pool</strong> &gt; <strong>App integration</strong> &gt; <strong>App client list</strong> &gt; <strong>Selecione um client</strong>, vai abrir esse tela:</p>
<p><img alt="cognito flow 1" src="/posts/autenticacao-golang-cognito/sdfbfg78F34dfg.png"></p>
<p>Clique em <strong>edit</strong> e em <strong>Authentication flows</strong> selecione a opção <strong>ALLOW_USER_PASSWORD_AUTH</strong> depois salve, com isso você já pode fazer login com senha e e-mail do usuário.</p>
<h3 id="listando-um-usuário">Listando um usuário</h3>
<p>Para mostrar como utilizar o token jwt fornecido pelo cognito vamos criar um endpoint que mostra os dados do usuário salvos no cognito apenas com o token.</p>
<p>Vamos criar outra função chamada <code>GetUserByToken</code> que vai receber um token e vai retornar uma struct do tipo <code>GetUserOutput</code> que vamos pegar do pacote do cognito.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> CognitoInterface <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SignUp</span>(user <span style="color:#ff79c6">*</span>User) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">ConfirmAccount</span>(user <span style="color:#ff79c6">*</span>UserConfirmation) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SignIn</span>(user <span style="color:#ff79c6">*</span>UserLogin) (<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">GetUserByToken</span>(token <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>cognito.GetUserOutput, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Se clicar no <code>GetUserOutput</code> vai ver o que tem dentro dessa struct</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> GetUserOutput <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    _ <span style="color:#8be9fd;font-style:italic">struct</span>{} <span style="color:#f1fa8c">`type:&#34;structure&#34;`</span>
</span></span><span style="display:flex;"><span>    MFAOptions []<span style="color:#ff79c6">*</span>MFAOptionType <span style="color:#f1fa8c">`type:&#34;list&#34;`</span>
</span></span><span style="display:flex;"><span>    PreferredMfaSetting <span style="color:#ff79c6">*</span><span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`type:&#34;string&#34;`</span>
</span></span><span style="display:flex;"><span>    UserAttributes []<span style="color:#ff79c6">*</span>AttributeType <span style="color:#f1fa8c">`type:&#34;list&#34; required:&#34;true&#34;`</span>
</span></span><span style="display:flex;"><span>    UserMFASettingList []<span style="color:#ff79c6">*</span><span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`type:&#34;list&#34;`</span>
</span></span><span style="display:flex;"><span>    Username <span style="color:#ff79c6">*</span><span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`min:&#34;1&#34; type:&#34;string&#34; required:&#34;true&#34; sensitive:&#34;true&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>dentro da <code>_ struct{}</code> vai atributos personalizados que criamos para o nosso usuário, no nosso caso o <code>custom_id</code>.</p>
<p>Vamos implementar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (c <span style="color:#ff79c6">*</span>cognitoClient) <span style="color:#50fa7b">GetUserByToken</span>(token <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>cognito.GetUserOutput, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    input <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>cognito.GetUserInput{
</span></span><span style="display:flex;"><span>      AccessToken: aws.<span style="color:#50fa7b">String</span>(token),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    result, err <span style="color:#ff79c6">:=</span> c.cognitoClient.<span style="color:#50fa7b">GetUser</span>(input)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> result, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Utilizamos o <code>GetUser</code> do pacote cognito, ele precisa apenas de um <code>AccessToken</code> que é o token fornecido pelo próprio cognito.</p>
<h3 id="atualizando-a-senha">Atualizando a senha</h3>
<p>Por último vamos atualizar a senha do usuário para isso vamos precisar do e-mail e a nova senha, já temos a struct <code>UserLogin</code> com os campos que precisamos, vamos reaproveitar, se desejar crie uma nova apenas para essa função. Vamos criar a função <code>UpdatePassword</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> CognitoInterface <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SignUp</span>(user <span style="color:#ff79c6">*</span>User) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">ConfirmAccount</span>(user <span style="color:#ff79c6">*</span>UserConfirmation) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SignIn</span>(user <span style="color:#ff79c6">*</span>UserLogin) (<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">GetUserByToken</span>(token <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>cognito.GetUserOutput, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdatePassword</span>(user <span style="color:#ff79c6">*</span>UserLogin) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Vamos implementar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (c <span style="color:#ff79c6">*</span>cognitoClient) <span style="color:#50fa7b">UpdatePassword</span>(user <span style="color:#ff79c6">*</span>UserLogin) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    input <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>cognito.AdminSetUserPasswordInput{
</span></span><span style="display:flex;"><span>      UserPoolId: aws.<span style="color:#50fa7b">String</span>(os.<span style="color:#50fa7b">Getenv</span>(<span style="color:#f1fa8c">&#34;COGNITO_USER_POOL_ID&#34;</span>)),
</span></span><span style="display:flex;"><span>      Username:   aws.<span style="color:#50fa7b">String</span>(user.Email),
</span></span><span style="display:flex;"><span>      Password:   aws.<span style="color:#50fa7b">String</span>(user.Password),
</span></span><span style="display:flex;"><span>      Permanent:  aws.<span style="color:#50fa7b">Bool</span>(<span style="color:#ff79c6">true</span>),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    _, err <span style="color:#ff79c6">:=</span> c.cognitoClient.<span style="color:#50fa7b">AdminSetUserPassword</span>(input)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Vamos usar a função <code>AdminSetUserPassword</code> do pacote cognito, precisamos passar o e-mail do usuário e a nova senha, além disso temos que passar o <code>UserPoolId</code>, vamos colocar no arquivo <code>.env</code> o <code>COGNITO_USER_POOL_ID</code>, para buscar na aws basta acessar seu pool e copiar o <code>User pool ID</code></p>
<p><img alt="pool id" src="/posts/autenticacao-golang-cognito/sdfsdf345FGfgh567.png"></p>
<p>Também vamos passar o <code>Permanent</code>, informado que se trata de uma senha permanente, você poderia passar um <code>false</code>, assim o cognito iria criar uma senha temporário para o usuário, isso vai depender da estratégia que vai usar na sua aplicação.</p>
<h2 id="criando-a-main">Criando a main</h2>
<p>Vamos criar nosso <code>main.go</code>, vai ser nesse arquivo que vamos iniciar o cognito e criar nossas rotas.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> godotenv.<span style="color:#50fa7b">Load</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">panic</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cognitoClient <span style="color:#ff79c6">:=</span> congnitoClient.<span style="color:#50fa7b">NewCognitoClient</span>(os.<span style="color:#50fa7b">Getenv</span>(<span style="color:#f1fa8c">&#34;COGNITO_CLIENT_ID&#34;</span>))
</span></span><span style="display:flex;"><span>    r <span style="color:#ff79c6">:=</span> gin.<span style="color:#50fa7b">Default</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Server is running on port 8080&#34;</span>)
</span></span><span style="display:flex;"><span>    err = r.<span style="color:#50fa7b">Run</span>(<span style="color:#f1fa8c">&#34;:8080&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">panic</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro vamos carregar nossas envs com o pacote <a href="https://github.com/joho/godotenv">godotenv</a>, depois iniciamos nosso cognito client, passando o <code>COGNITO_CLIENT_ID</code>, que pegamos anteriormente, depois iniciamos o gin e criamos um server, isso é o suficiente.</p>
<h2 id="criando-os-endpoints">Criando os endpoints</h2>
<h3 id="criando-um-usuário">Criando um usuário</h3>
<p>Vamos criar uma função dentro do próprio arquivo <code>main.go</code>, vamos chamar de <code>CreateUser</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">CreateUser</span>(c <span style="color:#ff79c6">*</span>gin.Context, cognito congnitoClient.CognitoInterface) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> user congnitoClient.User
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> c.<span style="color:#50fa7b">ShouldBindJSON</span>(<span style="color:#ff79c6">&amp;</span>user); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;invalid json&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> cognito.<span style="color:#50fa7b">SignUp</span>(<span style="color:#ff79c6">&amp;</span>user)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;could not create use&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Algo simples, apenas convertemos o que recebemos no body para nossa struct usando o <code>ShouldBindJSON</code> do gin, depois chamamos o <code>SignUp</code> que criamos no <code>cognito.go</code>.</p>
<p>Agora vamos criar o endpoint dentro da função <code>main.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  r.<span style="color:#50fa7b">POST</span>(<span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(context <span style="color:#ff79c6">*</span>gin.Context) {
</span></span><span style="display:flex;"><span>		err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">CreateUser</span>(context, cognitoClient)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			context.<span style="color:#50fa7b">JSON</span>(http.StatusBadRequest, gin.H{<span style="color:#f1fa8c">&#34;error&#34;</span>: err.<span style="color:#50fa7b">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		context.<span style="color:#50fa7b">JSON</span>(http.StatusCreated, gin.H{<span style="color:#f1fa8c">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;user created&#34;</span>})
</span></span><span style="display:flex;"><span>	})
</span></span></code></pre></div><p>Chamamos a função que acabamos de criar <code>CreateUser</code>, se houver um erro lançamos um <code>StatusBadRequest</code>, caso tenha um sucesso um <code>StatusCreated</code>, vamos testar.</p>
<p>Vamos fazer um <code>go mod tidy</code> baixando todos os pacotes, depois vamos rodar a aplicação com <code>go run main.go</code></p>
<p>Agora podemos criar uma chamada no arquivo <code>request.http</code> e executar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">POST</span> http://localhost:8080/user <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;Name&#34;</span>: <span style="color:#f1fa8c">&#34;John Doe&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;wivobi1159@bitofee.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;SuperSenha@1234&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Se tudo estiver correto vamos receber a mensagem:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;user created&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Agora entrando no painel do cognito na aws, e acessando o pool depois os usuários, vamos ter nosso usuário lá dentro:</p>
<p><img alt="user" src="/posts/autenticacao-golang-cognito/dfsdhjkdfgsdf78yui.png"></p>
<h3 id="confirmando-um-usuário">Confirmando um usuário</h3>
<p>Repare que o usuário que criamos logo acima não está confirmado, vamos confirmar!</p>
<p>Crie uma função chamada <code>ConfirmAccount</code> no arquivo <code>main.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">ConfirmAccount</span>(c <span style="color:#ff79c6">*</span>gin.Context, cognito congnitoClient.CognitoInterface) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> user congnitoClient.UserConfirmation
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> c.<span style="color:#50fa7b">ShouldBindJSON</span>(<span style="color:#ff79c6">&amp;</span>user); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;invalid json&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> cognito.<span style="color:#50fa7b">ConfirmAccount</span>(<span style="color:#ff79c6">&amp;</span>user)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;could not confirm user&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Mesmo conceito que já usamos, convertamos o body para a struct <code>UserConfirmation</code> e repassamos ao <code>ConfirmAccount</code> do <code>cognito.go</code>.</p>
<p>Vamos criar o endpoint:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  r.<span style="color:#50fa7b">POST</span>(<span style="color:#f1fa8c">&#34;user/confirmation&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(context <span style="color:#ff79c6">*</span>gin.Context) {
</span></span><span style="display:flex;"><span>		err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">ConfirmAccount</span>(context, cognitoClient)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			context.<span style="color:#50fa7b">JSON</span>(http.StatusBadRequest, gin.H{<span style="color:#f1fa8c">&#34;error&#34;</span>: err.<span style="color:#50fa7b">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		context.<span style="color:#50fa7b">JSON</span>(http.StatusCreated, gin.H{<span style="color:#f1fa8c">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;user confirmed&#34;</span>})
</span></span><span style="display:flex;"><span>	})
</span></span></code></pre></div><p>Também é simples, só tratamos o erro e retornamos uma mensagem, vamos criar nossa chamada e testar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">POST</span> http://localhost:8080/user/confirmation <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;wivobi1159@bitofee.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;code&#34;</span>: <span style="color:#f1fa8c">&#34;363284&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Vamos receber a mensagem:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;user confirmed&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Agora acessando novamente o cognito no painel da aws, repare que o usuário está confirmado, lembrando que precisa colocar um e-mail válido, pode usar e-mail temporário para brincar, mas precisa ser válido, pois o cognito vai enviar o código de confirmação e precisa ser um código válido para confirmar com sucesso.</p>
<p><img alt="user confirmed" src="/posts/autenticacao-golang-cognito/sdfsdfpoiwoue234546GHw3FDG.png"></p>
<h3 id="login-1">Login</h3>
<p>Agora vamos criar nosso token, para isso no arquivo <code>main.go</code> crie uma função chamada <code>SignIn</code>, essa função vai retornar um erro e um token.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">SignIn</span>(c <span style="color:#ff79c6">*</span>gin.Context, cognito congnitoClient.CognitoInterface) (<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> user congnitoClient.UserLogin
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> c.<span style="color:#50fa7b">ShouldBindJSON</span>(<span style="color:#ff79c6">&amp;</span>user); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;invalid json&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    token, err <span style="color:#ff79c6">:=</span> cognito.<span style="color:#50fa7b">SignIn</span>(<span style="color:#ff79c6">&amp;</span>user)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;could not sign in&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> token, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Mesmo padrão das demais funções, convertamos o body para a struct <code>UserLogin</code> e repassamos ao <code>SignIn</code> do <code>cognito.go</code>.</p>
<p>Vamos criar o endpoint:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  r.<span style="color:#50fa7b">POST</span>(<span style="color:#f1fa8c">&#34;user/login&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(context <span style="color:#ff79c6">*</span>gin.Context) {
</span></span><span style="display:flex;"><span>		token, err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">SignIn</span>(context, cognitoClient)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			context.<span style="color:#50fa7b">JSON</span>(http.StatusBadRequest, gin.H{<span style="color:#f1fa8c">&#34;error&#34;</span>: err.<span style="color:#50fa7b">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		context.<span style="color:#50fa7b">JSON</span>(http.StatusCreated, gin.H{<span style="color:#f1fa8c">&#34;token&#34;</span>: token})
</span></span><span style="display:flex;"><span>	})
</span></span></code></pre></div><p>Agora retornamos um <code>token</code> ao usuário, vamos criar a chamada e testa:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">POST</span> http://localhost:8080/user/login <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;wivobi1159@bitofee.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;SuperSenha@1234&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Ao fazer a chamada vamos receber nosso token jwt:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;token&#34;</span>: <span style="color:#f1fa8c">&#34;token_here&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img alt="user jwt token" src="/posts/autenticacao-golang-cognito/token_dfgdfg765Kas23.png"></p>
<p>Se pegar o token jwt podemos ver o que tem dentro, usando o site <a href="https://jwt.io/">jwt.io</a>.</p>
<h3 id="listando-um-usuário-1">Listando um usuário</h3>
<p>Agora vamos listar os dados do usuário salvos no cognito apenas usando o token, para isso crie uma função chamada <code>GetUserByToken</code> no <code>main.go</code> e vamos precisar de uma struct para representar o response que vamos devolver ao usuário, vamos criar no <code>main</code> também:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserResponse <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    ID            <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>    Name          <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>    Email         <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;email&#34;`</span>
</span></span><span style="display:flex;"><span>    CustomID      <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;custom_id&#34;`</span>
</span></span><span style="display:flex;"><span>    EmailVerified <span style="color:#8be9fd">bool</span>   <span style="color:#f1fa8c">`json:&#34;email_verified&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {}
</span></span></code></pre></div><p>Agora a função:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">GetUserByToken</span>(c <span style="color:#ff79c6">*</span>gin.Context, cognito congnitoClient.CognitoInterface) (<span style="color:#ff79c6">*</span>UserResponse, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    token <span style="color:#ff79c6">:=</span> strings.<span style="color:#50fa7b">TrimPrefix</span>(c.<span style="color:#50fa7b">GetHeader</span>(<span style="color:#f1fa8c">&#34;Authorization&#34;</span>), <span style="color:#f1fa8c">&#34;Bearer &#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> token <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;token not found&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cognitoUser, err <span style="color:#ff79c6">:=</span> cognito.<span style="color:#50fa7b">GetUserByToken</span>(token)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;could not get user&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    user <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>UserResponse{}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> _, attribute <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> cognitoUser.UserAttributes {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">*</span>attribute.Name {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;sub&#34;</span>:
</span></span><span style="display:flex;"><span>        user.ID = <span style="color:#ff79c6">*</span>attribute.Value
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;name&#34;</span>:
</span></span><span style="display:flex;"><span>        user.Name = <span style="color:#ff79c6">*</span>attribute.Value
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;email&#34;</span>:
</span></span><span style="display:flex;"><span>        user.Email = <span style="color:#ff79c6">*</span>attribute.Value
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;custom:custom_id&#34;</span>:
</span></span><span style="display:flex;"><span>        user.CustomID = <span style="color:#ff79c6">*</span>attribute.Value
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;email_verified&#34;</span>:
</span></span><span style="display:flex;"><span>        emailVerified, err <span style="color:#ff79c6">:=</span> strconv.<span style="color:#50fa7b">ParseBool</span>(<span style="color:#ff79c6">*</span>attribute.Value)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>          user.EmailVerified = emailVerified
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> user, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Essa vai ser a maior função, precisamos mapear o que recebemos do cognito para a nossa struct <code>UserResponse</code>, fazemos isso com um <code>for</code> e um <code>switch</code>, claro que poderíamos aprimorar, mas para exemplificar vamos manter assim. Inclusive para mapear atributos personalizados é preciso colocar o <code>custom</code> antes, como o <code>custom:custom_id</code>.</p>
<p>Também verificamos se o usuário passou o token no header, caso não informe retornamos um erro.</p>
<p>Vamos criar o endpoint:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  r.<span style="color:#50fa7b">GET</span>(<span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(context <span style="color:#ff79c6">*</span>gin.Context) {
</span></span><span style="display:flex;"><span>		user, err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">GetUserByToken</span>(context, cognitoClient)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> err.<span style="color:#50fa7b">Error</span>() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;token not found&#34;</span> {
</span></span><span style="display:flex;"><span>				context.<span style="color:#50fa7b">JSON</span>(http.StatusUnauthorized, gin.H{<span style="color:#f1fa8c">&#34;error&#34;</span>: <span style="color:#f1fa8c">&#34;token not found&#34;</span>})
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			context.<span style="color:#50fa7b">JSON</span>(http.StatusBadRequest, gin.H{<span style="color:#f1fa8c">&#34;error&#34;</span>: err.<span style="color:#50fa7b">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		context.<span style="color:#50fa7b">JSON</span>(http.StatusOK, gin.H{<span style="color:#f1fa8c">&#34;user&#34;</span>: user})
</span></span><span style="display:flex;"><span>	})
</span></span></code></pre></div><p>Fazemos a mesma validação dos outros endpoints, porém agora verificamos o tipo do erro e caso seja do tipo <code>token not found</code> retornamos um <code>StatusUnauthorized</code>.</p>
<p>Vamos testar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/user <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>Authorization<span style="color:#ff79c6">:</span> Bearer token_jwt
</span></span></code></pre></div><p>Vamos receber o usuário:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;user&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#f1fa8c">&#34;50601dc9-7234-419a-8427-2a4bda92d33f&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;John Doe&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;wivobi1159@bitofee.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;custom_id&#34;</span>: <span style="color:#f1fa8c">&#34;cb748d09-40de-457a-af23-ed9483d69f8d&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;email_verified&#34;</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="atualizando-a-senha-1">Atualizando a senha</h3>
<p>Por último, vamos fazer a função <code>UpdatePassword</code> que vai atualizar a senha do usuário:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">UpdatePassword</span>(c <span style="color:#ff79c6">*</span>gin.Context, cognito congnitoClient.CognitoInterface) <span style="color:#8be9fd">error</span> {
</span></span><span style="display:flex;"><span>    token <span style="color:#ff79c6">:=</span> strings.<span style="color:#50fa7b">TrimPrefix</span>(c.<span style="color:#50fa7b">GetHeader</span>(<span style="color:#f1fa8c">&#34;Authorization&#34;</span>), <span style="color:#f1fa8c">&#34;Bearer &#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> token <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;token not found&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> user congnitoClient.UserLogin
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> c.<span style="color:#50fa7b">ShouldBindJSON</span>(<span style="color:#ff79c6">&amp;</span>user); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;invalid json&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    err <span style="color:#ff79c6">:=</span> cognito.<span style="color:#50fa7b">UpdatePassword</span>(<span style="color:#ff79c6">&amp;</span>user)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;could not update password&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Também colocamos a obrigatoriedade de informar o token no header, o resto do função ´o que já fizemos anteriormente.</p>
<p>Vamos criar o último endpoint:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  r.<span style="color:#50fa7b">PATCH</span>(<span style="color:#f1fa8c">&#34;user/password&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(context <span style="color:#ff79c6">*</span>gin.Context) {
</span></span><span style="display:flex;"><span>		err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">UpdatePassword</span>(context, cognitoClient)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> err.<span style="color:#50fa7b">Error</span>() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;token not found&#34;</span> {
</span></span><span style="display:flex;"><span>				context.<span style="color:#50fa7b">JSON</span>(http.StatusUnauthorized, gin.H{<span style="color:#f1fa8c">&#34;error&#34;</span>: <span style="color:#f1fa8c">&#34;token not found&#34;</span>})
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			context.<span style="color:#50fa7b">JSON</span>(http.StatusBadRequest, gin.H{<span style="color:#f1fa8c">&#34;error&#34;</span>: err.<span style="color:#50fa7b">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		context.<span style="color:#50fa7b">JSON</span>(http.StatusOK, gin.H{<span style="color:#f1fa8c">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;password updated&#34;</span>})
</span></span><span style="display:flex;"><span>	})
</span></span></code></pre></div><p>Vamos fazer a chamada:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">PATCH</span> http://localhost:8080/user/password <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>Authorization<span style="color:#ff79c6">:</span> Bearer token_jwt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;wivobi1159@bitofee.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;NovaSenha2@2222&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Pronto, agora ao atualizar a senha e tentar efetuar o login vai receber um erro, e se usar a nova senha, tudo vai funcionar.</p>
<h2 id="considerações-finais">Considerações finais</h2>
<p>Nesse post abordamos um pouco sobre o cognito um dos muitos serviços da aws que muita gente não conhece mas que ajuda muito na evolução do seu sistema.</p>
<p>A praticidade do cognito vai além do que abordei, fazer um login básico é simples, mas o cognito se destaca por já lhe entregar &ldquo;pronto&rdquo; um sistema de verificação de conta, opção login com redes sociais (que pode ser bem chato de implementar sem o coginito), autenticação de dois fatores entre outros, e ainda tem a segurança da aws para proteger os dados do usuário.</p>
<p>O cognito tem mais funcionalidade, vale a pena ver todas na <a href="https://docs.aws.amazon.com/pt_br/cognito/latest/developerguide/what-is-amazon-cognito.html#what-is-amazon-cognito-features">documentação</a>.</p>
<h2 id="link-do-repositório">Link do repositório</h2>
<p><a href="https://github.com/wiliamvj/go-auth-cognito">repositório</a> do projeto</p>
<p>Se inscreva e receba um aviso sobre novos posts, <a href="https://wiliamvj.substack.com/">participar</a></p>
</section>

  

 <div class="giscus-comment">
  <script>
    let theme = localStorage.getItem('theme');
    const giscusTheme = theme === 'light' ? 'noborder_light' : 'noborder_dark';
    let giscusAttributes = {
      id: 'giscus-script',
      src: 'https://giscus.app/client.js',
      'data-repo': 'wiliamvj\/wiliamvj.com',
      'data-repo-id': 'R_kgDOLkkfgA',
      'data-category': 'General',
      'data-category-id': 'DIC_kwDOLkkfgM4CeL5M',
      'data-mapping': 'title',
      'data-strict': '0',
      'data-reactions-enabled':
        '1',
      'data-emit-metadata':
        '0',
      'data-input-position':
        'top',
      'data-theme': theme,
      'data-lang': 'en',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: '',
    };

    let giscusScript = document.createElement('script');
    const article = document.querySelector('article');
    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    article.appendChild(giscusScript);
  </script>
</div>
 


 


  <footer>
    
  </footer>
</article>

</main><footer class="pt-5 pb-6 lg:grid lg:gap-3 lg:grid-cols-2">
  <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2024 —
  <a href="//localhost:1313/">Wiliam V. Joaquim</a>
  <span class="font-normal">with</span>
  <a
    href="https://github.com/nixentric/Lowkey-Hugo-Theme"
    target="_blank"
    rel="noopener noreferrer"
  >
    Lowkey
  </a>
</div>
 <div class="order-1 sm:order-2 f-social">
  <ul class="flex sm:justify-end gap-5">
     
    <li>
      <a href="https://www.linkedin.com/in/wiliamvj/" target="_blank" rel="noopener noreferrer"
        >linkedin</a
      >
    </li>
    
    <li>
      <a href="https://twitter.com/wiliamjoaquim" target="_blank" rel="noopener noreferrer"
        >x</a
      >
    </li>
    
    <li>
      <a href="https://github.com/wiliamvj" target="_blank" rel="noopener noreferrer"
        >github</a
      >
    </li>
    
    <li>
      <a href="https://dev.to/wiliamvj" target="_blank" rel="noopener noreferrer"
        >dev.to</a
      >
    </li>
     
  </ul>
</div>

</footer>

<button
  type="button"
  data-twe-ripple-init
  data-twe-ripple-color="light"
  class="!fixed bottom-5 end-5 hidden rounded-md bg-wpurple p-3 text-xs font-medium uppercase leading-tight text-white shadow-md transition duration-150 ease-in-out hover:bg-wpurplehover hover:shadow-lg focus:bg-wpurplehover focus:shadow-lg focus:outline-none focus:ring-0 active:bg-wpurple active:shadow-lg"
  id="btn-back-to-top"
>
  <span class="[&>svg]:w-4">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="3"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18"
      />
    </svg>
  </span>
</button>

<script defer>
  const mybutton = document.getElementById('btn-back-to-top');
  const scrollFunction = () => {
    if (
      document.body.scrollTop > 20 ||
      document.documentElement.scrollTop > 20
    ) {
      mybutton.classList.remove('hidden');
    } else {
      mybutton.classList.add('hidden');
    }
  };
  const backToTop = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  mybutton.addEventListener('click', backToTop);
  window.addEventListener('scroll', scrollFunction);
</script>
</body>
</html>
