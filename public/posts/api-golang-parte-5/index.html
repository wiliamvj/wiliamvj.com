<!DOCTYPE html>
<html lang="pt" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>    
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>API completa em Golang - Parte 5</title>
<meta
  name="apple-mobile-web-app-title"
  content="API completa em Golang - Parte 5"
/>
<meta
  name="description"
  content="O que vamos fazer? Na parte 5 do nosso crud, vamos fazer a autenticação do usuário, criando um endpoint de login que retorna um JWT, vamos proteger as rotas, impedindo o uso sem token, vamos criar uma função que recebe o token e devolve uma estrutura com os dados salvos no token e ainda vamos adicionar um middleware de logs que adiciona dados do usuário que fez a chamada a nossa api."
/>
<link
  rel="apple-touch-icon"
  sizes="180x180"
  href="/icons/apple-touch.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="32x32"
  href="/icons/favicon-32x32.png"
/>
<link
  rel="icon"
  type="image/png"
  sizes="16x16"
  href="/icons/favicon-16x16.png"
/>
<link rel="canonical" href="//localhost:1313/posts/api-golang-parte-5/" />
<link rel="robots" href="/robots.txt" />
<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />


<script
  defer
  src="https://www.googletagmanager.com/gtag/js?id=G-TG8KZ9PQBT"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-TG8KZ9PQBT');
</script>


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="//localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto">
    <div class="header">
      <header
  class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 sm:py-12"
>
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="//localhost:1313/">
    <img
      srcset="/img/profile-picture_hucbf2afd9e62dc6021c155b0731b41164_625734_80x80_fill_q90_box_smart1.jpg 80w"
      src="/img/profile-picture.jpg"
      width="1080"
      height="1080"
      alt="Wiliam V. Joaquim"
    />
  </a>
</div>


  <div class="flex flex-col gap-5">
    <a href="//localhost:1313/">
  <h1 id="site-title">Wiliam V<span class="text-wpurple">.</span> Joaquim</h1>
</a>
 <nav>
  <ul class="px-4 lg:px-0">
     
    <li>
      <a
        href="/"
        class=""
        
      >
        Artigos
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li>
      <a
        href="https://wiliamvj.substack.com/"
        class=""
         target="_blank" 
      >
        Newsletter
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li>
      <a
        href="/en/"
        class=""
        
      >
        en-US
      </a>
      <span class="text-wpurple text-lg">.</span>
    </li>
    
    <li class="-mt-2 block lg:hidden"><button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme !== 'light') {
      setTheme('dark');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }

  let giscusTheme = localStorage.getItem('giscus-theme');
  let giscusAttributes = {
    src: 'https://giscus.app/client.js',
    'data-repo': 'wiliamvj/wiliamvj.com',
    'data-repo-id': 'R_kgDOKqMPTA',
    'data-category': 'General',
    'data-category-id': 'DIC_kwDOKqMPTM4CbzWf',
    'data-mapping': 'pathname',
    'data-reactions-enabled': '1',
    'data-emit-metadata': '0',
    'data-theme': giscusTheme,
  };

  let giscusScript = document.createElement('script');
  Object.entries(giscusAttributes).forEach(([key, value]) =>
    giscusScript.setAttribute(key, value)
  );
  document.body.appendChild(giscusScript);
</script>
</li>
  </ul>
</nav>

  </div>
</header>

      <div class="lg:inline-block hidden">
        <button
  class="toggle-theme"
  aria-label="Toggle Theme"
  title="Toggle Theme"
  onclick="toggleTheme()"
>
  <span class="theme-icon light hidden dark:block">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>
  </span>
  <span class="theme-icon dark block dark:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>
  </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme !== 'light') {
      setTheme('dark');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }

  let giscusTheme = localStorage.getItem('giscus-theme');
  let giscusAttributes = {
    src: 'https://giscus.app/client.js',
    'data-repo': 'wiliamvj/wiliamvj.com',
    'data-repo-id': 'R_kgDOKqMPTA',
    'data-category': 'General',
    'data-category-id': 'DIC_kwDOKqMPTM4CbzWf',
    'data-mapping': 'pathname',
    'data-reactions-enabled': '1',
    'data-emit-metadata': '0',
    'data-theme': giscusTheme,
  };

  let giscusScript = document.createElement('script');
  Object.entries(giscusAttributes).forEach(([key, value]) =>
    giscusScript.setAttribute(key, value)
  );
  document.body.appendChild(giscusScript);
</script>

      </div>
    </div>

    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-small">API completa em Golang - Parte 5</h2>

    <div class="meta">
      
      <time
        datetime="2024-01-06 19:03:34 -0300 -03"
        title='Sat, Jan 6, 2024, 7:03 PM -03'
      >
        Publicado em: 06/01/2024 - 14 minutos de leitura
      </time>

       
    </div>
  </header>

  

  <section><p><img alt="thumbnail" src="/posts/api-golang-parte-5/uidGhfFHhkn90ndftqcvkFfgFasSd.png"></p>
<h2 id="o-que-vamos-fazer">O que vamos fazer?</h2>
<p>Na parte 5 do nosso crud, vamos fazer a autenticação do usuário, criando um endpoint de login que retorna um JWT, vamos proteger as rotas, impedindo o uso sem token, vamos criar uma função que recebe o token e devolve uma estrutura com os dados salvos no token e ainda vamos adicionar um middleware de logs que adiciona dados do usuário que fez a chamada a nossa api.</p>
<p>Se ainda não viu os posts anteriores leia eles primeiro.</p>
<p><a href="/posts/api-golang-parte-1/">parte 1</a> |
<a href="/posts/api-golang-parte-2/">parte 2</a> |
<a href="/posts/api-golang-parte-3/">parte 3</a> |
<a href="/posts/api-golang-parte-4/">parte 4</a> |</p>
<h2 id="gerando-o-jwt">Gerando o JWT</h2>
<p>Não vou me aprofundar em como o JWT funciona, para não ficar um post muito extenso, mas você pode ler esse <a href="https://dev.to/gabrielhsilvestre/o-basico-jwt-json-web-token-2akc">post</a> e entender melhor.</p>
<p>Para conseguirmos gerar nosso JWT precisamos ajustar algumas coisas, primeiro vamos adicionar nas variáveis de ambiente o segredo do nosso jwt e o tempo de expiração:</p>
<p><code>.env</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#6272a4">## JWT</span>
</span></span><span style="display:flex;"><span>JWT_SECRET=secret
</span></span><span style="display:flex;"><span>JWT_EXPIRES_IN=60000
</span></span></code></pre></div><p>Para teste deixaremos esses valores, mas nunca compartilhe o segredo do seu jwt e utilize uma segredo seguro. <code>JWT_EXPIRES_IN=6000</code> determina o tempo que o nosso token será válido, deixei apenas 1 minuto.</p>
<p>Agora precisamos configurar nosso arquivo do viper que faz a importação das envs <code>env.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> config <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    GoEnv        <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;GO_ENV&#34;`</span>
</span></span><span style="display:flex;"><span>    GoPort       <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;GO_PORT&#34;`</span>
</span></span><span style="display:flex;"><span>    DatabaseURL  <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;DATABASE_URL&#34;`</span>
</span></span><span style="display:flex;"><span>    ViaCepURL    <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;VIA_CEP_URL&#34;`</span>
</span></span><span style="display:flex;"><span>    JwtSecret    <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`mapstructure:&#34;JWT_SECRET&#34;`</span>
</span></span><span style="display:flex;"><span>    JwtExpiresIn <span style="color:#8be9fd">int</span>    <span style="color:#f1fa8c">`mapstructure:&#34;JWT_EXPIRES_IN&#34;`</span>
</span></span><span style="display:flex;"><span>    TokenAuth    <span style="color:#ff79c6">*</span>jwtauth.JWTAuth
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Adicionamos as opções <code>JwtSecret</code>, <code>JwtExpiresIn</code> e o <code>TokenAuth</code> que importamos do pacote <a href="github.com/go-chi/jwtauth">jwtauth</a> do go-chi, o <code>TokenAuth</code> vai ser responsável por lidar com a geração dos tokens.</p>
<p>Depois disto precisamos inicializar o <code>TokenAuth</code>, vamos fazer isso também no arquivo <code>env.go</code> antes do nosso <code>return</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  Env.TokenAuth = jwtauth.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;HS256&#34;</span>, []<span style="color:#8be9fd;font-style:italic">byte</span>(Env.JwtSecret), <span style="color:#ff79c6">nil</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> Env, <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><p>Definimos que o nosso algoritmo de assinatura será o &ldquo;HS256&rdquo; para gerar tokens JWT. O mais utilizado é o <code>HS256</code>, porém existem outros como:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	ES256       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;ES256&#34;</span> <span style="color:#6272a4">// ECDSA using P-256 and SHA-256
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	ES384       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;ES384&#34;</span> <span style="color:#6272a4">// ECDSA using P-384 and SHA-384
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	ES512       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;ES512&#34;</span> <span style="color:#6272a4">// ECDSA using P-521 and SHA-512
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	EdDSA       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;EdDSA&#34;</span> <span style="color:#6272a4">// EdDSA signature algorithms
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	HS256       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;HS256&#34;</span> <span style="color:#6272a4">// HMAC using SHA-256
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	HS384       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;HS384&#34;</span> <span style="color:#6272a4">// HMAC using SHA-384
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	HS512       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;HS512&#34;</span> <span style="color:#6272a4">// HMAC using SHA-512
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	NoSignature SignatureAlgorithm = <span style="color:#f1fa8c">&#34;none&#34;</span>
</span></span><span style="display:flex;"><span>	PS256       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;PS256&#34;</span> <span style="color:#6272a4">// RSASSA-PSS using SHA256 and MGF1-SHA256
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	PS384       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;PS384&#34;</span> <span style="color:#6272a4">// RSASSA-PSS using SHA384 and MGF1-SHA384
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	PS512       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;PS512&#34;</span> <span style="color:#6272a4">// RSASSA-PSS using SHA512 and MGF1-SHA512
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	RS256       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;RS256&#34;</span> <span style="color:#6272a4">// RSASSA-PKCS-v1.5 using SHA-256
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	RS384       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;RS384&#34;</span> <span style="color:#6272a4">// RSASSA-PKCS-v1.5 using SHA-384
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	RS512       SignatureAlgorithm = <span style="color:#f1fa8c">&#34;RS512&#34;</span> <span style="color:#6272a4">// RSASSA-PKCS-v1.5 using SHA-512
</span></span></span></code></pre></div><h3 id="criando-nosso-dto-e-response">Criando nosso dto e response</h3>
<p>Precisamos de um novo dto, dentro do <code>user_dto.go</code> vamos criar um dto chamado <code>LoginDTO</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> LoginDTO <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    Email    <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;email&#34; validate:&#34;required,email&#34;`</span>
</span></span><span style="display:flex;"><span>    Password <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;password&#34; validate:&#34;required,min=8,max=40&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Com algumas validações que já abordamos na <a href="https://wiliamvj.com/posts/api-golang-parte-3/#iniciando-os-dtos">parte 3</a></p>
<p>Também precisamos criar uma response, para retornar o token gerado, para isso dentro do <strong>handler/response</strong> no arquivo <code>user_response.go</code>, vamos criar o <code>UserAuthToken</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserAuthToken <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    AccessToken <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;access_token&#34;`</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><h3 id="criando-nosso-service">Criando nosso service</h3>
<p>Para o nosso service, vamos separar essa parte de autenticação em outro arquivo, para isso crie dentro da pasta <strong>service/userservice</strong> um arquivo chamado <code>auth_service.go</code>.</p>
<p>Primeiro vamos criar nossa interface, vamos chamar de <code>Login</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserService <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">CreateUser</span>(ctx context.Context, u dto.CreateUserDto) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdateUser</span>(ctx context.Context, u dto.UpdateUserDto, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">GetUserByID</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>response.UserResponse, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">DeleteUser</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindManyUsers</span>(ctx context.Context) (<span style="color:#ff79c6">*</span>response.ManyUsersResponse, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdateUserPassword</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>dto.UpdateUserPasswordDto, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">Login</span>(ctx context.Context, u dto.LoginDTO) (<span style="color:#ff79c6">*</span>response.UserAuthToken, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>o <code>Login</code> vai receber nosso contexto, dto e vai devolver um response que acabamos de criar.</p>
<p>Agora vamos implementar, dentro do arquivo recém criado <code>auth_service.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (s <span style="color:#ff79c6">*</span>service) <span style="color:#50fa7b">Login</span>(ctx context.Context, u dto.LoginDTO) (<span style="color:#ff79c6">*</span>response.UserAuthToken, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    user, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">FindUserByEmail</span>(ctx, u.Email)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user by email&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;error to search user password&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> user <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro fazemos as validações básicas, verificando se o usuário com o e-mail informado realmente existe, nossa próxima validação requer criar um novo método no nosso <code>repository</code>, vai ser responsável por buscar apenas a senha do usuário, essa é uma boa prática, devemos evitar retornar a senha do usuário de forma desnecessária, por isso optei em criar um método único para isso.</p>
<p>Vamos criar primeiro a interface:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserRepository <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">CreateUser</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>entity.UserEntity) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindUserByEmail</span>(ctx context.Context, email <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindUserByID</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdateUser</span>(ctx context.Context, u <span style="color:#ff79c6">*</span>entity.UserEntity) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">DeleteUser</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindManyUsers</span>(ctx context.Context) ([]entity.UserEntity, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdatePassword</span>(ctx context.Context, pass, id <span style="color:#8be9fd">string</span>) <span style="color:#8be9fd">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">GetUserPassword</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Agora vamos implementar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">GetUserPassword</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    userMock <span style="color:#ff79c6">:=</span> entity.UserEntity{
</span></span><span style="display:flex;"><span>      ID:       <span style="color:#f1fa8c">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>      Password: <span style="color:#f1fa8c">&#34;$2y$12$CwjjXJGAkR4OKQeTvMo9suJ1s6PdKl9l4RZL9/yg.8cccDE8o/5sm&#34;</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>userMock, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Como nosso <code>repository</code> ainda não está pronto, vamos retornar dados fakes, sem isso não vamos conseguir validar e finalizar o service, por isso criar um hash da senha <code>12345678@</code>.</p>
<p>Vamos retornar um dado face no nosso método <code>FindUserByEmail</code> também:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (r <span style="color:#ff79c6">*</span>repository) <span style="color:#50fa7b">FindUserByEmail</span>(ctx context.Context, email <span style="color:#8be9fd">string</span>) (<span style="color:#ff79c6">*</span>entity.UserEntity, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    userMock <span style="color:#ff79c6">:=</span> entity.UserEntity{
</span></span><span style="display:flex;"><span>      ID:    <span style="color:#f1fa8c">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>      Name:  <span style="color:#f1fa8c">&#34;John&#34;</span>,
</span></span><span style="display:flex;"><span>      Email: <span style="color:#f1fa8c">&#34;john.doe@email.com&#34;</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>userMock, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Esses dados fakes são apenas para conseguir validar da forma correta o nosso service, na parte 6 vamos alterar.</p>
<p>Agora voltando ao service, podemos validar a senha, como o vamos comparar a senha? Uma vez criado o hash da senha se torna impossível reverter (até seria possível, mas não devemos ter poder computacional para tal feito atualmente), para poder comparar a senha vamos pegar a senha que o usuário informar no login, fazer novamente o hash e comparar com o hash que temos salvo no banco de dados, simples assim, o pacote do bcrypt do Go já permite comparar hashes de forma nativa, vamos ver:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  userPass, err <span style="color:#ff79c6">:=</span> s.repo.<span style="color:#50fa7b">GetUserPassword</span>(ctx, user.ID)
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to search user password&#34;</span>, <span style="color:#f1fa8c">&#34;err&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;error to search user password&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// compare password with password in database
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  err = bcrypt.<span style="color:#50fa7b">CompareHashAndPassword</span>([]<span style="color:#8be9fd;font-style:italic">byte</span>(userPass.Password), []<span style="color:#8be9fd;font-style:italic">byte</span>(u.Password))
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>    slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;invalid password&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userservice&#34;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;invalid password&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro buscamos a senha do usuário, depois com o <code>CompareHashAndPassword</code> fazemos a comparação entre <code>userPass.Password</code> (senha do banco) e <code>u.Password</code> (senha informada no login), se não retornar um erro então a senha está correta. Com a senha correta o próximo passo é gerar o token:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  _, token, _ <span style="color:#ff79c6">:=</span> env.Env.TokenAuth.<span style="color:#50fa7b">Encode</span>(<span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}{
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;id&#34;</span>:    user.ID,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;email&#34;</span>: u.Email,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;name&#34;</span>:  user.Name,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;exp&#34;</span>:   time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">Add</span>(time.Second <span style="color:#ff79c6">*</span> time.<span style="color:#50fa7b">Duration</span>(env.Env.JwtExpiresIn)).<span style="color:#50fa7b">Unix</span>(),
</span></span><span style="display:flex;"><span>  })
</span></span></code></pre></div><p>Vamos chamar nosso <code>TokenAuth</code> como a função <code>Encode</code>, e vamos passar os dados que desejamos salver no token, na opção <code>exp</code> é onde definimos a expiração do token, com o valor informamos na nossa variável de ambiente.</p>
<p>Com isso temos o nosso token jwt pronto, basta retornar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  userAuthToken <span style="color:#ff79c6">:=</span> response.UserAuthToken{
</span></span><span style="display:flex;"><span>    AccessToken: token,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>userAuthToken, <span style="color:#ff79c6">nil</span>
</span></span></code></pre></div><h3 id="criando-nosso-handler">Criando nosso handler</h3>
<p>O handler vai ser muito semelhante ao que já fizemos nos outros posts. Vamos separar em outro arquivo assim como o service, para isso vamos criar um arquivo dentro do <strong>handler/userhandler</strong> chamado <code>auth_handler.go</code>:</p>
<p>Vamos primeiro criar a interface:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> UserHandler <span style="color:#8be9fd;font-style:italic">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">CreateUser</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdateUser</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">GetUserByID</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">DeleteUser</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">FindManyUsers</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">UpdateUserPassword</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">Login</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Agora vamos implementar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (h <span style="color:#ff79c6">*</span>handler) <span style="color:#50fa7b">Login</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> r.Body <span style="color:#ff79c6">==</span> http.NoBody {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;body is empty&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userhandler&#34;</span>))
</span></span><span style="display:flex;"><span>      w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusBadRequest)
</span></span><span style="display:flex;"><span>      msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewBadRequestError</span>(<span style="color:#f1fa8c">&#34;body is required&#34;</span>)
</span></span><span style="display:flex;"><span>      json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> req dto.LoginDTO
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> r.Body <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      err <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">NewDecoder</span>(r.Body).<span style="color:#50fa7b">Decode</span>(<span style="color:#ff79c6">&amp;</span>req)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to decode body&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userhandler&#34;</span>))
</span></span><span style="display:flex;"><span>        w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusBadRequest)
</span></span><span style="display:flex;"><span>        msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewBadRequestError</span>(<span style="color:#f1fa8c">&#34;error to decode body&#34;</span>)
</span></span><span style="display:flex;"><span>        json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    httpErr <span style="color:#ff79c6">:=</span> validation.<span style="color:#50fa7b">ValidateHttpData</span>(req)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> httpErr <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;error to validate data: %v&#34;</span>, httpErr), slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userhandler&#34;</span>))
</span></span><span style="display:flex;"><span>      w.<span style="color:#50fa7b">WriteHeader</span>(httpErr.Code)
</span></span><span style="display:flex;"><span>      json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(httpErr)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    token, err <span style="color:#ff79c6">:=</span> h.service.<span style="color:#50fa7b">Login</span>(r.<span style="color:#50fa7b">Context</span>(), req)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> err.<span style="color:#50fa7b">Error</span>() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;user not found&#34;</span> <span style="color:#ff79c6">||</span> err.<span style="color:#50fa7b">Error</span>() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;invalid password&#34;</span> {
</span></span><span style="display:flex;"><span>        w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusUnauthorized)
</span></span><span style="display:flex;"><span>        msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewUnauthorizedRequestError</span>(<span style="color:#f1fa8c">&#34;invalid credentials&#34;</span>)
</span></span><span style="display:flex;"><span>        json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusBadRequest)
</span></span><span style="display:flex;"><span>      msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewBadRequestError</span>(err.<span style="color:#50fa7b">Error</span>())
</span></span><span style="display:flex;"><span>      json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">Header</span>().<span style="color:#50fa7b">Set</span>(<span style="color:#f1fa8c">&#34;Content-Type&#34;</span>, <span style="color:#f1fa8c">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusOK)
</span></span><span style="display:flex;"><span>    json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(token)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Fazemos as mesmas validações das outras rotas, já vimos isso nos outros posts.</p>
<p>Vamos testar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">POST</span> http://localhost:8080/auth/login <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;john.doe@email.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;12345678@&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Recebemos o retorno:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span> <span style="color:#bd93f9">200</span> OK
</span></span><span style="display:flex;"><span>Content-Type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>Date<span style="color:#ff79c6">:</span> Thu, 04 Jan 2024 22:59:26 GMT
</span></span><span style="display:flex;"><span>Content-Length<span style="color:#ff79c6">:</span> 195
</span></span><span style="display:flex;"><span>Connection<span style="color:#ff79c6">:</span> close
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;access_token&#34;</span>: <span style="color:#f1fa8c">&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImpvaG4uZG9lQGVtYWlsLmNvbSIsImV4cCI6MTcwNDQyOTE2NSwiaWQiOiIxIiwibmFtZSI6IkpvaG4ifQ.lTFzOEh7RSVdEoM3WnWvlY4KeQq2G8cDMdluYovOQGs&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Sucesso! Temos nosso token válido, se quiser ver o conteúdo do token, pode usar este <a href="https://jwt.io/">site</a>, veja que contém as informações que colocamos no service:</p>
<p><img alt="jwt io" src="/posts/api-golang-parte-5/fd55fgf4avjs&fh.png"></p>
<h3 id="protegendo-nossas-rotas">Protegendo nossas rotas</h3>
<p>Agora que temos o jwt precisamos proteger nossas rotas, as únicas rotas que podem ser chamadas sem a necessidade de informar um token serão a rota de login e criação de conta, para isso vamos alterar o arquivo responsável por gerenciar nossas rotas o <code>user_route.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">InitUserRoutes</span>(router chi.Router, h userhandler.UserHandler) {
</span></span><span style="display:flex;"><span>    router.<span style="color:#50fa7b">Post</span>(<span style="color:#f1fa8c">&#34;/user&#34;</span>, h.CreateUser)
</span></span><span style="display:flex;"><span>    router.<span style="color:#50fa7b">Route</span>(<span style="color:#f1fa8c">&#34;/user&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(r chi.Router) {
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Use</span>(jwtauth.<span style="color:#50fa7b">Verifier</span>(env.Env.TokenAuth))
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Use</span>(jwtauth.Authenticator)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Patch</span>(<span style="color:#f1fa8c">&#34;/{id}&#34;</span>, h.UpdateUser)
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;/{id}&#34;</span>, h.GetUserByID)
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Delete</span>(<span style="color:#f1fa8c">&#34;/{id}&#34;</span>, h.DeleteUser)
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;/&#34;</span>, h.FindManyUsers)
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Patch</span>(<span style="color:#f1fa8c">&#34;/password/{id}&#34;</span>, h.UpdateUserPassword)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    router.<span style="color:#50fa7b">Route</span>(<span style="color:#f1fa8c">&#34;/auth&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(r chi.Router) {
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Post</span>(<span style="color:#f1fa8c">&#34;/login&#34;</span>, h.Login)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Adicionamos o <code>r.Use(jwtauth.Verifier(env.Env.TokenAuth))</code> do pacote go-chi que vai fazer a validação do token e verificar se é um token válido com o nosso segredo <code>JWT_SECRET</code> e se o token ainda está válido. O <code> r.Use(jwtauth.Authenticator)</code> informa que é preciso informar um token jwt válido.</p>
<p>A nossa rota <code>router.Post(&quot;/user&quot;, h.CreateUser)</code> é uma rota aberta, não precisa informar um token, todas as rotas dentro grupo <code>Route</code> são rotas que necessitam de token.</p>
<p>Agora se testar nossas rotas autenticadas sem informar um token, vamos receber um status code <code>401</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/user <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span></code></pre></div><p>Resposta:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/user <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span></code></pre></div><p>Adicionando um token:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">GET</span> http://localhost:8080/user <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>Authorization<span style="color:#ff79c6">:</span> Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImpvaG4uZG9lQGVtYWlsLmNvbSIsImV4cCI6MTcwNDQyOTE2NSwiaWQiOiIxIiwibmFtZSI6IkpvaG4ifQ.lTFzOEh7RSVdEoM3WnWvlY4KeQq2G8cDMdluYovOQGs
</span></span></code></pre></div><p>Resposta:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span> <span style="color:#bd93f9">200</span> OK
</span></span><span style="display:flex;"><span>Content-Type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>Date<span style="color:#ff79c6">:</span> Thu, 04 Jan 2024 23:16:18 GMT
</span></span><span style="display:flex;"><span>Content-Length<span style="color:#ff79c6">:</span> 15
</span></span><span style="display:flex;"><span>Connection<span style="color:#ff79c6">:</span> close
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;users&#34;</span>: []
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Retorna um <code>user: []</code> pois ainda não implementamos o repository.</p>
<h2 id="capturando-o-token">Capturando o token</h2>
<p>Vamos criar uma função que vai receber um token e retornar uma <code>struct</code> dos dados do token, isso vai facilitar o uso dos dados contidos no token.</p>
<p>Vamos criar uma pasta chamada <strong>common</strong> dentro da <strong>internal</strong> e dentro do <strong>common</strong> outra pasta chamada <strong>utils</strong> e um arquivo chamado <code>decode_jwt.go</code>, vai ficar assim <code>internal/common/utils/decode_jwt.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">type</span> CurrentUser <span style="color:#8be9fd;font-style:italic">struct</span> {
</span></span><span style="display:flex;"><span>    ID        <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>    Email     <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;email&#34;`</span>
</span></span><span style="display:flex;"><span>    Name      sstring <span style="color:#f1fa8c">`json:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>    Exp       <span style="color:#8be9fd">int64</span>  <span style="color:#f1fa8c">`json:&#34;exp,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    jwt.RegisteredClaims
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Primeiro vamos criar uma <code>struct</code> com os dados que vamos capturar no token, esses são os dados que informamos dentro do service quando geramos o token.</p>
<p>O <code>jwt.RegisteredClaims</code> é uma estrutura incorporada no pacote <a href="github.com/golang-jwt/jwt/v4">github.com/golang-jwt/jwt/v4</a> que representa as reivindicações (claims) padrão definidas no nosso jwt, incluem campos como exp (tempo de expiração), iss (emissor), sub (assunto), entre outros.</p>
<p>Ao adicionar o <code>jwt.RegisteredClaims</code> na estrutura <code>CurrentUser</code>, estamos aproveitando esses dados. Isso permite que o pacote jwt interprete automaticamente e manipule essas reivindicações durante a validação e a análise do token jwt.</p>
<p>Vamos ler o token e transformar na <code>struct</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">DecodeJwt</span>(r <span style="color:#ff79c6">*</span>http.Request) (<span style="color:#ff79c6">*</span>CurrentUser, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>    authHeader <span style="color:#ff79c6">:=</span> r.Header.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;Authorization&#34;</span>)
</span></span><span style="display:flex;"><span>    parts <span style="color:#ff79c6">:=</span> strings.<span style="color:#50fa7b">Split</span>(authHeader, <span style="color:#f1fa8c">&#34; &#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(parts) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">||</span> parts[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;Bearer&#34;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, errors.<span style="color:#50fa7b">New</span>(<span style="color:#f1fa8c">&#34;invalid authorization header&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tokenString <span style="color:#ff79c6">:=</span> parts[<span style="color:#bd93f9">1</span>]
</span></span><span style="display:flex;"><span>    key <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>env.Env.JwtSecret
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">var</span> userClaim CurrentUser
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    _, err <span style="color:#ff79c6">:=</span> jwt.<span style="color:#50fa7b">ParseWithClaims</span>(tokenString, <span style="color:#ff79c6">&amp;</span>userClaim, <span style="color:#8be9fd;font-style:italic">func</span>(token <span style="color:#ff79c6">*</span>jwt.Token) (<span style="color:#8be9fd;font-style:italic">interface</span>{}, <span style="color:#8be9fd">error</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> []<span style="color:#8be9fd;font-style:italic">byte</span>(<span style="color:#ff79c6">*</span>key), <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">nil</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>userClaim, <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Com isso temos nossa função pronta, mas onde usar? Vamos aplicar um exemplo, na rota que busca os dados do usuário pelo id, ao usar essa função não precisamos mais que seja informado um id, como essa rota é protegida por um token jwt e nosso token contém o id do usuário, podemos aproveitar dessa informação, vamos refatorar nosso <code>user_handler.go</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> (h <span style="color:#ff79c6">*</span>handler) <span style="color:#50fa7b">GetUserByID</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
</span></span><span style="display:flex;"><span>    user, err <span style="color:#ff79c6">:=</span> utils.<span style="color:#50fa7b">DecodeJwt</span>(r)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error to decode jwt&#34;</span>, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userhandler&#34;</span>))
</span></span><span style="display:flex;"><span>      w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusBadRequest)
</span></span><span style="display:flex;"><span>      msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewBadRequestError</span>(<span style="color:#f1fa8c">&#34;error to decode jwt&#34;</span>)
</span></span><span style="display:flex;"><span>      json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    res, err <span style="color:#ff79c6">:=</span> h.service.<span style="color:#50fa7b">GetUserByID</span>(r.<span style="color:#50fa7b">Context</span>(), user.ID)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Error</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;error to get user: %v&#34;</span>, err), slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;package&#34;</span>, <span style="color:#f1fa8c">&#34;userhandler&#34;</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> err.<span style="color:#50fa7b">Error</span>() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;user not found&#34;</span> {
</span></span><span style="display:flex;"><span>        w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusNotFound)
</span></span><span style="display:flex;"><span>        msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewNotFoundError</span>(<span style="color:#f1fa8c">&#34;user not found&#34;</span>)
</span></span><span style="display:flex;"><span>        json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusInternalServerError)
</span></span><span style="display:flex;"><span>      msg <span style="color:#ff79c6">:=</span> httperr.<span style="color:#50fa7b">NewBadRequestError</span>(<span style="color:#f1fa8c">&#34;error to get user&#34;</span>)
</span></span><span style="display:flex;"><span>      json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(msg)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">Header</span>().<span style="color:#50fa7b">Set</span>(<span style="color:#f1fa8c">&#34;Content-Type&#34;</span>, <span style="color:#f1fa8c">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>    w.<span style="color:#50fa7b">WriteHeader</span>(http.StatusOK)
</span></span><span style="display:flex;"><span>    json.<span style="color:#50fa7b">NewEncoder</span>(w).<span style="color:#50fa7b">Encode</span>(res)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Agora podemos chamar a função <code>DecodeJwt</code> e pegar o id do usuário, sem a necessidade do cliente informar o id. Podemos fazer isso para todos os enpoints que sejam autenticados e precise passar o id do usuário, no nosso caso são eles: <code>GetUserByID</code>, <code>DeleteUser</code>, <code>UpdateUserPassword</code> e <code>UpdateUser</code>.</p>
<p>Precisamos atualizar a documentação, removendo o <code>{id}</code> da url:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#6272a4">// User details
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Summary		User details
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Description	Get user by id
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Tags			user
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Security		ApiKeyAuth
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Accept			json
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Produce		json
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Param			id	path		string	true	&#34;user id&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Success		200	{object}	response.UserResponse
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Failure		400	{object}	httperr.RestErr
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Failure		404	{object}	httperr.RestErr
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Failure		500	{object}	httperr.RestErr
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">//	@Router			/user [get]
</span></span></span></code></pre></div><p>Rode o comando abaixo para atualizar o arquivo do swaggo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  swag init -g internal/handler/routes/docs_route.go
</span></span></code></pre></div><h2 id="criando-um-middleware">Criando um middleware</h2>
<p>Por último, vamos criar um middleware que vai capturar os dados dos usuários que solicitarem a requisição a nossa api.</p>
<p>Vamos criar um pasta chamada <strong>middleware</strong> dentro de <strong>handler</strong> e um arquivo chamado <code>logger_middleware.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">LoggerData</span>(next http.Handler) http.Handler {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> http.<span style="color:#50fa7b">HandlerFunc</span>(<span style="color:#8be9fd;font-style:italic">func</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">var</span> requestData <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> r.Body <span style="color:#ff79c6">!=</span> http.NoBody {
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// copy body
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        CopyBody, _ <span style="color:#ff79c6">:=</span> io.<span style="color:#50fa7b">ReadAll</span>(r.Body)
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// restore body
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        r.Body = io.<span style="color:#50fa7b">NopCloser</span>(bytes.<span style="color:#50fa7b">NewBuffer</span>(CopyBody))
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">Unmarshal</span>(CopyBody, <span style="color:#ff79c6">&amp;</span>requestData); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>          slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error unmarshalling request data&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;func&#34;</span>, <span style="color:#f1fa8c">&#34;LoggerData&#34;</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>        r.Body = http.NoBody
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// get user in token
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#8be9fd;font-style:italic">var</span> userID <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">var</span> userEmail <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>      user, err <span style="color:#ff79c6">:=</span> utils.<span style="color:#50fa7b">DecodeJwt</span>(r)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>        userID = <span style="color:#f1fa8c">&#34;no token&#34;</span>
</span></span><span style="display:flex;"><span>        userEmail = <span style="color:#f1fa8c">&#34;no token&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>        userID = user.ID
</span></span><span style="display:flex;"><span>        userEmail = user.Email
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;request_data&#34;</span>,
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;url&#34;</span>, r.URL.Path),
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;method&#34;</span>, r.Method),
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;query&#34;</span>, r.URL.<span style="color:#50fa7b">Query</span>()),
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;body&#34;</span>, requestData),
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;id&#34;</span>, userID),
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;email&#34;</span>, userEmail),
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      next.<span style="color:#50fa7b">ServeHTTP</span>(w, r)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Esse middleware vai receber a requisição que foi chamada pelo cliente, lembrando que um middleware é iniciando logo após uma requisição ser iniciado, no nosso caso vai ser executado antes mesmo de chamar o nosso handler.</p>
<p>Vou explicar por etapas:</p>
<p>1 - Verificamos se o <code>body</code> não é vazio, com isso fazemos uma cópia para o <code>requestData</code>, como o body é um stream e só pode ser lido uma vez, sem a cópia nosso handler não conseguiria ler o body.
2 - Chamamos o nosso decode de jwt que criamos anteriormente <code>DecodeJwt</code>.
3 - Colocamos as informações que precisamos no log.</p>
<p>Agora nas rotas <code>user_route.go</code>, vamos usar o log de forma global:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">InitUserRoutes</span>(router chi.Router, h userhandler.UserHandler) {
</span></span><span style="display:flex;"><span>    router.<span style="color:#50fa7b">Use</span>(middleware.LoggerData)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    router.<span style="color:#50fa7b">Post</span>(<span style="color:#f1fa8c">&#34;/user&#34;</span>, h.CreateUser)
</span></span><span style="display:flex;"><span>    router.<span style="color:#50fa7b">Route</span>(<span style="color:#f1fa8c">&#34;/user&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(r chi.Router) {
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Use</span>(jwtauth.<span style="color:#50fa7b">Verifier</span>(env.Env.TokenAuth))
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Use</span>(jwtauth.Authenticator)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Patch</span>(<span style="color:#f1fa8c">&#34;/&#34;</span>, h.UpdateUser)
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;/&#34;</span>, h.GetUserByID)
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Delete</span>(<span style="color:#f1fa8c">&#34;/&#34;</span>, h.DeleteUser)
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Get</span>(<span style="color:#f1fa8c">&#34;/list-all&#34;</span>, h.FindManyUsers)
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Patch</span>(<span style="color:#f1fa8c">&#34;/password&#34;</span>, h.UpdateUserPassword)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    router.<span style="color:#50fa7b">Route</span>(<span style="color:#f1fa8c">&#34;/auth&#34;</span>, <span style="color:#8be9fd;font-style:italic">func</span>(r chi.Router) {
</span></span><span style="display:flex;"><span>      r.<span style="color:#50fa7b">Post</span>(<span style="color:#f1fa8c">&#34;/login&#34;</span>, h.Login)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Adicionamos o <code>router.Use(middleware.LoggerData)</code>.</p>
<p>Precisamos remover da url o id <code>{id}</code> e na rota de listar todos os usuários adicione o <code>/list-all</code> para não gerar conflitos entre a rota de listar detalhes de um único usuário.</p>
<p>Veja como ficou, vamos fazer o login na nossa aplicacão:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#50fa7b">POST</span> http://localhost:8080/auth/login <span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span>
</span></span><span style="display:flex;"><span>content-type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;john.doe@email.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;12345678@&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Nosso log:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;time&#34;</span>: <span style="color:#f1fa8c">&#34;2024-01-04T20:48:04.47413-03:00&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;level&#34;</span>: <span style="color:#f1fa8c">&#34;INFO&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;msg&#34;</span>: <span style="color:#f1fa8c">&#34;request_data&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;url&#34;</span>: <span style="color:#f1fa8c">&#34;/auth/login&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;method&#34;</span>: <span style="color:#f1fa8c">&#34;POST&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;query&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;body&#34;</span>: { <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;john.doe@email.com&#34;</span>, <span style="color:#ff79c6">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;12345678@&#34;</span> },
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;user_id&#34;</span>: <span style="color:#f1fa8c">&#34;no token&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;user_email&#34;</span>: <span style="color:#f1fa8c">&#34;no token&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Repare que temos a senha exposta, precisamos remover dados sensíveis do log, para isso vamos criar uma função que retorna um booleano caso encontre a palavra que desejamos ocultar:</p>
<p><code>logger_middleware.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">var</span> sensitiveKeywords = []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;password&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">hasSensitiveData</span>(body <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}) <span style="color:#8be9fd">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> key <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> body {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">for</span> _, keyword <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> sensitiveKeywords {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(strings.<span style="color:#50fa7b">ToLower</span>(key), keyword) <span style="color:#ff79c6">||</span> strings.<span style="color:#50fa7b">Contains</span>(strings.<span style="color:#50fa7b">ToLower</span>(body[key].(<span style="color:#8be9fd">string</span>)), keyword) {
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Vamos ter um slice que oculta a palavra caso encontre no body:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">LoggerData</span>(next http.Handler) http.Handler {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> http.<span style="color:#50fa7b">HandlerFunc</span>(<span style="color:#8be9fd;font-style:italic">func</span>(w http.ResponseWriter, r <span style="color:#ff79c6">*</span>http.Request) {
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">var</span> requestData <span style="color:#8be9fd;font-style:italic">map</span>[<span style="color:#8be9fd">string</span>]<span style="color:#8be9fd;font-style:italic">interface</span>{}
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> r.Body <span style="color:#ff79c6">!=</span> http.NoBody {
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// copy body
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        CopyBody, _ <span style="color:#ff79c6">:=</span> io.<span style="color:#50fa7b">ReadAll</span>(r.Body)
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// restore body
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        r.Body = io.<span style="color:#50fa7b">NopCloser</span>(bytes.<span style="color:#50fa7b">NewBuffer</span>(CopyBody))
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">:=</span> json.<span style="color:#50fa7b">Unmarshal</span>(CopyBody, <span style="color:#ff79c6">&amp;</span>requestData); err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>          slog.<span style="color:#50fa7b">Error</span>(<span style="color:#f1fa8c">&#34;error unmarshalling request data&#34;</span>, err, slog.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;func&#34;</span>, <span style="color:#f1fa8c">&#34;LoggerData&#34;</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#50fa7b">hasSensitiveData</span>(requestData) {
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">for</span> key <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> requestData {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> _, keyword <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> sensitiveKeywords {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(strings.<span style="color:#50fa7b">ToLower</span>(key), keyword) <span style="color:#ff79c6">||</span> strings.<span style="color:#50fa7b">Contains</span>(strings.<span style="color:#50fa7b">ToLower</span>(requestData[key].(<span style="color:#8be9fd">string</span>)), keyword) {
</span></span><span style="display:flex;"><span>                requestData[key] = <span style="color:#f1fa8c">&#34;[REDACTED]&#34;</span>
</span></span><span style="display:flex;"><span>              }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>        r.Body = http.NoBody
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// get user in token
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#8be9fd;font-style:italic">var</span> userID <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">var</span> userEmail <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span>      user, err <span style="color:#ff79c6">:=</span> utils.<span style="color:#50fa7b">DecodeJwt</span>(r)
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>        userID = <span style="color:#f1fa8c">&#34;no token&#34;</span>
</span></span><span style="display:flex;"><span>        userEmail = <span style="color:#f1fa8c">&#34;no token&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>        userID = user.ID
</span></span><span style="display:flex;"><span>        userEmail = user.Email
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      slog.<span style="color:#50fa7b">Info</span>(<span style="color:#f1fa8c">&#34;request_data&#34;</span>,
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;url&#34;</span>, r.URL.Path),
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;method&#34;</span>, r.Method),
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;query&#34;</span>, r.URL.<span style="color:#50fa7b">Query</span>()),
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;body&#34;</span>, requestData),
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;id&#34;</span>, userID),
</span></span><span style="display:flex;"><span>        slog.<span style="color:#50fa7b">Any</span>(<span style="color:#f1fa8c">&#34;email&#34;</span>, userEmail),
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      next.<span style="color:#50fa7b">ServeHTTP</span>(w, r)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Caso encontre colocamos <code>&quot;[REDACTED]&quot;</code>, veja agora o log:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;time&#34;</span>: <span style="color:#f1fa8c">&#34;2024-01-04T21:11:44.850656-03:00&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;level&#34;</span>: <span style="color:#f1fa8c">&#34;INFO&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;msg&#34;</span>: <span style="color:#f1fa8c">&#34;request_data&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;url&#34;</span>: <span style="color:#f1fa8c">&#34;/auth/login&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;method&#34;</span>: <span style="color:#f1fa8c">&#34;POST&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;query&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;body&#34;</span>: { <span style="color:#ff79c6">&#34;email&#34;</span>: <span style="color:#f1fa8c">&#34;john.doe@email.com&#34;</span>, <span style="color:#ff79c6">&#34;password&#34;</span>: <span style="color:#f1fa8c">&#34;[REDACTED]&#34;</span> },
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;user_id&#34;</span>: <span style="color:#f1fa8c">&#34;no token&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;user_email&#34;</span>: <span style="color:#f1fa8c">&#34;no token&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Vamos ver o log em uma rota autenticada:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#ff79c6">HTTP</span><span style="color:#ff79c6">/</span><span style="color:#bd93f9">1.1</span> <span style="color:#bd93f9">200</span> OK
</span></span><span style="display:flex;"><span>Content-Type<span style="color:#ff79c6">:</span> application/json
</span></span><span style="display:flex;"><span>Date<span style="color:#ff79c6">:</span> Fri, 05 Jan 2024 00:12:22 GMT
</span></span><span style="display:flex;"><span>Content-Length<span style="color:#ff79c6">:</span> 15
</span></span><span style="display:flex;"><span>Connection<span style="color:#ff79c6">:</span> close
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;users&#34;</span>: []
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>log:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;time&#34;</span>: <span style="color:#f1fa8c">&#34;2024-01-04T21:14:30.90976-03:00&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;level&#34;</span>: <span style="color:#f1fa8c">&#34;INFO&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;msg&#34;</span>: <span style="color:#f1fa8c">&#34;request_data&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;url&#34;</span>: <span style="color:#f1fa8c">&#34;/user/list-all&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;method&#34;</span>: <span style="color:#f1fa8c">&#34;GET&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;query&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;body&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;user_id&#34;</span>: <span style="color:#f1fa8c">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;user_email&#34;</span>: <span style="color:#f1fa8c">&#34;john.doe@email.com&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Esse middleware serve apenas para abordar sobre o uso de middlewares, seria necessário melhorar essas validações se forem utilizados logs dessa maneira. Para exibir dados de uma forma mais concisa, o log deveria estar dentro do handler, assim conseguimos controlar melhor os dados do body, uma vez que transformamos em struct e sabemos seu tipo, um middleware global fica um pouco complicado saber o valor do body, por isso criamos a função <code>hasSensitiveData</code> para auxiliar nessa tarefa.</p>
<h2 id="considerações-finais">Considerações finais</h2>
<p>Nesse post conseguimos finalizar a autenticação da nossa api, essa foi uma abordagem simples, existem outras estratégias mais avançadas que poderíamos utilizar como a utilização de refresh tokens, mas isso fica para um próximos posta</p>
<p>Se inscreva e receba um aviso quando sair novos posts, <a href="https://wiliamvj.substack.com/">se inscrever</a></p>
<h2 id="próximos-passos">Próximos passos</h2>
<p>Na parte 6 vamos iniciar nosso repository e persistir os dados no nosso banco de dados.</p>
<h2 id="link-do-repositório">Link do repositório</h2>
<p><a href="https://github.com/wiliamvj/api-users-golang">repositório</a> do projeto</p>
<p><a href="https://github.com/egonelbre/gophers">Gopher credits</a></p>
</section>

  
    
  
    <div class="giscus-comment">
    <script
      src="https://giscus.app/client.js"
      data-repo="wiliamvj/wiliamvj.com"
      data-repo-id="R_kgDOKqMPTA"
      data-category="General"
      data-category-id="DIC_kwDOKqMPTM4CbzWf"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="en"
      
        data-loading="lazy"
      
      crossorigin="anonymous"
      async
    >
    </script>
</div>
  

    
  


  <footer>
    
  </footer>
</article>

</main><footer class="pt-5 pb-6 lg:grid lg:gap-3 lg:grid-cols-2">
  <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2024 —
  <a href="//localhost:1313/">Wiliam V. Joaquim</a>
  <span class="font-normal">with</span>
  <a
    href="https://github.com/nixentric/Lowkey-Hugo-Theme"
    target="_blank"
    rel="noopener noreferrer"
  >
    Lowkey
  </a>
</div>
 <div class="order-1 sm:order-2 f-social">
  <ul class="flex sm:justify-end gap-5">
     
    <li>
      <a href="https://www.linkedin.com/in/wiliamvj/" target="_blank" rel="noopener noreferrer"
        >linkedin</a
      >
    </li>
    
    <li>
      <a href="https://twitter.com/wiliamjoaquim" target="_blank" rel="noopener noreferrer"
        >x</a
      >
    </li>
    
    <li>
      <a href="https://github.com/wiliamvj" target="_blank" rel="noopener noreferrer"
        >github</a
      >
    </li>
    
    <li>
      <a href="https://dev.to/wiliamvj" target="_blank" rel="noopener noreferrer"
        >dev.to</a
      >
    </li>
     
  </ul>
</div>

</footer>

<button
  type="button"
  data-twe-ripple-init
  data-twe-ripple-color="light"
  class="!fixed bottom-5 end-5 hidden rounded-md bg-wpurple p-3 text-xs font-medium uppercase leading-tight text-white shadow-md transition duration-150 ease-in-out hover:bg-wpurplehover hover:shadow-lg focus:bg-wpurplehover focus:shadow-lg focus:outline-none focus:ring-0 active:bg-wpurple active:shadow-lg"
  id="btn-back-to-top"
>
  <span class="[&>svg]:w-4">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="3"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18"
      />
    </svg>
  </span>
</button>

<script defer>
  const mybutton = document.getElementById('btn-back-to-top');
  const scrollFunction = () => {
    if (
      document.body.scrollTop > 20 ||
      document.documentElement.scrollTop > 20
    ) {
      mybutton.classList.remove('hidden');
    } else {
      mybutton.classList.add('hidden');
    }
  };
  const backToTop = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  mybutton.addEventListener('click', backToTop);
  window.addEventListener('scroll', scrollFunction);
</script>
</body>
</html>
